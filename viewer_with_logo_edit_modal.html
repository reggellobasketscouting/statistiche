<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Partite (Viewer)</title>
  <style>
    :root{
      --bg:#0b0b0f; --card:#141421; --muted:#a7a7b5; --txt:#f3f3f6;
      --line:rgba(255,255,255,.12); --btn:#2a2a3f;
      --ok:#0f5f2a; --bad:#7a1f1f;
    }
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .pill{padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.05);color:var(--muted);font-weight:700;font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input{background:#0f0f18;color:var(--txt);border:1px solid var(--line);border-radius:12px;padding:10px 12px;outline:none}
    input::placeholder{color:#7c7c90}
    .btn{background:var(--btn);border:1px solid var(--line);color:var(--txt);border-radius:14px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn:hover{filter:brightness(1.08)}
    .btn.ok{background:var(--ok)}
    .btn.bad{background:var(--bad)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:12px}
    .card{grid-column:span 12;background:var(--card);border:1px solid var(--line);border-radius:18px;padding:12px}
    @media(min-width:780px){ .card{grid-column:span 6} }
    .title{font-weight:1000;font-size:16px;margin:0 0 6px 0}
    .meta{color:var(--muted);font-size:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .a{flex:1;min-width:160px;text-align:center;text-decoration:none}
    .a .btn{width:100%}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .hide{display:none !important}
    .adminBox{background:rgba(255,255,255,.04);border:1px solid var(--line);border-radius:18px;padding:12px;margin-top:12px}
    .two{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:780px){ .two{grid-template-columns:1fr 1fr} }
    .small{font-size:12px;color:var(--muted);line-height:1.3}
    .dangerLink{color:#ffb4b4;text-decoration:none}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:12px;z-index:9999}
    .modal.show{display:flex}
    .modalCard{width:min(980px,100%);max-height:90vh;overflow:auto;background:var(--card);border:1px solid var(--line);border-radius:18px;padding:12px}
    .modalTop{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .modalTitle{font-weight:1000}
    .frameWrap{margin-top:10px;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#000}
    .frameWrap iframe{width:100%;height:70vh;border:0}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btnRow .btn{flex:1;min-width:160px}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <div class="row" style="gap:10px;align-items:center">
        <img src="logo.png" alt="Logo" style="width:46px;height:46px;border-radius:50%;object-fit:contain;background:rgba(255,255,255,.06);border:1px solid var(--line);padding:6px"/>
        <div>
          <div style="font-weight:1000;letter-spacing:.3px">Basket Reggello</div>
          <div class="small" style="margin-top:2px">Viewer partite • Statistiche & YouTube</div>
        </div>
      </div>
    </div>

    <div class="top">
      <div class="row">
        <h1>Partite</h1>
        <span class="pill" id="statusPill">offline</span>
      </div>
      <div class="row">
        <input id="q" placeholder="Cerca (titolo / note)"/>
        <button class="btn" id="btnLoginToggle" type="button">Login</button>
        <button class="btn hide" id="btnLogout" type="button">Logout</button>
      </div>
    </div>

    <div class="adminBox hide" id="loginBox">
      <div class="two">
        <div>
          <div class="pill" style="display:inline-block;margin-bottom:8px">Login admin</div>
          <div class="row" style="margin-bottom:10px">
            <input id="email" placeholder="email" style="flex:1;min-width:220px">
            <input id="pass" placeholder="password" type="password" style="flex:1;min-width:220px">
          </div>
          <div class="row">
            <button class="btn ok" id="btnLogin" type="button">Entra</button>
            <span class="small">Solo l'admin può aggiungere/eliminare partite.</span>
          </div>
        </div>
        <div>
          <div class="pill" style="display:inline-block;margin-bottom:8px">Info</div>
          <div class="small" id="infoBox">Caricamento Firebase…</div>
        </div>
      </div>
    </div>

    <div class="adminBox hide" id="adminBox">
      <div class="pill" style="display:inline-block;margin-bottom:10px">Aggiungi partita</div>
      <div class="two">
        <input id="title" placeholder="Titolo (es. Ritorno REGG CMB - BM)">
        <input id="date" placeholder="Data (YYYY-MM-DD)">
      </div>
      <div class="two" style="margin-top:10px">
        <input id="statsUrl" placeholder="Link Statistiche (es. https://.../statistiche/?view=1&game=...)">
        <input id="youtubeUrl" placeholder="Link YouTube (watch o live) (opzionale)">
      </div>
      <div class="two" style="margin-top:10px">
        <input id="notes" placeholder="Note (opzionale)">
        <button class="btn ok" id="btnAdd" type="button">SALVA</button>
      </div>
      <div class="small" style="margin-top:10px">
        Suggerimento: per YouTube puoi incollare <b>watch?v=...</b> o <b>youtube.com/live/ID</b>.
      </div>
    </div>

    <div class="grid" id="list"></div>

    <div class="hr"></div>
    <div class="small">
      Se vuoi che la viewer sia installabile come app (PWA), dimmelo e ti preparo manifest + service worker.
    </div>
  </div>

  <!-- Firebase compat (più stabile su GitHub Pages/mobile rispetto ai moduli) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    const $ = (id)=>document.getElementById(id);

    // ✅ UI handlers FIRST: così il tasto Login funziona anche se Firebase ha errori
    $("btnLoginToggle").addEventListener("click", ()=>{
      $("loginBox").classList.toggle("hide");
    });

    $("q").addEventListener("input", ()=>render());

    const state = { user:null, games:[], isAdmin:false, firebaseReady:false };

    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
    }
    function fmtDate(iso){
      if(!iso) return "";
      const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(!m) return iso;
      return `${m[3]}/${m[2]}/${m[1]}`;
    }
    function ytParse(url){
      if(!url) return {embed:"", ok:false};
      try{
        const u = new URL(url);
        if(u.hostname.includes("youtube.com") && u.pathname === "/watch" && u.searchParams.get("v")){
          const id = u.searchParams.get("v");
          return {embed:`https://www.youtube.com/embed/${id}`, ok:true};
        }
        if(u.hostname === "youtu.be"){
          const id = u.pathname.replace("/","");
          if(id) return {embed:`https://www.youtube.com/embed/${id}`, ok:true};
        }
        if(u.hostname.includes("youtube.com") && u.pathname.startsWith("/live/")){
          const id = u.pathname.split("/")[2];
          if(id) return {embed:`https://www.youtube.com/embed/${id}`, ok:true};
        }
        if(u.hostname.includes("youtube.com") && u.pathname.startsWith("/shorts/")){
          const id = u.pathname.split("/")[2];
          if(id) return {embed:`https://www.youtube.com/embed/${id}`, ok:true};
        }
        if(u.hostname.includes("youtube.com") && u.pathname.includes("/embed/")){
          return {embed:url, ok:true};
        }
        return {embed:"", ok:false};
      }catch(e){ return {embed:"", ok:false}; }
    }

    function setUI(){
      $("btnLogout").classList.toggle("hide", !state.user);
      $("adminBox").classList.toggle("hide", !state.isAdmin);
      $("btnLoginToggle").textContent = state.user ? "Account" : "Login";
      $("statusPill").textContent = !state.firebaseReady ? "offline" : (state.isAdmin ? "admin" : "online");
      render();
    }

    function render(){
      const list = $("list");
      const q = ($("q").value || "").trim().toLowerCase();
      const items = state.games.filter(g=>{
        const hay = `${g.title||""} ${g.notes||""}`.toLowerCase();
        return !q || hay.includes(q);
      });

      list.innerHTML = items.map(g=>{
        const y = g.youtubeUrl ? escapeHtml(g.youtubeUrl) : "";
        const yInfo = g.youtubeUrl ? ytParse(g.youtubeUrl) : {embed:"", ok:false};
        const yEmbed = yInfo.ok ? escapeHtml(yInfo.embed) : "";
        const stats = escapeHtml(g.statsUrl||"");
        const canDel = state.isAdmin ? `<a class="dangerLink" href="#" data-del="${g.id}">Elimina</a>` : "";
        return `
          <div class="card">
            <div class="title">${escapeHtml(g.title||"Partita")}</div>
            <div class="meta">${fmtDate(g.date)} ${g.notes ? " • " + escapeHtml(g.notes) : ""}</div>
            <div class="actions">
              <button class="btn ok" type="button" data-open-stats="${stats}" style="flex:1;min-width:160px">STATISTICHE</button>
              ${g.youtubeUrl ? `<a class="a" href="${y}" target="_blank" rel="noopener"><button class="btn" type="button">YOUTUBE</button></a>` : ""}
              ${state.isAdmin ? `<button class="btn a" type="button" data-edit="${g.id}" style="flex:1;min-width:160px">MODIFICA</button>` : ""}
            </div>
            ${(g.youtubeUrl && yInfo.ok) ? `<div style="margin-top:10px;border-radius:14px;overflow:hidden;border:1px solid var(--line)">
              <iframe width="100%" height="220" src="${yEmbed}" title="YouTube" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen></iframe>
            </div>` : ""}
            ${(g.youtubeUrl && !yInfo.ok) ? `<div class="small" style="margin-top:10px">Anteprima non disponibile per questo link. Usa il tasto YOUTUBE.</div>` : ``}
            ${canDel ? `<div class="hr"></div><div class="small">${canDel}</div>` : ""}
          </div>
        `;
      }).join("");

      if(state.isAdmin){
        list.querySelectorAll("[data-del]").forEach(a=>{
          a.addEventListener("click", async (e)=>{
            e.preventDefault();
            const id = a.getAttribute("data-del");
            if(!id) return;
            if(!confirm("Eliminare questa partita?")) return;
            await db.collection("games").doc(id).delete();
          });
        });
      }
    }

    // ===== Firebase init (in try/catch) =====
    let auth=null, db=null;
    // >>> INCOLLA QUI LA TUA CONFIG FIREBASE
    const firebaseConfig = {
      apiKey: "REPLACE_ME",
      authDomain: "REPLACE_ME",
      projectId: "REPLACE_ME",
      storageBucket: "REPLACE_ME",
      messagingSenderId: "REPLACE_ME",
      appId: "REPLACE_ME"
    };

    const ADMIN_UIDS = new Set(["REPLACE_WITH_YOUR_ADMIN_UID"]);

    function configLooksMissing(cfg){
      const s = JSON.stringify(cfg||{});
      return s.includes("REPLACE_ME") || s.includes("REPLACE_WITH_YOUR_ADMIN_UID");
    }

    try{
      if(configLooksMissing(firebaseConfig)){
        $("infoBox").textContent = "Config Firebase mancante: apri viewer_fixed_login2.html e sostituisci REPLACE_ME con la tua firebaseConfig.";
        $("statusPill").textContent = "config mancante";
      }else{
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        state.firebaseReady = true;
        $("infoBox").textContent = "Firebase ok.";
        $("statusPill").textContent = "online";
      }
    }catch(err){
      console.error(err);
      $("infoBox").textContent = "Errore Firebase: apri la Console (F12) o controlla firebaseConfig.";
      $("statusPill").textContent = "errore";
    }

    if(state.firebaseReady){
      // Realtime list
      db.collection("games").orderBy("date", "desc").onSnapshot((snap)=>{
        state.games = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        render();
      }, (err)=>{
        console.error(err);
        $("statusPill").textContent = "errore DB";
      });

      // Auth
      auth.onAuthStateChanged((user)=>{
        state.user = user || null;
        state.isAdmin = !!(user && ADMIN_UIDS.has(user.uid));
        setUI();
      });

      $("btnLogin").addEventListener("click", async ()=>{
        const email = $("email").value.trim();
        const pass = $("pass").value;
        if(!email || !pass) return alert("Inserisci email e password");
        try{
          await auth.signInWithEmailAndPassword(email, pass);
        }catch(e){
          console.error(e);
          alert("Login fallito");
        }
      });

      $("btnLogout").addEventListener("click", async ()=>{
        await auth.signOut();
      });

      $("btnAdd").addEventListener("click", async ()=>{
        if(!state.isAdmin) return alert("Solo admin");
        const title = $("title").value.trim();
        const date = $("date").value.trim();
        const statsUrl = $("statsUrl").value.trim();
        const youtubeUrl = $("youtubeUrl").value.trim();
        const notes = $("notes").value.trim();

        if(!title || !date || !statsUrl) return alert("Compila: Titolo, Data, Link Statistiche");
        if(!/^\d{4}-\d{2}-\d{2}$/.test(date)) return alert("Data nel formato YYYY-MM-DD");

        await db.collection("games").add({
          title, date, statsUrl,
          youtubeUrl: youtubeUrl || "",
          notes: notes || "",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        $("title").value=""; $("date").value=""; $("statsUrl").value=""; $("youtubeUrl").value=""; $("notes").value="";
      });
    }

    
    // ===== Modal Statistiche (iframe + fallback) =====
    function openStatsModal(url, title){
      const m = $("statsModal");
      $("statsModalTitle").textContent = title || "Statistiche";
      $("statsOpenExternal").href = url || "#";
      $("statsFrame").src = url || "about:blank";
      m.classList.add("show");
    }
    function closeStatsModal(){
      $("statsModal").classList.remove("show");
      $("statsFrame").src = "about:blank";
    }
    $("btnCloseStats").addEventListener("click", closeStatsModal);
    $("btnReloadStats").addEventListener("click", ()=>{
      const u = $("statsOpenExternal").href;
      if(u && u !== "#") $("statsFrame").src = u;
    });
    $("statsModal").addEventListener("click", (e)=>{
      if(e.target && e.target.id === "statsModal") closeStatsModal();
    });

    // ===== Modal Edit partita (admin) =====
    function openEditModal(game){
      $("editId").value = game.id;
      $("editTitle").value = game.title || "";
      $("editDate").value = game.date || "";
      $("editStatsUrl").value = game.statsUrl || "";
      $("editYoutubeUrl").value = game.youtubeUrl || "";
      $("editNotes").value = game.notes || "";
      $("editModal").classList.add("show");
    }
    function closeEditModal(){ $("editModal").classList.remove("show"); }
    $("btnCloseEdit").addEventListener("click", closeEditModal);
    $("editModal").addEventListener("click", (e)=>{
      if(e.target && e.target.id === "editModal") closeEditModal();
    });

    $("btnSaveEdit").addEventListener("click", async ()=>{
      if(!state.isAdmin) return alert("Solo admin");
      const id = $("editId").value;
      const title = $("editTitle").value.trim();
      const date = $("editDate").value.trim();
      const statsUrl = $("editStatsUrl").value.trim();
      const youtubeUrl = $("editYoutubeUrl").value.trim();
      const notes = $("editNotes").value.trim();
      if(!id) return;
      if(!title || !date || !statsUrl) return alert("Compila: Titolo, Data, Link Statistiche");
      if(!/^\d{4}-\d{2}-\d{2}$/.test(date)) return alert("Data nel formato YYYY-MM-DD");
      await db.collection("games").doc(id).update({ title, date, statsUrl, youtubeUrl, notes });
      closeEditModal();
    });

    // Delegation: click su STATISTICHE/MODIFICA/ELIMINA
    $("list").addEventListener("click", (e)=>{
      const el = e.target.closest("[data-open-stats],[data-edit],[data-del]");
      if(!el) return;

      // STATISTICHE in modal
      if(el.hasAttribute("data-open-stats")){
        const url = el.getAttribute("data-open-stats");
        // trova titolo card
        const card = el.closest(".card");
        const title = card ? (card.querySelector(".title")?.textContent || "Statistiche") : "Statistiche";
        openStatsModal(url, title);
        return;
      }

      // MODIFICA (admin)
      if(el.hasAttribute("data-edit")){
        if(!state.isAdmin) return;
        const id = el.getAttribute("data-edit");
        const g = state.games.find(x=>x.id===id);
        if(g) openEditModal(g);
        return;
      }

      // ELIMINA
      if(el.hasAttribute("data-del")){
        // la gestione delete esistente è ok, qui lasciamo fare al vecchio handler se presente
        return;
      }
    });


    setUI();
  </script>

  <!-- Modal Statistiche -->
  <div class="modal" id="statsModal" role="dialog" aria-modal="true">
    <div class="modalCard">
      <div class="modalTop">
        <div class="modalTitle" id="statsModalTitle">Statistiche</div>
        <button class="btn" type="button" id="btnCloseStats">Chiudi</button>
      </div>
      <div class="small" id="statsHint" style="margin-top:6px;color:var(--muted)">
        Se non si apre qui dentro (alcuni siti bloccano l'anteprima), usa “Apri in browser”.
      </div>
      <div class="frameWrap">
        <iframe id="statsFrame" src="about:blank" loading="lazy" referrerpolicy="no-referrer"></iframe>
      </div>
      <div class="btnRow">
        <a id="statsOpenExternal" class="btn ok" href="#" target="_blank" rel="noopener" style="text-align:center;line-height:38px;text-decoration:none;border-radius:14px;border:1px solid var(--line);display:block">Apri in browser</a>
        <button class="btn" type="button" id="btnReloadStats">Ricarica</button>
      </div>
    </div>
  </div>

  <!-- Modal Modifica partita (solo admin) -->
  <div class="modal" id="editModal" role="dialog" aria-modal="true">
    <div class="modalCard">
      <div class="modalTop">
        <div class="modalTitle">Modifica partita</div>
        <button class="btn" type="button" id="btnCloseEdit">Chiudi</button>
      </div>
      <div class="hr"></div>
      <input type="hidden" id="editId">
      <div class="two">
        <input id="editTitle" placeholder="Titolo">
        <input id="editDate" placeholder="Data (YYYY-MM-DD)">
      </div>
      <div class="two" style="margin-top:10px">
        <input id="editStatsUrl" placeholder="Link Statistiche">
        <input id="editYoutubeUrl" placeholder="Link YouTube (opzionale)">
      </div>
      <div class="two" style="margin-top:10px">
        <input id="editNotes" placeholder="Note (opzionale)">
        <button class="btn ok" type="button" id="btnSaveEdit">Salva modifiche</button>
      </div>
      <div class="small" style="margin-top:10px">Tip: puoi anche svuotare YouTube/Note e salvare.</div>
    </div>
  </div>

</body>
</html>
