<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Basket Reggello • Partite</title>
  <style>
    :root{
      --bg:#0b0b0f; --card:#141421; --muted:#a7a7b5; --txt:#f3f3f6;
      --line:rgba(255,255,255,.12); --btn:#2a2a3f;
      --ok:#0f5f2a; --bad:#7a1f1f;
    }
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:10px}
    h1{font-size:18px;margin:0}
    .pill{padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.05);color:var(--muted);font-weight:800;font-size:12px}
    input,textarea{background:#0f0f18;color:var(--txt);border:1px solid var(--line);border-radius:12px;padding:10px 12px;outline:none}
    input::placeholder,textarea::placeholder{color:#7c7c90}
    .btn{background:var(--btn);border:1px solid var(--line);color:var(--txt);border-radius:14px;padding:10px 12px;font-weight:900;cursor:pointer}
    .btn:hover{filter:brightness(1.08)}
    .btn.ok{background:var(--ok)}
    .btn.bad{background:var(--bad)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:12px}
    .card{grid-column:span 12;background:var(--card);border:1px solid var(--line);border-radius:18px;padding:12px}
    @media(min-width:780px){ .card{grid-column:span 6} }
    .title{font-weight:1000;font-size:16px;margin:0 0 6px 0}
    .meta{color:var(--muted);font-size:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .actions .btn{flex:1;min-width:160px}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .hide{display:none !important}
    .adminBox{background:rgba(255,255,255,.04);border:1px solid var(--line);border-radius:18px;padding:12px;margin-top:12px}
    .two{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:780px){ .two{grid-template-columns:1fr 1fr} }
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .dangerLink{color:#ffb4b4;text-decoration:none;font-weight:800}

    <link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0f14">

<!-- iOS: (consigliato) -->
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    /* Modal (edit) */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:12px;z-index:9999}
    .modal.show{display:flex}
    .modalCard{width:min(980px,100%);max-height:90vh;overflow:auto;background:var(--card);border:1px solid var(--line);border-radius:18px;padding:12px}
    .modalTop{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .modalTitle{font-weight:1000}
    .frameWrap{margin-top:10px;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#000}
    .frameWrap iframe{width:100%;height:70vh;border:0}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btnRow .btn, .btnRow a.btn{flex:1;min-width:160px}
    /* Overlay statistiche (stile app) */
    .overlay{position:fixed;inset:0;background:var(--bg);display:none;flex-direction:column;z-index:10000}
    .overlay.show{display:flex}
    .overlayTop{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border-bottom:1px solid var(--line);background:rgba(0,0,0,.25);backdrop-filter: blur(6px)}
    .overlayTitle{flex:1;font-weight:1000;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .overlayBody{position:relative;flex:1}
    .overlayBody iframe{position:absolute;inset:0;width:100%;height:100%;border:0;background:#000}
    .overlayHint{position:absolute;left:12px;right:12px;bottom:12px;background:rgba(20,20,33,.86);border:1px solid var(--line);border-radius:14px;padding:10px}

/* link-bottone: stesso look del tasto YouTube */
.btnLink{
  text-decoration:none;
  display:block;
  text-align:center;
  line-height:38px;       /* stessa altezza percepita */
  border-radius:14px;     /* uguale agli altri btn */
}


  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header con logo -->
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="row" style="gap:10px;align-items:center">
        <img src="logo.png" alt="Logo" style="width:46px;height:46px;border-radius:50%;object-fit:contain;background:rgba(255,255,255,.06);border:1px solid var(--line);padding:6px"/>
        <div>
          <div style="font-weight:1000;letter-spacing:.3px">Basket Reggello UNDER 17</div>
          <div class="small" style="margin-top:2px">Viewer partite • Statistiche & YouTube</div>
        </div>
      </div>
      <span class="pill" id="statusPill">offline</span>
    </div>

    <div class="top">
      <div class="row">
        <h1>Partite</h1>
      </div>
      <div class="row">
        <input id="q" placeholder="Cerca (titolo / note)"/>
        <button class="btn" id="btnLoginToggle" type="button">Login</button>
        <button class="btn hide" id="btnLogout" type="button">Logout</button>
      </div>
    </div>

    <!-- Login -->
    <div class="adminBox hide" id="loginBox">
      <div class="two">
        <div>
          <div class="pill" style="display:inline-block;margin-bottom:8px">Login admin</div>
          <div class="row" style="margin-bottom:10px">
            <input id="email" placeholder="email" style="flex:1;min-width:220px">
            <input id="pass" placeholder="password" type="password" style="flex:1;min-width:220px">
          </div>
          <div class="row">
            <button class="btn ok" id="btnLogin" type="button">Entra</button>
            <span class="small">Solo l'admin può aggiungere/modificare/eliminare partite.</span>
          </div>
        </div>
        <div>
          <div class="pill" style="display:inline-block;margin-bottom:8px">Stato</div>
          <div class="small" id="infoBox">Caricamento…</div>
        </div>
      </div>
    </div>

    <!-- Admin: Aggiungi -->
    <div class="adminBox hide" id="adminBox">
      <div class="pill" style="display:inline-block;margin-bottom:10px">Aggiungi partita</div>
      <div class="two">
        <input id="title" placeholder="Titolo (es. Ritorno REGG CMB - BM)">
        <input id="date" placeholder="Data (YYYY-MM-DD)">
      </div>
      <div class="two" style="margin-top:10px">
        <input id="statsUrl" placeholder="Link Statistiche (https://.../statistiche/?view=1&game=...)">
        <input id="youtubeUrl" placeholder="Link YouTube (watch o live) (opzionale)">
      </div>
      <div class="two" style="margin-top:10px">
        <input id="notes" placeholder="Note (opzionale)">
        <button class="btn ok" id="btnAdd" type="button">SALVA</button>
      </div>
    </div>

    <!-- Lista -->
    <div class="grid" id="list"></div>

    <div class="hr"></div>
    <div class="small">Nota: carica il file <b>logo.png</b> nella stessa cartella di questa pagina su GitHub Pages.</div>
  </div>


  <!-- Overlay Statistiche (full-screen) -->
  <div class="overlay" id="statsOverlay" aria-hidden="true">
    <div class="overlayTop">
      <button class="btn" type="button" id="btnBackToGames">← Partite</button>
      <div class="overlayTitle" id="overlayTitle">Statistiche</div>
      <a id="overlayOpenExternal" class="btn ok" href="#" target="_blank" rel="noopener" style="text-decoration:none;display:inline-block;text-align:center;line-height:38px">Apri</a>
    </div>
    <div class="overlayBody">
      <iframe id="overlayFrame" src="about:blank" loading="lazy" referrerpolicy="no-referrer"></iframe>
      <div class="overlayHint small" id="overlayHint">
        Se non vedi le statistiche qui, premi “Apri” (alcuni siti bloccano l'anteprima).
      </div>
    </div>
  </div>


  <!-- Modal Modifica -->
  <div class="modal" id="editModal" role="dialog" aria-modal="true">
    <div class="modalCard">
      <div class="modalTop">
        <div class="modalTitle">Modifica partita</div>
        <button class="btn" type="button" id="btnCloseEdit">Chiudi</button>
      </div>
      <div class="hr"></div>
      <input type="hidden" id="editId">
      <div class="two">
        <input id="editTitle" placeholder="Titolo">
        <input id="editDate" placeholder="Data (YYYY-MM-DD)">
      </div>
      <div class="two" style="margin-top:10px">
        <input id="editStatsUrl" placeholder="Link Statistiche">
        <input id="editYoutubeUrl" placeholder="Link YouTube (opzionale)">
      </div>
      <div class="two" style="margin-top:10px">
        <input id="editNotes" placeholder="Note (opzionale)">
        <button class="btn ok" type="button" id="btnSaveEdit">Salva modifiche</button>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    const $ = (id)=>document.getElementById(id);

    // ====== CONFIG (già compilata con i tuoi dati) ======
    const firebaseConfig = {
      apiKey: "AIzaSyBhzea5-JQnlWhY9jMo3WH9v5dQOFGxolI",
      authDomain: "basket-viewer.firebaseapp.com",
      projectId: "basket-viewer",
      storageBucket: "basket-viewer.firebasestorage.app",
      messagingSenderId: "543075658747",
      appId: "1:543075658747:web:e0baba9479aac2b8bcf95e"
    };
    const ADMIN_UIDS = new Set(["bpeheJ4AgOYyuTJKAzKWAtI5nRr1"]);

    const state = { user:null, games:[], isAdmin:false, firebaseReady:false };

    // UI: Login toggle deve funzionare sempre
    $("btnLoginToggle").addEventListener("click", ()=>{
      $("loginBox").classList.toggle("hide");
    });

    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
    }
    function fmtDate(iso){
      if(!iso) return "";
      const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(!m) return iso;
      return `${m[3]}/${m[2]}/${m[1]}`;
    }
    function ytParse(url){
      if(!url) return {embed:"", ok:false};
      try{
        const u = new URL(url);
        if(u.hostname.includes("youtube.com") && u.pathname === "/watch" && u.searchParams.get("v")){
          return {embed:`https://www.youtube.com/embed/${u.searchParams.get("v")}`, ok:true};
        }
        if(u.hostname === "youtu.be"){
          const id = u.pathname.replace("/","");
          return id ? {embed:`https://www.youtube.com/embed/${id}`, ok:true} : {embed:"", ok:false};
        }
        if(u.hostname.includes("youtube.com") && u.pathname.startsWith("/live/")){
          const id = u.pathname.split("/")[2];
          return id ? {embed:`https://www.youtube.com/embed/${id}`, ok:true} : {embed:"", ok:false};
        }
        if(u.hostname.includes("youtube.com") && u.pathname.startsWith("/shorts/")){
          const id = u.pathname.split("/")[2];
          return id ? {embed:`https://www.youtube.com/embed/${id}`, ok:true} : {embed:"", ok:false};
        }
        if(u.hostname.includes("youtube.com") && u.pathname.includes("/embed/")){
          return {embed:url, ok:true};
        }
        return {embed:"", ok:false};
      }catch(e){ return {embed:"", ok:false}; }
    }

    function setUI(){
      $("btnLogout").classList.toggle("hide", !state.user);
      $("adminBox").classList.toggle("hide", !state.isAdmin);
      $("btnLoginToggle").textContent = state.user ? "Account" : "Login";
      $("statusPill").textContent = !state.firebaseReady ? "offline" : (state.isAdmin ? "admin" : "online");
    }

        // ===== Overlay Statistiche (full-screen) =====
    function openStatsOverlay(url, title){
      $("overlayTitle").textContent = title || "Statistiche";
      $("overlayOpenExternal").href = url || "#";
      $("overlayFrame").src = url || "about:blank";
      $("statsOverlay").classList.add("show");
      $("statsOverlay").setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }
    function closeStatsOverlay(){
      $("statsOverlay").classList.remove("show");
      $("statsOverlay").setAttribute("aria-hidden","true");
      $("overlayFrame").src = "about:blank";
      document.body.style.overflow = "";
    }
    $("btnBackToGames").addEventListener("click", closeStatsOverlay);
    // Chiudi anche con ESC
    window.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && $("statsOverlay").classList.contains("show")) closeStatsOverlay(); });

    // ===== Modal Modifica (admin) =====
    function openEditModal(game){
      $("editId").value = game.id;
      $("editTitle").value = game.title || "";
      $("editDate").value = game.date || "";
      $("editStatsUrl").value = game.statsUrl || "";
      $("editYoutubeUrl").value = game.youtubeUrl || "";
      $("editNotes").value = game.notes || "";
      $("editModal").classList.add("show");
    }
    function closeEditModal(){ $("editModal").classList.remove("show"); }
    $("btnCloseEdit").addEventListener("click", closeEditModal);
    $("editModal").addEventListener("click", (e)=>{
      if(e.target && e.target.id === "editModal") closeEditModal();
    });

    function render(){
      const q = ($("q").value || "").trim().toLowerCase();
      const items = state.games.filter(g=>{
        const hay = `${g.title||""} ${g.notes||""}`.toLowerCase();
        return !q || hay.includes(q);
      });

      $("list").innerHTML = items.map(g=>{
        const y = g.youtubeUrl ? escapeHtml(g.youtubeUrl) : "";
        const yInfo = g.youtubeUrl ? ytParse(g.youtubeUrl) : {embed:"", ok:false};
        const yEmbed = yInfo.ok ? escapeHtml(yInfo.embed) : "";
        const stats = escapeHtml(g.statsUrl||"");
        const del = state.isAdmin ? `<a class="dangerLink" href="#" data-del="${g.id}">Elimina</a>` : "";
        return `
          <div class="card" data-id="${g.id}">
            <div class="title">${escapeHtml(g.title||"Partita")}</div>
            <div class="meta">${fmtDate(g.date)} ${g.notes ? " • " + escapeHtml(g.notes) : ""}</div>

            <div class="actions">
              <a class="btn ok btnLink" href="#" role="button" data-open-stats="${stats}">STATISTICHE</a>
              ${g.youtubeUrl ? `<a class="btn" href="${y}" target="_blank" rel="noopener" style="text-decoration:none;display:block;text-align:center;line-height:38px;border-radius:14px">YOUTUBE</a>` : ""}
              ${state.isAdmin ? `<button class="btn" type="button" data-edit="${g.id}">MODIFICA</button>` : ""}
            </div>

            ${(g.youtubeUrl && yInfo.ok) ? `<div style="margin-top:10px;border-radius:14px;overflow:hidden;border:1px solid var(--line)">
              <iframe width="100%" height="220" src="${yEmbed}" title="YouTube" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen></iframe>
            </div>` : ""}

            ${(g.youtubeUrl && !yInfo.ok) ? `<div class="small" style="margin-top:10px">Anteprima non disponibile per questo link. Usa il tasto YOUTUBE.</div>` : ``}

            ${del ? `<div class="hr"></div><div class="small">${del}</div>` : ""}
          </div>
        `;
      }).join("");
    }

    $("q").addEventListener("input", render);

    // Delegation actions
    $("list").addEventListener("click", async (e)=>{
      const el = e.target.closest("[data-open-stats],[data-edit],[data-del]");
      if(!el) return;

// se clicco su un <a href="#"> blocco la navigazione
if(el.tagName === "A") e.preventDefault();


      if(el.hasAttribute("data-open-stats")){
        const url = el.getAttribute("data-open-stats");
        const card = el.closest(".card");
        const title = card ? (card.querySelector(".title")?.textContent || "Statistiche") : "Statistiche";
        openStatsOverlay(url, title);
        return;
      }

      if(el.hasAttribute("data-edit")){
        if(!state.isAdmin) return;
        const id = el.getAttribute("data-edit");
        const g = state.games.find(x=>x.id===id);
        if(g) openEditModal(g);
        return;
      }

      if(el.hasAttribute("data-del")){
        if(!state.isAdmin) return;
        const id = el.getAttribute("data-del");
        if(!confirm("Eliminare questa partita?")) return;
        await db.collection("games").doc(id).delete();
        return;
      }
    });

    // Save edit
    $("btnSaveEdit").addEventListener("click", async ()=>{
      if(!state.isAdmin) return alert("Solo admin");
      const id = $("editId").value;
      const title = $("editTitle").value.trim();
      const date = $("editDate").value.trim();
      const statsUrl = $("editStatsUrl").value.trim();
      const youtubeUrl = $("editYoutubeUrl").value.trim();
      const notes = $("editNotes").value.trim();
      if(!id) return;
      if(!title || !date || !statsUrl) return alert("Compila: Titolo, Data, Link Statistiche");
      if(!/^\d{4}-\d{2}-\d{2}$/.test(date)) return alert("Data nel formato YYYY-MM-DD");
      await db.collection("games").doc(id).update({ title, date, statsUrl, youtubeUrl, notes });
      closeEditModal();
    });

    // ===== Firebase init =====
    let auth=null, db=null;
    try{
      firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      state.firebaseReady = true;
      $("infoBox").textContent = "Firebase ok.";
      $("statusPill").textContent = "online";
    }catch(err){
      console.error(err);
      $("infoBox").textContent = "Errore Firebase: " + (err && err.message ? err.message : String(err));
      state.firebaseReady = false;
      setUI();
    }

    if(state.firebaseReady){
      // DB realtime
      db.collection("games").orderBy("date", "desc").onSnapshot((snap)=>{
        state.games = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        render();
      }, (err)=>{
        console.error(err);
        $("statusPill").textContent = "errore DB";
        $("infoBox").textContent = "Errore DB: " + (err && err.message ? err.message : String(err));
      });

      // Auth state
      auth.onAuthStateChanged((user)=>{
        state.user = user || null;
        state.isAdmin = !!(user && ADMIN_UIDS.has(user.uid));
        setUI();
      });

      // Login
      $("btnLogin").addEventListener("click", async ()=>{
        const email = $("email").value.trim();
        const pass = $("pass").value;
        if(!email || !pass) return alert("Inserisci email e password");
        try{
          await auth.signInWithEmailAndPassword(email, pass);
        }catch(e){
          console.error(e);
          alert("Login fallito: " + (e && e.message ? e.message : ""));
        }
      });

      // Logout
      $("btnLogout").addEventListener("click", async ()=>{
        await auth.signOut();
      });

      // Add game
      $("btnAdd").addEventListener("click", async ()=>{
        if(!state.isAdmin) return alert("Solo admin");
        const title = $("title").value.trim();
        const date = $("date").value.trim();
        const statsUrl = $("statsUrl").value.trim();
        const youtubeUrl = $("youtubeUrl").value.trim();
        const notes = $("notes").value.trim();
        if(!title || !date || !statsUrl) return alert("Compila: Titolo, Data, Link Statistiche");
        if(!/^\d{4}-\d{2}-\d{2}$/.test(date)) return alert("Data nel formato YYYY-MM-DD");

        await db.collection("games").add({
          title, date, statsUrl,
          youtubeUrl: youtubeUrl || "",
          notes: notes || "",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        $("title").value=""; $("date").value=""; $("statsUrl").value=""; $("youtubeUrl").value=""; $("notes").value="";
      });
    }

    setUI();
  </script>

  <script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js", { scope: "./" });
    });
  }
</script>

</body>
</html>
