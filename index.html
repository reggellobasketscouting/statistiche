<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Basket Scout Pro - v10</title>

<!-- XLSX (excel) -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<!-- Firebase (LIVE LINK / realtime) -->
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
<style>
:root{
  --bg:#121212;--card:#1a1a1a;--card2:#101010;--bd:#2a2a2a;
  --mut:#bdbdbd;--mut2:#8d8d8d;
  --acc:#ff9800;--g:#28a745;--r:#dc3545;--y:#ffeb3b;
  --pad:12px;--gap:6px;
}
*{box-sizing:border-box}
body{margin:0;padding:var(--pad);background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
.wrap{max-width:560px;margin:0 auto}
.hidden{display:none!important}
.flash-green{background:#1e3d24!important}.flash-red{background:#4d0000!important}.flash-blue{background:#002b36!important}

.scoreboard{display:grid;grid-template-columns:1fr .9fr 1fr;gap:10px;align-items:center;padding:12px;background:#000;border:2px solid #242424;border-radius:22px;margin-bottom:10px;text-align:center}
.score-box h1{margin:0;font-size:44px;color:var(--y);line-height:1}
.team-name{margin-top:6px;font-size:13px;font-weight:900;letter-spacing:.4px;text-transform:uppercase;color:#b5b5b5}
.meta-row{display:flex;justify-content:center;gap:8px;margin-top:6px;font-size:11px;color:#c8c8c8;font-weight:800}
.meta-row .pill{background:#111;border:1px solid #2b2b2b;border-radius:999px;padding:4px 8px;display:flex;align-items:center;gap:6px}
.meta-row b{color:var(--acc)}
.techIcon{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:6px;background:#222;border:1px solid #333;color:var(--y);font-weight:1000;font-size:12px}
.techBadge{display:inline-flex;align-items:center;justify-content:center;min-width:18px;height:18px;padding:0 6px;border-radius:6px;background:var(--y);color:#111;font-weight:1000;font-size:12px;margin-left:6px}
#labelPeriodo{font-weight:1000;color:var(--acc);font-size:20px;letter-spacing:.4px}
#syncStatus{font-size:10px;color:#7fff7f;margin-top:3px}
#btnStato{width:100%;border:none;border-radius:14px;padding:10px;font-weight:1000;color:#fff;margin-top:8px}
.bonus-on{display:none;margin-top:5px;font-size:11px;color:#ff4b4b;font-weight:1000}
.to-container{display:flex;justify-content:center;gap:5px;margin-top:8px}
.dot{width:12px;height:12px;border:1px solid #555;border-radius:50%;background:#333}
.dot.filled{background:var(--acc);box-shadow:0 0 6px rgba(255,152,0,.8)}
.btn-mini{margin-top:6px;font-size:10px;padding:7px 9px;border:none;border-radius:999px;background:#222;color:#fff;font-weight:1000}

.opp-points-bar{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:var(--gap);margin-bottom:10px;align-items:center}
.opp-label{font-size:11px;color:#ff8f8f;font-weight:1000;text-align:center}
.btn-opp{padding:12px;border-radius:14px;background:#331a1a;border:1px solid #663333;color:#ff8f8f;font-weight:1000}

.grid-players{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--gap)}
.player-card{
  position:relative;padding:12px 8px 18px;background:#2a2a2a;border:2px solid #3a3a3a;border-radius:18px;
  height:110px;min-height:110px;text-align:center;font-weight:1000;color:#fff;display:flex;flex-direction:column;justify-content:flex-start
}
.player-card.in{background:#1e3d24;border-color:var(--g)}
.player-card.cambio{background:#d8d8d8;border-color:#bdbdbd;color:#111}
.player-card.cambio .pname{color:#111}
.player-card.cambio .pnum{font-size:16px;color:#111}

.player-card.sel{background:var(--acc)!important;color:#111;border-color:#fff}
.player-card.dis{opacity:.35;pointer-events:none}
.pname{font-size:10px;font-weight:1000;color:#cfcfcf;text-transform:uppercase;line-height:1.15;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;white-space:normal;min-height:26px}
.player-card.sel .pname{color:#111}
.pnum{font-size:24px;line-height:1;margin-top:4px}
.bpts{position:absolute;left:8px;bottom:7px;font-size:14px;color:#7fff7f;font-weight:1000}
.bmid{position:absolute;left:50%;transform:translateX(-50%);bottom:7px;font-size:13px;font-weight:1000;color:var(--y)}
.bf{position:absolute;right:8px;bottom:7px;font-size:13px;background:#ff4444;color:#fff;border-radius:999px;padding:2px 8px;font-weight:1000}

.pfCard{
  position:relative;padding:12px 8px 12px;background:#2a2a2a;border:2px solid #3a3a3a;border-radius:18px;
  min-height:110px;text-align:center;font-weight:1000;color:#fff;display:flex;flex-direction:column;justify-content:flex-start
}
.pfCard .pname{min-height:26px}
.pfCard input{margin-top:8px;border-radius:12px;border:1px solid #444;background:#0f0f0f;color:#fff;padding:8px 10px;font-weight:1000;text-align:center;font-size:16px}

#azioni{display:none;margin-top:10px}
.row-2-1{display:grid;grid-template-columns:2fr 1fr;gap:var(--gap);margin-bottom:var(--gap)}
.row-2{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);margin-bottom:var(--gap)}
.row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:var(--gap);margin-bottom:var(--gap)}
.row-4{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap);margin-bottom:var(--gap)}
.row-1{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap)}
.btnA{padding:14px 10px;border:none;border-radius:14px;font-weight:1000;font-size:13px;display:flex;align-items:center;justify-content:center;color:#111}
.y{background:var(--y)}.gry{background:#e0e0e0}.red{background:#ff7f7f}.grn{background:#7fff7f}.blu{background:#add8e6}.lim{background:#98fb98}.org{background:#ffa07a}.dk{background:#333;color:#fff}.dl{background:#4caf50;color:#fff}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.94);z-index:1000;padding:14px;overflow:auto}
.mcard{max-width:560px;margin:0 auto;background:var(--card);border:1px solid var(--bd);border-radius:22px;padding:16px}
.mcard h3{margin:0 0 10px;font-weight:1000;letter-spacing:.3px}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
.topbar .closeTop{padding:10px 12px;border:none;border-radius:14px;background:#333;color:#fff;font-weight:1000}
.pill{display:inline-block;font-size:11px;color:#cfcfcf;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid #2e2e2e;background:#0f0f0f;margin-bottom:10px}
.btnW{width:100%;padding:14px 12px;border:none;border-radius:16px;font-weight:1000;margin-top:10px;font-size:14px}
.btnW.active-in{background:var(--g)!important;color:#fff!important;border:2px solid #fff}
.btnW.active-out{background:var(--r)!important;color:#fff!important;border:2px solid #fff}
input,textarea,select{width:100%;border-radius:14px;border:1px solid #3a3a3a;background:#0f0f0f;color:#fff;padding:10px 12px;font-weight:800}
textarea{min-height:110px;resize:vertical}


.court{width:310px;height:240px;background:#d2a679;border:2px solid #fff;border-radius:12px;position:relative;overflow:hidden;margin:0 auto}
.arc{position:absolute;top:-110px;left:20px;right:20px;height:270px;border:2px solid #fff;border-radius:0 0 160px 160px;pointer-events:none}
.paint{position:absolute;top:0;left:50%;transform:translateX(-50%);width:100px;height:120px;border:2px solid #fff;pointer-events:none}
.mark{position:absolute;width:18px;height:18px;border:2px solid #fff;border-radius:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:5}
canvas.ov{position:absolute;inset:0;width:100%;height:100%;z-index:4;pointer-events:none}

.selector{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:8px 0 12px}
.selbtn{
  padding:10px;border-radius:14px;border:1px solid #2e2e2e;background:#0f0f0f;color:#fff;
  font-weight:1000;font-size:12px;text-align:center;min-height:44px;display:flex;flex-direction:column;justify-content:center
}
.selbtn.act{background:var(--acc);color:#111;border-color:#fff}
.selbtn small{font-size:10px;font-weight:900;opacity:.85}

.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
@media (max-width:420px){.grid4{grid-template-columns:repeat(2,1fr)}}
.kpi{background:var(--card2);border:1px solid #2a2a2a;border-radius:18px;padding:12px;text-align:center}
.kpi .t{font-size:11px;color:#bdbdbd;font-weight:900;letter-spacing:.2px;text-align:center}
.kpi .v{margin-top:6px;font-size:18px;font-weight:1000;text-align:center}
.kpi .s{margin-top:6px;font-size:12px;color:#c8c8c8;font-weight:900;text-align:center}
.kpiY .v{color:var(--y)}
.hr{height:1px;background:#2a2a2a;margin:10px 0}

.ev-item{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:16px;padding:12px;margin-top:10px}
.ev-top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
.ev-title{font-weight:1000}
.ev-sub{font-size:11px;color:#cfcfcf;font-weight:900;margin-top:4px;line-height:1.25}
.ev-actions{display:flex;gap:8px}
.ev-actions button{padding:8px 10px;border-radius:12px;border:none;font-weight:1000}
.ev-actions .b1{background:#add8e6;color:#111}
.ev-actions .b2{background:#ff7f7f;color:#111}
.tabs{display:flex;gap:8px;margin-bottom:10px}
.tab{flex:1;padding:10px;border-radius:14px;border:1px solid #2e2e2e;background:#0f0f0f;color:#fff;font-weight:1000}
.tab.act{background:var(--acc);color:#111;border-color:#fff}
.filterRow{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px}
.fchip{padding:8px 10px;border-radius:999px;border:1px solid #2e2e2e;background:#0f0f0f;color:#fff;font-weight:1000;font-size:12px}
.fchip.act{background:var(--acc);color:#111;border-color:#fff}
.muted{color:var(--mut)}.muted2{color:var(--mut2)}

/* ===== QUINTETTI (layout tabellino) ===== */
.luCard{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:16px;padding:12px;margin-top:10px}
.luTop{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:stretch}
.luPlayers{flex:1;min-width:0}
.luP{font-weight:1000;font-size:12px;line-height:1.35;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.luNum{color:#9aa0a6;font-weight:400;margin-left:6px}
.luStats{width:170px;max-width:44vw;display:flex;flex-direction:column;justify-content:space-between;padding:2px 0}
/* Label a destra, valore a sinistra (colonna valori fissa) */
.luStat{display:grid;grid-template-columns:1fr 78px;column-gap:10px;align-items:baseline;font-size:12px;font-weight:1000;line-height:1.35}
.luStat .k{color:#bdbdbd;font-weight:900;text-align:right;white-space:nowrap}
.luStat .v{font-weight:1000;text-align:left;white-space:nowrap}
.luStat .vY{color:var(--y)}
.luStat .vPmPos{color:var(--g)}
.luStat .vPmNeg{color:var(--r)}
.luSplit{height:1px;background:#2a2a2a;margin:10px 0}
.luMetaRow{display:flex;gap:14px;flex-wrap:wrap;justify-content:center}
.luShot{display:flex;flex-direction:column;align-items:center;min-width:74px}
.luShot .n{font-size:12px;font-weight:1000}
.luShot .p{font-size:11px;color:#cfcfcf;font-weight:900;line-height:1.1}
.luMini{font-size:11px;color:#cfcfcf;font-weight:900;text-align:center;line-height:1.25}
.luMini b{font-weight:1000}

/* Mobile: mantieni tutto su una riga, rimpicciolisci colonna destra */
@media (max-width:420px){
  .luStats{width:145px;max-width:42vw}
  .luStat{font-size:11px;grid-template-columns:1fr 66px;column-gap:8px}
}
@media (max-width:360px){
  .luStats{width:132px;max-width:40vw}
  .luStat{font-size:10px;grid-template-columns:1fr 62px;column-gap:6px}
}

.endActions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px}
.endActions .btnW{margin-top:0}

/* ===== Action Screen (mobile-first) ===== */
#actionScreen{
  position:fixed;
  inset:0;
  z-index:2500;
  background:var(--bg);
  padding:12px;
  overflow:auto;
}
.actionHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}
.actionHeader .title{
  font-weight:900;
  letter-spacing:.4px;
  font-size:16px;
}
body.noScroll{overflow:hidden;}

/* === ACTION SCREEN GRID === */
#actionGrid{
  display: grid;
  grid-template-columns: 2fr 1fr;
  grid-template-rows: repeat(4, 1fr);
  gap: 10px;
  height: calc(100vh - 80px);
}
#actionGrid .btn{
  font-size: 1.4rem;
  font-weight: bold;
  height: 100%;
}
#actionGrid .full{
  grid-column: span 2;
}
#actionGrid .orange{
  background:#ff9800;
  color:#000;
}


/* ===== Action Screen - Big action buttons layout ===== */
#actionScreen{
  display:flex;
  flex-direction:column;
}
#actionScreen .actionBody{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:10px;
}
#actionScreen .actionRow{
  flex:1;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
#actionScreen .actionRow.row1{
  grid-template-columns:2fr 1fr;
}
#actionScreen .btnA{
  width:100%;
  height:100%;
  min-height:72px;
  font-size:clamp(18px, 4.5vw, 30px);
  font-weight:800;
  padding:16px 14px;
}
#actionScreen .btnA .small{
  font-size:0.8em;
  font-weight:700;
  opacity:0.9;
}
#actionScreen .btnA.orange{
  background:#ff9800 !important;
  color:#000 !important;
}
#actionScreen .actionFooter{
  margin-top:10px;
}
@media (min-width: 700px){
  #actionScreen{ padding:18px; }
  #actionScreen .btnA{ min-height:96px; font-size:clamp(22px, 2.8vw, 34px); }
}


@media (max-width:560px){
  
  .grid5 .kpi:nth-child(4),
  .grid5 .kpi:nth-child(5){ grid-column:span 1; }
}

.qTable{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:8px;
}
.qCell{
  background:#141414;
  border:1px solid #2a2a2a;
  border-radius:14px;
  padding:10px 8px;
  text-align:center;
}
.qCell .qt{ font-size:12px; font-weight:1000; color:#bdbdbd; }
.qCell .qv{ font-size:16px; font-weight:1000; color:#fff; margin-top:4px; }

@media (max-width: 420px){
  .qCell{ padding:8px 6px; }
  .qCell .qt{ font-size:11px; }
  .qCell .qv{ font-size:14px; }
}

.pillCenter{ text-align:center; }




/* ===== STAT LIVE: grid5 sempre su una riga ===== */

.grid5::-webkit-scrollbar{ height:6px; }

/* ===== Parziali squadra: occupa tutta la riga ===== */
.qTable{
  /* Parziali su UNA riga (Q1..Q4) senza scroll */
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:8px;
}
.qCell{
  background:#141414;
  border:1px solid #2a2a2a;
  border-radius:14px;
  padding:10px 8px;
  text-align:center;
}
.qCell .qt{ font-size:12px; font-weight:1000; color:#bdbdbd; }
.qCell .qv{ font-size:16px; font-weight:1000; color:#fff; margin-top:4px; }

/* ===== Barra filtri quarti ===== */
.qbar{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:center;
  margin:6px 0 12px;
}
.qbtn{
  background:#1a1a1a;
  border:1px solid #2a2a2a;
  color:#eaeaea;
  padding:8px 10px;
  border-radius:999px;
  font-weight:1000;
  font-size:12px;
}
.qbtn.act{
  background:#0b2a5a;
  border-color:#2f6fff;
  color:#ffffff;
}

/* ===== Bottoni giocatori in STAT LIVE (colori + posizioni) ===== */
.selPlayer{
  position:relative;
  padding:10px 10px 12px;
  border-radius:16px;
  min-height:110px;
  text-align:center;
}
.selPlayer.act{
  outline:2px solid #2f6fff;
}
.spTime{
  color:var(--y);
  font-weight:1000;
  font-size:13px;
  margin-bottom:6px;
}
.spName{
  font-weight:1000;
  font-size:12px;
  color:#fff;
  opacity:.95;
}
.spNum{
  font-weight:1000;
  font-size:26px;
  color:#00ff00;
  margin-top:4px;
}
.spBottom{
  position:absolute;
  left:10px;
  right:10px;
  bottom:10px;
  display:grid;
  grid-template-columns:1fr auto 1fr;
  align-items:end;
}
.spFoulBox{
  justify-self:start;
  background:#3a0000;
  border:1px solid #ff3b3b;
  color:#fff;
  font-weight:1000;
  border-radius:10px;
  padding:4px 8px;
  min-width:28px;
}
.spSpec{
  justify-self:center;
  color:#ff9f1a; /* arancione */
  font-weight:1000;
}
.spPtsBox{
  justify-self:end;
  background:#0f3a0f;
  border:1px solid #00c853;
  color:#fff;
  font-weight:1000;
  border-radius:10px;
  padding:4px 8px;
  min-width:48px;
  text-align:center;
}



/* ===== STAT LIVE: grid5 su una riga, senza scroll ===== */

.grid5 .kpi{ padding:8px 6px; }
.grid5 .kpi .t{ font-size:11px; }
.grid5 .kpi .v{ font-size:14px; }
.grid5 .kpiY .v{ font-size:18px; }

/* Parziali piccoli, Totale grande */
#tTot,#pTot{ font-size:20px; }
#tQ1,#tQ2,#tQ3,#tQ4,#pQ1,#pQ2,#pQ3,#pQ4{ font-size:14px; }

/* ===== Barra filtri quarti (sempre visibile) ===== */
.qbar{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin:6px 0 12px; }
.qbtn{ background:#1a1a1a; border:1px solid #2a2a2a; color:#eaeaea; padding:8px 10px; border-radius:999px; font-weight:1000; font-size:12px; }
.qbtn.act{ background:#0b2a5a; border-color:#2f6fff; color:#fff; }



/* ===== OVERRIDE: grid5 sempre su una riga, NO scroll ===== */




/* ===== VIEWER: mostra solo STAT LIVE ===== */
body.viewer .wrap{max-width:560px;margin:0 auto;}
body.viewer .wrap > :not(#modalStats){display:none!important;}
body.viewer #modalStats{display:block!important;}
body.viewer #actionScreen{display:none!important;}
body.viewer #modalStats{position:static!important;inset:auto!important;background:transparent!important;padding:0!important;}
body.viewer #modalStats .mcard{width:100%!important;max-width:560px;margin:0 auto!important;border-radius:18px;}
/* viewer: di base nascondi il CHIUDI a destra (non serve nello STAT LIVE principale) */
body.viewer #statsCloseBtn{display:none!important;}

/* viewer: il tasto in alto a sinistra compare SOLO in TABELLINI/QUINTETTI */
body.viewer #viewerBackBtn{display:none!important;}
body.viewer.viewerSub #viewerBackBtn{display:inline-flex!important;}




/* ===== Filtri quarti (STAT LIVE) ===== */
.qbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:10px 0 14px}
.qbtn{background:#1a1a1a;border:1px solid #2a2a2a;color:#eaeaea;padding:8px 10px;border-radius:999px;font-weight:1000;font-size:12px}
.qbtn.act{background:#0b2a5a;border-color:#2f6fff;color:#fff}
/* "TUTTA PARTITA" sempre evidente */
.qbtn.qall{background:#2a1f00;border-color:#ffb300;color:#fff}
.qbtn.qall.act{background:#ffb300;border-color:#ffb300;color:#111}


/* ===== grid5: sempre 1 riga (niente scroll), TOT grande, parziali piccoli ===== */

.grid5 .kpi{padding:8px 6px;min-width:0}
.grid5 .kpi .t{font-size:10px}
.grid5 .kpi .v{font-size:13px}
.grid5 .kpi:first-child .t{font-size:11px}
.grid5 .kpi:first-child .v{font-size:18px}

/* ===== grid5: sempre 1 riga (senza scroll). TOT grande, parziali pi√π piccoli ===== */
.grid5{
  display:grid !important;
  grid-template-columns: 1.5fr repeat(4, 1fr) !important;
  gap:8px !important;
  margin:8px 0 12px !important;
}
.grid5 .kpi{padding:8px 6px !important; min-width:0 !important;}
.grid5 .kpi .t{font-size:10px !important;}
.grid5 .kpi .v{font-size:13px !important;}
.grid5 .kpi:first-child .t{font-size:11px !important;}
.grid5 .kpi:first-child .v{font-size:18px !important;}

  /* ===================== TABLET LANDSCAPE (azioni sempre visibili) ===================== */
body.tablet .wrap{
  max-width: 1200px;
  display: grid;
  grid-template-columns: 1.15fr 0.85fr;
  gap: 14px;
  align-items: start;
}

/* colonna sinistra: tabellone + barra avversari + azioni */
body.tablet .scoreboard,
body.tablet .opp-points-bar,
body.tablet #azioni{
  grid-column: 1 / 2;
}

/* colonna destra: roster (pi√π largo) */
body.tablet #rosterGrid{
  grid-column: 2 / 3;
  display: grid;                 /* override: da flex a griglia */
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
}

/* su tablet l‚Äôoverlay non serve */
body.tablet #actionScreen{
  display: none !important;
}

/* bottoni azioni pi√π ‚Äútablet-friendly‚Äù */
body.tablet .btnA{
  min-height: 90px;
  font-size: 22px;
}




/* ===== TABELLINI (leaderboards) ===== */
.btnTop{border:none;border-radius:12px;padding:8px 12px;background:rgba(255,255,255,.10);color:#fff;font-weight:1000;letter-spacing:.2px}
.btnTop:active{transform:scale(.98)}
#tabelliniWrap{margin-top:10px}
.tabHeader{display:flex;gap:8px;align-items:center;justify-content:space-between}
.tabTitle{font-weight:1000;letter-spacing:.2px}
.tabFilters{display:flex;flex-direction:column;gap:8px;margin:10px 0}
.tabFilters .frow{display:flex;gap:8px;}
.tabFilters .frow .fbtn{flex:1 1 0;min-width:0;text-align:center;padding:8px 6px;}

.fbtn{flex:1 1 0;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#fff;font-weight:1000;font-size:11px;letter-spacing:.2px}
.fbtn.act{background:var(--acc);border-color:transparent;color:#111}

#qFilters{flex-direction:row;}
#qFilters .fchip{flex:1 1 0;min-width:0;text-align:center;}
#tabelliniList{margin-top:8px}
.trow{display:flex;align-items:center;gap:10px;padding:10px;border-radius:14px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);margin-bottom:8px}
.trow .rk{width:22px;text-align:center;font-weight:1000;color:var(--y)}
.trow .nm{flex:1;font-weight:900;letter-spacing:.2px}
.trow .nm .num{opacity:.7;font-weight:800;margin-left:6px}
.trow .val{text-align:right;font-weight:1000;white-space:nowrap}
.trow .sub{font-size:11px;opacity:.75;margin-top:2px;font-weight:800}
.trow .val .main{font-weight:1000}
.trow .val .sub{display:block}
.trow .val.reb{display:flex;gap:10px;justify-content:flex-end;align-items:baseline;white-space:nowrap}
.trow .val.reb span{min-width:28px;text-align:right}
.trow .val.reb b{min-width:34px;text-align:right}


/* ===== STAT LIVE TOPBAR: titolo centrato + bottone a sinistra ===== */
#modalStats .statsTopbar{display:flex;align-items:center;gap:10px;}
#modalStats .statsTopbar h3{flex:1;text-align:center;}
#modalStats #viewerBackBtn{min-width:44px;}

</style>

<style id="statsLiveLayout">
/* ===== STAT LIVE: tabellone ===== */
.stats-board{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:14px;padding:10px;margin:10px 0 10px;display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;}
.sb-name{color:#bdbdbd;font-weight:900;font-size:12px;}
.sb-row{display:flex;align-items:baseline;gap:10px;}
.sb-score{color:var(--y);font-weight:1000;font-size:26px;}
.sb-meta{color:#d6d6d6;font-size:12px;font-weight:900;}
.sb-mid{text-align:center;}
.sb-period{color:#fff;font-weight:1000;font-size:14px;padding:6px 10px;border-radius:999px;background:#1a1a1a;border:1px solid #2a2a2a;display:inline-flex;align-items:center;justify-content:center;}
.sb-tech{margin-left:6px;padding:2px 6px;border-radius:8px;background:#2a1a1a;color:#ff5252;font-weight:1000;}
.sb-to{display:flex;gap:4px;margin-top:6px;}
.sb-to .to-dot{width:10px;height:10px;border-radius:50%;background:var(--y);}
.sb-final{margin-left:8px;padding:4px 10px;border-radius:999px;background:#2a0000;color:#ff3b3b;font-weight:1000;font-size:12px;letter-spacing:1px;}

/* ===== Selector layout ===== */
.selectorTeam{display:flex;flex-direction:column;gap:8px;margin:8px 0 8px;}
.teamRow{display:flex;gap:8px;}
.teamRow .selbtn{flex:1;}
.btnSquadra{width:100%;flex:1;font-size:16px;padding:14px 12px;border-radius:16px;}

.selectorPlayers{display:flex;gap:8px;overflow-x:auto;scroll-snap-type:x mandatory;margin:0 0 12px;padding:0 18px 6px;-webkit-overflow-scrolling:touch;}
/* Fade ai bordi per indicare scroll (sinistra+destra) */
.selectorPlayers{
  -webkit-mask-image: linear-gradient(to right, transparent 0, #000 18px, #000 calc(100% - 18px), transparent 100%);
  mask-image: linear-gradient(to right, transparent 0, #000 18px, #000 calc(100% - 18px), transparent 100%);
}
.pillCenter{display:block;width:100%;text-align:center;margin:0 auto 10px;}

/* ===== Player button layout ===== */
/* Pulsante giocatore (STAT LIVE) */
.selbtn.selPlayer{scroll-snap-align:start;flex:0 0 30%;max-width:30%;height:96px;
  position:relative;
  min-height:112px;
  padding:10px 10px 18px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
}

/* PARTE ALTA (centrale): tempo - giallo, solo a partita finita */
.spTime{
  position:absolute;
  top:6px;
  left:50%;
  transform:translateX(-50%);
  color:var(--y);
  font-weight:1000;
  font-size:12px;
}

/* SOTTO: nome */
.spName{
  margin-top:18px; /* lascia spazio al tempo */
  font-weight:1000;
  font-size:12px;
  line-height:1.05;
}

/* SOTTO: numero grande (senza #) */
.spNum{
  margin-top:6px;
  font-weight:1000;
  font-size:26px;
  line-height:1;
}

/* RIGA BASSA rimossa in STAT LIVE */
.spBottom{display:none;}

/* BASSO SINISTRA: box rosso con numero falli */
.spFoulBox{
  min-width:22px;
  height:22px;
  padding:0 7px;
  border-radius:6px;
  background:#ff3b3b;
  color:#fff;
  font-weight:1000;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* BASSO CENTRO: T/U/D in arancione */
.spSpec{
  flex:1;
  text-align:center;
  color:orange;
  font-weight:1000;
  font-size:12px;
}

/* BASSO DESTRA: punti in verde */
.spPts{
  min-width:44px;
  text-align:right;
  color:var(--g);
  font-weight:1000;
  font-size:12px;
}

/* Un po' piu grandi su schermi piccoli */
@media (max-width:420px){
  .selectorPlayers{display:flex;gap:8px;overflow-x:auto;scroll-snap-type:x mandatory;margin:0 0 12px;padding:0 14px 6px;-webkit-overflow-scrolling:touch;}
  .selbtn.selPlayer{flex:0 0 30%;max-width:30%;height:96px;min-height:118px;}
  .spNum{font-size:28px;}
}
/* ===== Viewer pulito ===== */

body.viewer #actionScreen{display:none!important;}
body.viewer #modalStats{position:static!important;inset:auto!important;background:transparent!important;padding:0!important;}
body.viewer #modalStats .mcard{width:100%!important;max-width:560px;margin:0 auto!important;border-radius:18px;}
/* viewer: di base nascondi il CHIUDI a destra (non serve nello STAT LIVE principale) */
body.viewer #statsCloseBtn{display:none!important;}

/* viewer: il tasto in alto a sinistra compare SOLO in TABELLINI/QUINTETTI */
body.viewer #viewerBackBtn{display:none!important;}
body.viewer.viewerSub #viewerBackBtn{display:inline-flex!important;}

body.viewer .wrap > :not(#modalStats){display:none!important;}
body.viewer #modalStats{display:block!important;}

/* ===== Falli speciali KPI ===== */
.foulSpec{color:#ff3b3b;font-weight:1000;margin-left:6px;}
</style>

</head>

<body>
<div class="wrap">
  <div class="scoreboard">
    <div class="score-box">
      <h1 id="scoreHome">0</h1><div class="team-name" id="nameH">CASA</div>
      <div class="meta-row">
        <div class="pill">Falli <b id="sfHome">0</b> <span id="techHome" class="techBadge hidden">T</span></div>
      </div>
      <div id="bHome" class="bonus-on">BONUS</div>
      <div id="dotsHome" class="to-container"></div>
      <button class="btn-mini" onclick="addEventTimeout('Home')">TIMEOUT</button>
    </div>
    <div>
      <div id="labelPeriodo">Q1</div>
      <div id="syncStatus">LOCALE</div>
      <button id="btnStato" onclick="togglePeriodo()">INIZIA Q1</button>
      <button class="btn-mini" onclick="openManualEdit()">‚úçÔ∏è MODIFICA</button>
    </div>
    <div class="score-box">
      <h1 id="scoreAway">0</h1><div class="team-name" id="nameA">TRASFERTA</div>
      <div class="meta-row">
        <div class="pill">Falli <b id="sfAway">0</b> <span id="techAway" class="techBadge hidden">T</span></div>
      </div>
      <div id="bAway" class="bonus-on">BONUS</div>
      <div id="dotsAway" class="to-container"></div>
      <button class="btn-mini" onclick="addEventTimeout('Away')">TIMEOUT</button>
    </div>
  </div>

  <div class="opp-points-bar">
    <div class="opp-label">PUNTI<br>AVVERSARI</div>
    <button class="btn-opp" onclick="addEventOppPoint(1)">+1</button>
    <button class="btn-opp" onclick="addEventOppPoint(2)">+2</button>
    <button class="btn-opp" onclick="addEventOppPoint(3)">+3</button>
  </div>

  <div class="grid-players" id="rosterGrid"></div>

  <!-- ACTION SCREEN (per azioni giocatore) -->
  <div id="actionScreen" class="hidden">
    <div class="actionHeader">
      <div class="title">AZIONI ‚Ä¢ <span id="actionPlayerLabel">‚Äî</span></div>
      <button class="btnA dk" onclick="closeActionScreen(); clearSelectedPlayer()">‚¨ÖÔ∏è INDIETRO</button>
    </div>
    <!-- Azioni giocatore spostate nella schermata dedicata -->
<div class="actionBody" style="margin-top:10px">
  <div class="actionRow row1">
    <button class="btnA y" onclick="actionShot()">üèÄ TIRO</button>
    <button class="btnA gry" onclick="actionFT()">üóëÔ∏è LIBERI</button>
  </div>

  <div class="actionRow">
    <button class="btnA red" onclick="actionFoulMade()">üõë FALLO FATTO</button>
    <button class="btnA grn" onclick="actionFoulSuffered()">ü§ù FALLO SUBITO</button>
  </div>

  <div class="actionRow">
    <button class="btnA org" onclick="actionQuick('turnover')">‚ö†Ô∏è PERSA</button>
    <button class="btnA lim" onclick="actionQuick('steal')">üõ°Ô∏è RECUPERO</button>
  </div>

  <div class="actionRow">
    <button class="btnA blu" onclick="actionQuick('reb_def')">‚¨áÔ∏è R.DIF</button>
    <button class="btnA orange" onclick="actionQuick('reb_off')">‚¨ÜÔ∏è R.OFF</button>
  </div>
</div>

<div class="actionFooter infoCard" style="margin-top:10px">
      Tocca un‚Äôazione per registrarla. Dopo la registrazione torni automaticamente alla schermata principale.
    </div>
  </div>


  <div id="azioni">


    <div class="row-2">
      <button class="btnA gry" style="grid-column:1/-1" onclick="openSpecialFoul()">üö® TEC/ANT/ESP</button>
    </div>

    <div class="row-2">
      <button class="btnA org" onclick="openManualEdit()">‚úçÔ∏è MODIFICA MANUALE</button>
      <button class="btnA gry" onclick="openModal('modalFalliCheck')">üßæ CHECK FALLI</button>
    </div>
    <div class="row-1">
      <button class="btnA blu" onclick="openStats()">üìä STAT LIVE</button>
    </div>

    <div class="row-4">
      <button class="btnA gry" onclick="undoLast()">‚Ü©Ô∏è UNDO</button>
      <button class="btnA gry" onclick="openEvents()">üßæ EVENTI</button>
      <button class="btnA gry" onclick="copyLiveLink()">üì° LIVE LINK</button>
      <button class="btnA dk" onclick="openModal('modalSetup')">‚öôÔ∏è SETUP</button>
    </div>

    <div class="row-2">
      <button class="btnA dk" onclick="exportGameJSON()">üíæ ESPORTA PARTITA</button>
      <button class="btnA dk" onclick="document.getElementById('importFile').click()">üìÇ IMPORTA</button>
      <input id="importFile" type="file" accept="application/json" class="hidden"/>
    </div>
    <div class="row-2">
      <button class="btnA dk" onclick="openGamesHome()">üè† PARTITE</button>
      <button class="btnA dl" onclick="exportExcel()">üì• SCARICA EXCEL</button>
    </div>
  </div>
</div>


<!-- HOME / PARTITE -->
<div id="modalStartup" class="modal hidden"><div class="mcard">
  <div class="topbar">
    <h3 style="margin:0">PARTITE SALVATE</h3>
    <button class="closeTop" onclick="newGameFlow()">NUOVA</button>
  </div>
  <div class="pill">Seleziona una partita o creane una nuova (nome unico).</div>

  <div id="gamesList"></div>

  <button class="btnW" style="background:#333;color:#fff" onclick="closeModal('modalStartup')">CHIUDI</button>
</div></div>


<!-- SETUP -->
<div id="modalSetup" class="modal hidden"><div class="mcard">
  <div class="topbar">
    <h3 style="margin:0">SETUP PARTITA</h3>
    <button class="closeTop" onclick="closeModal('modalSetup')">CHIUDI</button>
  </div>
  <div class="pill">Locale ‚Ä¢ Roster ‚Ä¢ Durate periodi</div>
  <div class="grid2">
    <div><div class="pill">Durata quarto</div>
      <select id="quarterLenSel"><option value="10" selected>10 minuti</option><option value="12">12 minuti</option><option value="8">8 minuti</option></select>
    </div>
    <div><div class="pill">Durata OT</div>
      <select id="otLenSel"><option value="5" selected>5 minuti</option><option value="3">3 minuti</option></select>
    </div>
  </div>
  <div class="grid2" style="margin-top:10px">
    <div><div class="pill">Sono CASA / TRASFERTA</div>
      <select id="noiSel"><option value="Home" selected>CASA</option><option value="Away">TRASFERTA</option></select>
    </div>
    <div class="muted2" style="font-size:13px;line-height:1.25;padding:10px 12px;border:1px solid #2e2e2e;border-radius:14px;background:#0f0f0f">
      Tip: i nomi verranno mostrati nel tabellone e nel Live.
  </div>
</div>


  <div class="grid2" style="margin-top:10px">
<div><div class="pill">Squadra CASA</div><input id="teamHomeName" type="text" placeholder="Nome squadra CASA"/></div>    
<div><div class="pill">Squadra TRASFERTA</div><input id="teamAwayName" type="text" placeholder="Nome squadra TRASFERTA"/></div>
    </div>

  <div style="margin-top:10px">
    <div class="pill">Mia squadra: NUMERO + NOME</div>
    <div class="muted2" style="font-size:11px;margin-top:6px;line-height:1.25">Il numero accetta anche <b>0</b> e <b>00</b>.</div>
    <div id="myTeamRows" style="margin-top:10px"></div>
    <button type="button" class="btnW" style="background:#222;color:#fff;border:1px solid #2e2e2e" onclick="addMyRow('','')">‚ûï AGGIUNGI GIOCATORE</button>
    <!-- legacy textarea (hidden) -->
    <textarea id="myTeamInput" style="display:none"></textarea>
  </div>
  <div style="margin-top:10px"><div class="pill">Avversari: solo numero (uno per riga)</div>
    <textarea id="oppTeamInput" placeholder="3&#10;8&#10;12&#10;20&#10;25"></textarea>
  </div>

  <div style="margin-top:10px">
    <div class="pill">üì° LIVE (Cloud) ‚Ä¢ condividi in tempo reale</div>
      <div><input id="cloudIdInput" type="text" placeholder="ID partita (es. U15_vs_ABC_2026-01-14)"></div>
    <div class="grid2">
      <div><button class="btnW" style="background:#e0e0e0;color:#111" onclick="connectCloudFromSetup()">CONNETTI</button></div>
<button class="btnW" onclick="copyLiveLink()">üì° LIVE LINK</button>
    </div>
    <div class="muted2" style="font-size:11px;margin-top:8px;line-height:1.25">
      Dopo la connessione comparir√† il tasto <b>üì° LIVE LINK</b> per copiare il link viewer.
    </div>
  </div>

  <button class="btnW" style="background:var(--g);color:#fff" onclick="applySetup()">APPLICA</button>
  <button class="btnW" style="background:#333;color:#fff" onclick="resetAll()">RESET TOTALE</button>
  <div class="muted2" style="font-size:11px;margin-top:10px;line-height:1.25">Nota: Il periodo parte solo dopo <b>CONFERMA (5/5)</b>.</div>
</div></div>

<!-- CHOOSE 5 -->
<div id="modalChoose5" class="modal hidden"><div class="mcard">
  <div class="topbar">
    <h3 style="margin:0">SCEGLI 5</h3>
    <button class="closeTop" onclick="cancelChoose5()">CHIUDI</button>
  </div>
  <div class="pill">Chi ha 5 falli o espulsione √® disabilitato</div>
  <div class="grid-players" id="choose5Grid"></div>
  <button id="btnConfirm5" class="btnW" style="background:grey;color:#fff" disabled onclick="confirm5()">CONFERMA (0/5)</button>
  <button class="btnW" style="background:#333;color:#fff" onclick="cancelChoose5()">ANNULLA</button>
</div></div>

<!-- END PERIOD -->
<div id="modalEndPeriod" class="modal hidden"><div class="mcard">
  <div class="topbar">
    <h3 id="endPeriodTitle" style="margin:0">FINE PERIODO</h3>
    <button class="closeTop" onclick="closeModal('modalEndPeriod')">CHIUDI</button>
  </div>
  <button class="btnW" style="background:var(--g);color:#fff" onclick="nextPeriod()">SUCCESSIVO</button>
  <button class="btnW" style="background:var(--r);color:#fff" onclick="endGame()">TERMINA PARTITA</button>
  <button class="btnW" style="background:#333;color:#fff" onclick="closeModal('modalEndPeriod')">ANNULLA</button>
</div></div>

<!-- GAME OVER -->
<div id="modalGameOver" class="modal hidden"><div class="mcard">
  <div class="topbar">
    <h3 style="margin:0">PARTITA TERMINATA ‚úÖ</h3>
    <button class="closeTop" onclick="closeModal('modalGameOver')">CHIUDI</button>
  </div>
  <div class="pill">Azioni finali</div>
  <div class="endActions">
    <button class="btnW" style="background:#e0e0e0;color:#111" onclick="openModal('modalFalliCheck')">üßæ CHECK FALLI</button>
    <button class="btnW" style="background:#add8e6;color:#111" onclick="openStats()">üìä STAT LIVE</button>
    <button class="btnW" style="background:#4caf50;color:#fff" onclick="exportExcel()">üì• SCARICA EXCEL</button>
    <button class="btnW" style="background:#222;color:#fff;border:1px solid #2e2e2e" onclick="openEvents()">üßæ EVENTI</button>
    <button class="btnW" style="background:#111;color:#fff;border:1px solid #2e2e2e" onclick="goToGamesMenu()">üè† PARTITE</button>
    <button class="btnW" style="background:#333;color:#fff" onclick="closeModal('modalGameOver');resetToSetup()">‚Ü©Ô∏è CHIUDI (TORNA SETUP)</button>
  </div>
</div></div>

<!-- SUB -->
<div id="modalSub" class="modal hidden"><div class="mcard">
  <div class="topbar">
    <h3 style="margin:0">CAMBIO üîÑ</h3>
    <button class="closeTop" onclick="closeModal('modalSub')">CHIUDI</button>
  </div>
  <div class="pill">Tempo rimanente (MSS) es: 835 = 8:35</div>
  <input id="subTime" type="tel" inputmode="numeric" maxlength="3" placeholder="000"/>
  <div class="pill" style="margin-top:10px">CHI ESCE</div><div class="grid-players" id="outGrid"></div>
  <div class="pill" style="margin-top:10px">CHI ENTRA</div><div class="grid-players" id="inGrid"></div>
  <button id="btnConfirmSub" class="btnW" style="background:grey;color:#fff" disabled onclick="addEventSub()">CONFERMA</button>
  <button class="btnW" style="background:#333;color:#fff" onclick="closeModal('modalSub')">ANNULLA</button>
</div></div>

<!-- SHOT -->
<div id="modalTiro" class="modal hidden"><div class="mcard">
  <div class="topbar">
    <h3 id="shotInfo" style="margin:0">Tiro da ?</h3>
    <button class="closeTop" onclick="closeShotModal()">CHIUDI</button>
  </div>
  <div class="court" id="shotCourt"><div class="arc"></div><div class="paint"></div></div>
  <div class="row-2" style="margin-top:10px">
    <button class="btnA" style="background:var(--g);color:#fff" onclick="addEventShot(true)">SEGNATO</button>
    <button class="btnA" style="background:var(--r);color:#fff" onclick="addEventShot(false)">SBAGLIATO</button>
  </div>
  <button class="btnW" style="background:#333;color:#fff" onclick="closeShotModal()">ANNULLA</button>
</div></div>

<!-- FT -->
<div id="modalFT" class="modal hidden"><div class="mcard">
  <div class="topbar">
    <h3 style="margin:0">TIRI LIBERI</h3>
    <button class="closeTop" onclick="closeFTModal()">CHIUDI</button>
  </div>
  <div class="pill">Tocca per segnare (‚úÖ) o sbagliare (‚ùå)</div>
  <div id="ftSeq" style="font-size:26px;margin:10px 0"></div>
  <div class="row-2">
    <button class="btnA" style="background:var(--g);color:#fff" onclick="addEventFT(true)">OK</button>
    <button class="btnA" style="background:var(--r);color:#fff" onclick="addEventFT(false)">X</button>
  </div>
  <button class="btnW" style="background:#333;color:#fff" onclick="closeModal('modalFT')">FINE</button>
</div></div>

<!-- FOUL SUF -->
<div id="modalFoulSuf" class="modal hidden"><div class="mcard">
  <div class="topbar">
    <h3 style="margin:0">FALLO SUBITO</h3>
    <button class="closeTop" onclick="closeModal('modalFoulSuf')">CHIUDI</button>
  </div>
  <div class="pill">Seleziona chi ha fatto fallo (avversari)</div>
  <div class="grid-players" id="oppFoulGrid"></div>
  <button id="btnRimessa" class="btnW" style="background:#e0e0e0;color:#111" disabled onclick="addEventFoulSuf(false)">RIMESSA</button>
  <button id="btnLiberi" class="btnW" style="background:var(--y);color:#111" disabled onclick="addEventFoulSuf(true)">LIBERI</button>
  <button class="btnW" style="background:#333;color:#fff" onclick="closeModal('modalFoulSuf')">ANNULLA</button>
</div></div>

<!-- SPECIAL FOUL -->
<div id="modalSpecial" class="modal hidden"><div class="mcard">
  <div class="topbar">
    <h3 style="margin:0">FALLO SPECIALE</h3>
    <button class="closeTop" onclick="closeModal('modalSpecial')">CHIUDI</button>
  </div>
  <div class="pill">Seleziona 1 tipo ‚Ä¢ poi uno o pi√π giocatori</div>

  <div class="tabs">
    <button class="tab act" id="tabT" onclick="setSpecialType('T')">TECNICO</button>
    <button class="tab" id="tabU" onclick="setSpecialType('U')">ANTISPORTIVO</button>
    <button class="tab" id="tabD" onclick="setSpecialType('D')">ESPULSIONE</button>
  </div>

  <div class="pill">SQUADRA CASA</div>
  <div class="grid-players" id="specHomeGrid"></div>
  <button id="benchHomeBtn" class="btnW" style="background:#222;color:#fff;border:1px solid #2e2e2e" onclick="toggleBench('Home')">üèüÔ∏è PANCHINA CASA</button>

  <div class="hr"></div>

  <div class="pill">SQUADRA OSPITE</div>
  <div class="grid-players" id="specAwayGrid"></div>
  <button id="benchAwayBtn" class="btnW" style="background:#222;color:#fff;border:1px solid #2e2e2e" onclick="toggleBench('Away')">üèüÔ∏è PANCHINA OSPITE</button>

  <button id="btnSpecOk" class="btnW" style="background:grey;color:#fff" disabled onclick="addEventSpecial()">CONFERMA</button>
  <button class="btnW" style="background:#333;color:#fff" onclick="closeModal('modalSpecial')">ANNULLA</button>
</div></div>

<!-- CHECK FOULS -->
<div id="modalFalliCheck" class="modal hidden"><div class="mcard">
  <div class="topbar">
    <h3 style="margin:0">CHECK FALLI</h3>
    <button class="closeTop" onclick="closeModal('modalFalliCheck')">CHIUDI</button>
  </div>
  <div class="pill"><span id="cfTeams">-</span></div>
  <div class="grid2">
    <div class="kpi"><div class="t" id="cfHomeName">CASA</div><div class="v"><span id="cfHome">0</span> Falli</div><div class="s">Dettaglio sotto</div></div>
    <div class="kpi"><div class="t" id="cfAwayName">TRASFERTA</div><div class="v"><span id="cfAway">0</span> Falli</div><div class="s">Dettaglio sotto</div></div>
  </div>
  <div class="pill" style="margin-top:12px">MIA SQUADRA</div><div id="cfMyList"></div>
  <div class="pill" style="margin-top:12px">AVVERSARI</div><div id="cfOppList"></div>
</div></div>

<!-- STATS -->
<div id="modalStats" class="modal hidden"><div class="mcard">
  <div class="topbar statsTopbar">
    <!-- Viewer: torna indietro (visibile solo in TABELLINI/QUINTETTI) -->
    <button id="viewerBackBtn" class="closeTop viewerBack hidden" onclick="smartCloseStats()">‚¨ÖÔ∏è</button>

    <h3 style="margin:0;flex:1;text-align:center">STAT LIVE</h3>

    <div style="display:flex;gap:8px;align-items:center">
      <!-- In TABELLINI/QUINTETTI torna alle stats, altrimenti chiude il modal -->
      <button id="statsCloseBtn" class="closeTop" onclick="smartCloseStats()">CHIUDI</button>
    </div>
  </div>

  <div id="tabelliniWrap" class="hidden">
    <div class="pill pillCenter">TABELLINI</div>
    <div class="pill" style="margin-top:8px">Seleziona una classifica</div>
    <div class="tabFilters" id="tabFilters"></div>
    <div id="tabelliniList"></div>
    <button class="btnW" style="margin-top:10px;background:#333;color:#fff" onclick="closeTabellini()">CHIUDI</button>
  </div>

  <div id="quintettiWrap" class="hidden">
    <div class="pill pillCenter">QUINTETTI</div>
    <div class="pill" style="margin-top:8px">ORDINE PER</div>
    <div class="tabFilters" id="qFilters"></div>
    <div id="quintettiList"></div>
    <button class="btnW" style="margin-top:10px;background:#333;color:#fff" onclick="closeQuintetti()">CHIUDI</button>
  </div>

  <div id="statsMainWrap">
  <div class="stats-board">
    <div class="sb-team">
      <div class="sb-name" id="sbNameH">CASA</div>
      <div class="sb-row">
        <span class="sb-score" id="sbScoreH">0</span>
        <span class="sb-meta">Falli <b id="sbFoulsH">0</b> <span id="sbTechH" class="sb-tech hidden">T</span></span>
      </div>
      <div class="sb-to" id="sbToH"></div>
    </div>

    <div class="sb-mid">
      <div class="sb-period" id="sbPeriod">
        <span id="sbPeriodTxt">1¬∞ quarto</span>
        <span id="sbFinal" class="sb-final hidden">FINAL</span>
      </div>
    </div>

    <div class="sb-team" style="text-align:right">
      <div class="sb-name" id="sbNameA">TRASFERTA</div>
      <div class="sb-row" style="justify-content:flex-end">
        <span class="sb-meta">Falli <b id="sbFoulsA">0</b> <span id="sbTechA" class="sb-tech hidden">T</span></span>
        <span class="sb-score" id="sbScoreA">0</span>
      </div>
      <div class="sb-to" id="sbToA" style="justify-content:flex-end"></div>
    </div>
  </div>

<div id="teamPartialsWrap" class="partialsWrap">
  <div class="pill pillCenter" style="margin-top:6px">PARZIALI</div>
  <div id="teamQPartials" class="qTable"></div>

  <div id="teamOTPartialsWrap" class="hidden" style="margin-top:6px">
    <div class="pill pillCenter">PARZIALI OT</div>
    <div id="teamOTPartials" class="qTable"></div>
  </div>
</div>


  <div class="selectorTeam" id="statsTeam"></div>
  <div class="pill pillCenter" id="statsHint"><------Seleziona un giocatore per vedere le statistiche personali------></div>
  <div class="selectorPlayers" id="statsPlayers"></div>
<!-- TEMPO per quarto (solo giocatore) -->
<div id="playerTimeWrap" class="hidden">
  <div class="grid5">
    <div class="kpi kpiY"><div class="t">TEMPO TOT</div><div class="v" id="tTot">00:00</div></div>
    <div class="kpi"><div class="t">1Q</div><div class="v" id="tQ1">00:00</div></div>
    <div class="kpi"><div class="t">2Q</div><div class="v" id="tQ2">00:00</div></div>
    <div class="kpi"><div class="t">3Q</div><div class="v" id="tQ3">00:00</div></div>
    <div class="kpi"><div class="t">4Q</div><div class="v" id="tQ4">00:00</div></div>
  </div>

  <div id="playerOTTimeWrap" class="hidden" style="margin-top:10px">
    <div class="pill pillCenter">MINUTI OT</div>
    <div id="playerOTMinutes" class="qTable"></div>
  </div>
</div>

<!-- PUNTI per quarto (solo giocatore) -->
<div id="playerPtsWrap" class="hidden" style="margin-top:10px">
  <div class="grid5">
    <div class="kpi kpiY"><div class="t">PUNTI TOT</div><div class="v" id="pTot">0</div></div>
    <div class="kpi"><div class="t">1Q</div><div class="v" id="pQ1">0</div></div>
    <div class="kpi"><div class="t">2Q</div><div class="v" id="pQ2">0</div></div>
    <div class="kpi"><div class="t">3Q</div><div class="v" id="pQ3">0</div></div>
    <div class="kpi"><div class="t">4Q</div><div class="v" id="pQ4">0</div></div>
  </div>

  <div id="playerOTWrap" class="hidden" style="margin-top:10px">
    <div class="pill pillCenter">PUNTI OT</div>
    <div id="playerOTPoints" class="qTable"></div>
  </div>
</div>

<!-- PLUS/MINUS (solo giocatore) -->
<div id="kpmWrap" class="hidden" style="margin-top:10px">
  <div class="kpi kpiY"><div class="t">PLUS/MINUS</div><div class="v" id="kpm">0</div></div>
</div>

  <div class="grid3">
    <div class="kpi"><div class="t">TIRI DA 2</div><div class="v" id="k2">0/0</div><div class="s" id="k2p">0,00%</div></div>
    <div class="kpi"><div class="t">TIRI DA 3</div><div class="v" id="k3">0/0</div><div class="s" id="k3p">0,00%</div></div>
    <div class="kpi"><div class="t">TIRI LIBERI</div><div class="v" id="kft">0/0</div><div class="s" id="kftp">0,00%</div></div>
  </div>

  <div class="grid2">
    <div class="kpi"><div class="t">FALLI FATTI</div><div class="v" id="kfmade">0</div></div>
    <div class="kpi"><div class="t">FALLI SUBITI</div><div class="v" id="kfsuf">0</div></div>
  </div>

  <div class="grid4">
    <div class="kpi"><div class="t">PERSE</div><div class="v" id="kto">0</div></div>
    <div class="kpi"><div class="t">RECUPERATE</div><div class="v" id="kstl">0</div></div>
    <div class="kpi"><div class="t">RIMB. OFF</div><div class="v" id="kro">0</div></div>
    <div class="kpi"><div class="t">RIMB. DIF</div><div class="v" id="krd">0</div></div>
  </div>
  <div style="margin-top:12px"><div class="pill">SHOT CHART (‚úÖ / ‚ùå)</div>
    <div class="court"><div class="arc"></div><div class="paint"></div><canvas class="ov" id="shotCanvas" width="310" height="240"></canvas></div>
  </div>


  <div style="margin-top:12px"><div class="pill">HEATMAP TIRI</div>
    <div class="court"><div class="arc"></div><div class="paint"></div><canvas class="ov" id="heatCanvas" width="310" height="240"></canvas></div>
  </div>
</div><!-- end statsMainWrap -->
</div></div>

<!-- EVENTS -->
<div id="modalEvents" class="modal hidden"><div class="mcard">
  <div class="topbar">
    <h3 style="margin:0">EVENTI</h3>
    <button class="closeTop" onclick="closeModal('modalEvents')">CHIUDI</button>
  </div>
  <div class="pill">Filtro + modifica/elimina ‚Ä¢ ricalcolo automatico</div>

  <div class="filterRow" id="evFilters"></div>
  <input id="evSearch" placeholder="Cerca (es. #7, tiro, cambio...)" />

  <div class="row-2" style="margin-top:10px">
    <button class="btnA gry" onclick="undoLast();renderEvents()">‚Ü©Ô∏è UNDO (ultimo)</button>
    <button class="btnA dk" onclick="closeModal('modalEvents')">CHIUDI</button>
  </div>

  <div id="eventsList"></div>
</div></div>

<!-- EDIT EVENT -->
<div id="modalEdit" class="modal hidden"><div class="mcard">
  <div class="topbar">
    <h3 style="margin:0">MODIFICA EVENTO</h3>
    <button class="closeTop" onclick="closeModal('modalEdit')">CHIUDI</button>
  </div>
  <div class="pill" id="editHint">-</div>
  <div id="editForm"></div>
  <button class="btnW" style="background:var(--g);color:#fff" onclick="saveEdit()">SALVA</button>
  <button class="btnW" style="background:#333;color:#fff" onclick="closeModal('modalEdit')">ANNULLA</button>
</div></div>

<!-- MANUAL EDIT -->
<div id="modalManual" class="modal hidden"><div class="mcard">
  <div class="topbar">
    <h3 style="margin:0">MODIFICA MANUALE</h3>
    <button class="closeTop" onclick="closeModal('modalManual')">CHIUDI</button>
  </div>
  <div class="pill">Imposta lo stato di gara se inizi a partita gi√† iniziata (punteggio, falli, periodo, timeout, quintetto).</div>

  <div class="grid2">
    <div>
      <div class="pill">Punteggio CASA</div>
      <input id="mScoreH" type="tel" inputmode="numeric" placeholder="0" />
    </div>
    <div>
      <div class="pill">Punteggio TRASFERTA</div>
      <input id="mScoreA" type="tel" inputmode="numeric" placeholder="0" />
    </div>
  </div>

  <div class="grid2" style="margin-top:10px">
    <div>
      <div class="pill">Falli di squadra CASA (nel periodo)</div>
      <input id="mFoulH" type="tel" inputmode="numeric" placeholder="0" />
    </div>
    <div>
      <div class="pill">Falli di squadra TRASFERTA (nel periodo)</div>
      <input id="mFoulA" type="tel" inputmode="numeric" placeholder="0" />
    </div>
  </div>

  <div class="grid2" style="margin-top:10px">
    <div>
      <div class="pill">Timeout CASA (nel periodo)</div>
      <input id="mToH" type="tel" inputmode="numeric" placeholder="0" />
    </div>
    <div>
      <div class="pill">Timeout TRASFERTA (nel periodo)</div>
      <input id="mToA" type="tel" inputmode="numeric" placeholder="0" />
    </div>
  </div>

  <div class="grid2" style="margin-top:10px">
    <div>
      <div class="pill">Periodo</div>
      <select id="mPeriod">
        <option value="1">Q1</option><option value="2">Q2</option><option value="3">Q3</option><option value="4">Q4</option>
        <option value="5">OT1</option><option value="6">OT2</option><option value="7">OT3</option>
      </select>
    </div>
    <div>
      <div class="pill">Stato</div>
      <select id="mStatus">
        <option value="playing">IN CORSO</option>
        <option value="idle">PAUSA (tra periodi)</option>
      </select>
    </div>
  </div>

  <div style="margin-top:10px">
    <div class="pill">Tempo rimanente nel periodo (MSS) es: 835 = 8:35 (opzionale)</div>
    <input id="mRem" type="tel" inputmode="numeric" maxlength="3" placeholder="" />
  </div>

  <div style="margin-top:10px">
    <div class="pill">Quintetto attuale (opzionale ma consigliato se stato = IN CORSO)</div>
    <div id="mLineupLabel" class="muted2" style="font-size:12px;line-height:1.25">Non impostato</div>
    <button class="btnW" style="background:#222;color:#fff;border:1px solid #2e2e2e" onclick="openManualChoose5()">SCEGLI 5</button>
  </div>



  <div style="margin-top:10px">
    <div class="pill">Falli personali CASA (per giocatore)</div>
    <div id="mPfMyGrid" class="grid-players"></div>
  </div>

  <div style="margin-top:10px">
    <div class="pill">Falli personali TRASFERTA (per giocatore)</div>
    <div id="mPfOppGrid" class="grid-players"></div>
  </div>

  <div class="hr"></div>

  <label style="display:flex;gap:10px;align-items:center;font-weight:900;font-size:12px">
    <input id="mAsFirst" type="checkbox" />
    Inserisci come <b>primo evento</b> (consigliato se inizi a registrare da met√† partita)
  </label>

  <button class="btnW" style="background:var(--g);color:#fff" onclick="applyManualEdit()">APPLICA</button>
  <button class="btnW" style="background:#333;color:#fff" onclick="closeModal('modalManual')">ANNULLA</button>
</div></div>

<script>
/* ===================== CORE STATE ===================== */
/* ===================== MULTI-GAME STORAGE ===================== */
const GAMES_INDEX_KEY = 'BSP_V7_GAMES_INDEX';
const CURRENT_GAME_ID_KEY = 'BSP_V7_CURRENT_GAME_ID';
const LAST_GAME_ID_KEY = 'BSP_V7_LAST_GAME_ID';

// In viewer mode pu√≤ restare null (usa storage "classico")
let CURRENT_GAME_ID = null;

function storageKey(){
  return CURRENT_GAME_ID ? ('BSP_V7_GAME_' + CURRENT_GAME_ID) : 'BSP_V7_AUTOSAVE';
}

function loadGamesIndex(){
  if(isAuthed() && Array.isArray(CLOUD_GAMES_CACHE)) return CLOUD_GAMES_CACHE;
  try{ return JSON.parse(localStorage.getItem(GAMES_INDEX_KEY) || '[]'); }
  catch(e){ return []; }
}

function saveGamesIndex(list){
  try{ localStorage.setItem(GAMES_INDEX_KEY, JSON.stringify(list)); }catch(e){}
}
function normalizeGameName(name){
  return String(name||'').trim().toLowerCase().replace(/\s+/g,' ');
}
function makeGameId(name){
  const base = String(name||'').trim()
    .replace(/[^a-z0-9]+/gi,'_')
    .replace(/^_+|_+$/g,'')
    .slice(0,40) || 'partita';
  return base + '_' + Date.now();
}
function setCurrentGame(id){
  CURRENT_GAME_ID = id || null;
  try{
    if(CURRENT_GAME_ID){
      // Per evitare conflitti tra due tab aperti: usa sessionStorage (tab-specific)
      sessionStorage.setItem(CURRENT_GAME_ID_KEY, CURRENT_GAME_ID);
      // Mantieni anche l'ultima partita usata per il prossimo avvio
      localStorage.setItem(LAST_GAME_ID_KEY, CURRENT_GAME_ID);
    }else{
      sessionStorage.removeItem(CURRENT_GAME_ID_KEY);
    }
  }catch(e){}
}
function loadCurrentGameFromStorage(){
  try{
    // Prima prova il valore tab-specific
    let id = sessionStorage.getItem(CURRENT_GAME_ID_KEY);
    // Se non c'√®, usa l'ultima partita usata (persistente)
    if(!id) id = localStorage.getItem(LAST_GAME_ID_KEY) || localStorage.getItem(CURRENT_GAME_ID_KEY);
    CURRENT_GAME_ID = id || null;
    if(CURRENT_GAME_ID) sessionStorage.setItem(CURRENT_GAME_ID_KEY, CURRENT_GAME_ID);
  }catch(e){ CURRENT_GAME_ID = null; }
}
function touchCurrentGameUpdatedAt(){
  if(!CURRENT_GAME_ID) return;
  const games = loadGamesIndex();
  const g = games.find(x=>x.id===CURRENT_GAME_ID);
  if(g){
    g.updatedAt = Date.now();
    saveGamesIndex(games);
  }
}

function currentGameName(){
  if(!CURRENT_GAME_ID) return '';
  const games = loadGamesIndex();
  const g = games.find(x=>x.id===CURRENT_GAME_ID);
  return (g && g.name) ? String(g.name) : '';
}


function getSavedGameMeta(gameId){
  // Cloud: usa metadati gi√† in cache
  if(isAuthed() && Array.isArray(CLOUD_GAMES_CACHE)){
    const g = CLOUD_GAMES_CACHE.find(x=>String(x.id)===String(gameId));
    if(g) return { nameH:g.nameH, nameA:g.nameA, status:g.status, sH:g.sH, sA:g.sA };
  }
  // Locale: legge il salvataggio della partita e calcola: squadre, stato, punteggio
  try{
    const raw = localStorage.getItem('BSP_V7_GAME_' + String(gameId));
    if(!raw) return null;
    const d = JSON.parse(raw);
    const nameH = d.nameH || 'CASA';
    const nameA = d.nameA || 'TRASFERTA';
    const status = d.status || 'idle';
    const noi = d.noi || 'Home';
    const myIsHome = (noi === 'Home');
    const events = Array.isArray(d.events) ? d.events : [];

    let sH = 0, sA = 0;
    for(const ev of events){
      const p = ev && ev.payload ? ev.payload : {};
      if(ev.type === 'opp_point'){
        const v = Number(p.value) || 0;
        if(myIsHome) sA += v; else sH += v;
      }else if(ev.type === 'shot'){
        if(p.made){
          const v = Number(p.val) || 2;
          if(myIsHome) sH += v; else sA += v;
        }
      }else if(ev.type === 'ft'){
        if(p.made){
          if(myIsHome) sH += 1; else sA += 1;
        }
      }
    }

    return { nameH, nameA, status, sH, sA };
  }catch(e){
    return null;
  }
}


function renderHomeGames(){
  const host = document.getElementById('gamesList');
  if(!host) return;

  const list = loadGamesIndex().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
  if(!list.length){
    host.innerHTML = `<div class="muted2" style="font-size:12px">Nessuna partita salvata.</div>`;
    return;
  }

  host.innerHTML = list.map(g=>{
    const when = g.updatedAt ? new Date(g.updatedAt).toLocaleString() : '';
    const meta = getSavedGameMeta(g.id) || {};
    const th = meta.nameH || 'CASA';
    const ta = meta.nameA || 'TRASFERTA';
    const st = meta.status || 'idle';
    const sH = Number.isFinite(meta.sH) ? meta.sH : 0;
    const sA = Number.isFinite(meta.sA) ? meta.sA : 0;

    const ended = (st === 'ended');
    const stLabel = ended ? 'TERMINATA' : 'IN CORSO';
    const stColor = ended ? '#ff5252' : '#00e676';

    return `
      <div class="ev-item">
        <div class="ev-top">
          <div>
            <div class="ev-title">${esc(g.name||'Senza nome')}</div>
            <div class="ev-sub">${esc(th)} - ${esc(ta)}</div>
            <div class="ev-sub">
              <span style="color:${stColor};font-weight:1000">${stLabel}</span>
              <span style="color:#fff;font-weight:1000;margin-left:8px">${sH} - ${sA}</span>
            </div>
            <div class="ev-sub">Ultimo salvataggio: ${esc(when)}</div>
          </div>
          <div class="ev-actions" style="flex-wrap:wrap;justify-content:flex-end">
            <button class="b1" onclick="openGameById('${esc(g.id)}')">APRI</button>
            <button class="b1" style="background:#2b2b2b;color:#fff" onclick="renameGameById('${esc(g.id)}')">RINOMINA</button>
            <button class="b1" style="background:#3a1f1f;color:#fff" onclick="deleteGameById('${esc(g.id)}')">ELIMINA</button>
      	    <button class="btnA gry" onclick="copyLiveLink()">üì° LIVE LINK</button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function openGamesHome(){
  renderHomeGames();
  openModal("modalStartup");
}

async function renameGameById(id){
  id = String(id||'').trim();

  // Cloud
  if(isAuthed() && Array.isArray(CLOUD_GAMES_CACHE)){
    const cur = CLOUD_GAMES_CACHE.find(g=>g.id===id);
    if(!cur) return;

    const name = prompt('Nuovo nome partita:', cur.name || '');
    if(name === null) return;

    const n = String(name).trim();
    if(!n) return alert('Nome non valido');

    const norm = normalizeGameName(n);
    const dup = CLOUD_GAMES_CACHE.some(g => g.id !== id && g.normName === norm);
    if(dup) return alert('Esiste gi√† una partita con questo nome.');

    await cloudRenameGame(id, n);
    renderHomeGames();
    return;
  }

  // Locale
  const games = loadGamesIndex();
  const cur = games.find(g=>g.id===id);
  if(!cur) return;

  const name = prompt('Nuovo nome partita:', cur.name || '');
  if(name === null) return;

  const n = String(name).trim();
  if(!n) return alert('Nome non valido');

  const norm = normalizeGameName(n);
  const dup = games.some(g => g.id !== id && g.normName === norm);
  if(dup) return alert('Esiste gi√† una partita con questo nome.');

  cur.name = n;
  cur.normName = norm;
  cur.updatedAt = Date.now();
  saveGamesIndex(games);
  renderHomeGames();
}


async function deleteGameById(id){
  id = String(id||'').trim();

  // Cloud
  if(isAuthed() && Array.isArray(CLOUD_GAMES_CACHE)){
    const cur = CLOUD_GAMES_CACHE.find(g=>g.id===id);
    if(!cur) return;

    const label = cur.name || 'Senza nome';
    if(!confirm('Eliminare la partita "'+label+'"?\n\nQuesta azione non si pu√≤ annullare.')) return;

    await cloudDeleteGame(id);

    if(CURRENT_GAME_ID === id){
      setCurrentGame(null);
      initDefaults();
      bootstrapRosterData();
      renderRoster();
      updateUI();
    }

    renderHomeGames();
    return;
  }

  // Locale
  const games = loadGamesIndex();
  const cur = games.find(g=>g.id===id);
  if(!cur) return;

  const label = cur.name || 'Senza nome';
  if(!confirm(`Eliminare la partita "${label}"?

Questa azione non si pu√≤ annullare.`)) return;

  try{ localStorage.removeItem('BSP_V7_GAME_' + id); }catch(e){}

  const next = games.filter(g=>g.id!==id);
  saveGamesIndex(next);

  if(CURRENT_GAME_ID === id){
    setCurrentGame(null);

    initDefaults();
    bootstrapRosterData();
    renderRoster();
    updateUI();

    renderHomeGames();
    openModal('modalStartup');
  }else{
    renderHomeGames();
  }
}


async function newGameFlow(){
  const name = prompt('Nome partita (unico):');
  if(!name) return;

  const norm = normalizeGameName(name);

  // Se loggato: controlla duplicati su cache cloud
  if(isAuthed() && Array.isArray(CLOUD_GAMES_CACHE)){
    if(CLOUD_GAMES_CACHE.some(g=>g.normName===norm)){
      alert('Esiste gi√† una partita con questo nome ‚ùå');
      return;
    }
  }else{
    const games = loadGamesIndex();
    if(games.some(g=>g.normName===norm)){
      alert('Esiste gi√† una partita con questo nome ‚ùå');
      return;
    }
  }

  const id = makeGameId(name);

  // Cloud: crea entry indice
  if(isAuthed() && FB_DB){
    try{
      await cloudIndexRef().child(String(id)).set({
        name: String(name).trim(),
        normName: norm,
        createdAt: Date.now(),
        updatedAt: Date.now(),
        nameH: 'CASA',
        nameA: 'TRASFERTA',
        status: 'idle',
        sH: 0,
        sA: 0
      });
      await refreshCloudIndex();
    }catch(e){
      alert('Errore cloud index: '+(e && e.message ? e.message : e));
    }
  }else{
    // Locale: aggiorna indice
    const games = loadGamesIndex();
    games.push({
      id,
      name: String(name).trim(),
      normName: norm,
      createdAt: Date.now(),
      updatedAt: Date.now()
    });
    saveGamesIndex(games);
  }

  setCurrentGame(id);

  // reset stato base
  initDefaults();
  S.events=[];
  S.status='idle'; S.nQ=1;
  bootstrapRosterData();
  renderRoster();
  replay();
  updateUI();

  autosave(); // crea subito il salvataggio

  closeModal('modalStartup');
  openModal('modalSetup');
}


async function openGameById(id){
  setCurrentGame(id);

  // Cloud first (se loggato)
  if(isAuthed() && FB_DB){
    try{
      const state = await cloudLoadGame(id);
      if(state){
        localStorage.setItem(storageKey(), JSON.stringify(state));
        // anche chiave diretta (utile per funzioni legacy)
        localStorage.setItem('BSP_V7_GAME_' + String(id), JSON.stringify(state));
      }
    }catch(e){
      // fallback locale
    }
  }

  const ok = loadAutosave();
  closeModal('modalStartup');

  if(ok){
    replay();
    updateUI();
    setBtnState();
  }else{
    openModal('modalSetup');
  }
}

/* ===================== /MULTI-GAME STORAGE ===================== */

const S = {
  status:'idle', nQ:1,
  cloudId:'',
  quarterLenMin:10, otLenMin:5,
  noi:'Home', nameH:'CASA', nameA:'TRASFERTA',
  sH:0,sA:0, fH:0,fA:0, toH:0,toA:0,
  tH:0,tA:0, benchHomeSym:'', benchAwaySym:'', // team technical count (for icon only)
  myRoster:[], oppRoster:[],
  p:{}, opp:{}, // opp: { fouls, specials[] }
  expelled:new Set(),
  inC:[], selP:null,
  shotX:null, shotY:null, shotVal:2,
  selOpp:null,
  events:[],
  shots:[],
  stints:[]
};

let Spec = { type:'T', selHome:new Set(), selAway:new Set(), benchHome:false, benchAway:false };
let editId=null;
let editBenchHome=false, editBenchAway=false, editSelMy=new Set(), editSelOpp=new Set();
let statsSel='ALL';
let subAutoOut=null;

/* ===================== HELPERS ===================== */
const $=id=>document.getElementById(id);
const esc=s=>String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
const css=v=>getComputedStyle(document.documentElement).getPropertyValue(v).trim();
const flash=t=>{ document.body.classList.add('flash-'+t); setTimeout(()=>document.body.classList.remove('flash-'+t),150); };
const label=()=> (S.nQ>4?'OT':`Q${S.nQ}`);
const toLim=()=> (S.nQ<=2?2:(S.nQ<=4?3:1));
const lenSec=()=> ((S.nQ<=4?S.quarterLenMin:S.otLenMin)*60);
const fmt=sec=>{ sec=Math.max(0,Math.floor(sec||0)); const m=Math.floor(sec/60), s=sec%60; return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); };

/* ===================== KEEP SCREEN AWAKE ===================== */
// Screen Wake Lock API (quando disponibile). Su iOS/Safari funziona solo dopo un'interazione utente.
let wakeLock = null;
let wakeLockWanted = false;

async function enableWakeLock(){
  wakeLockWanted = true;
  try{
    if(!('wakeLock' in navigator)) return;
    if(document.visibilityState !== 'visible') return;
    // evita richieste duplicate
    if(wakeLock) return;
    wakeLock = await navigator.wakeLock.request('screen');
    wakeLock.addEventListener('release', ()=>{ wakeLock = null; });
  }catch(e){
    // se fallisce (permessi/unsupported) non bloccare l'app
    wakeLock = null;
  }
}

function disableWakeLock(){
  wakeLockWanted = false;
  try{ if(wakeLock){ wakeLock.release(); } }catch(e){}
  wakeLock = null;
}

function isGameRunning(){
  try{ return S && S.status==='playing'; }catch(e){ return false; }
}

function syncWakeLock(prevStatus, nextStatus){
  // Attiva solo durante la partita in corso (playing)
  const was = (prevStatus==='playing');
  const now = (nextStatus==='playing');
  if(!was && now){ enableWakeLock(); }
  if(was && !now){ disableWakeLock(); }
}
const pct=(m,a)=> a<=0?'0,00%':((m/a)*100).toFixed(2).replace('.',',')+'%';
const uid=()=> 'e'+Math.random().toString(16).slice(2)+Date.now().toString(16);


/* ===================== LIVE LINK / VIEWER MODE ===================== */
function qs(name){ return new URLSearchParams(location.search).get(name); }
const IS_VIEWER = qs('view') === '1';
let CLOUD_GAME_ID = qs('game') || null;
let FB_DB = null;
let FB_REF = null;
let FB_AUTH = null;
let AUTH_UID = null;
let AUTH_USER = null;
let CLOUD_GAMES_CACHE = null; // array di meta partite per utente

function isAuthed(){ return !!AUTH_UID; }

function cloudIndexRef(){ return FB_DB.ref('users/'+AUTH_UID+'/index'); }
function cloudGameRef(gameId){ return FB_DB.ref('users/'+AUTH_UID+'/games/'+String(gameId)); }

function calcScoreFromState(d){
  try{
    const noi = d.noi || 'Home';
    const myIsHome = (noi === 'Home');
    const events = Array.isArray(d.events) ? d.events : [];
    let sH=0, sA=0;
    for(const ev of events){
      const p = ev && ev.payload ? ev.payload : {};
      if(ev.type === 'opp_point'){
        const v = Number(p.value)||0;
        if(myIsHome) sA += v; else sH += v;
      }else if(ev.type === 'shot'){
        if(p.made){
          const v = Number(p.val)||2;
          if(myIsHome) sH += v; else sA += v;
        }
      }else if(ev.type === 'ft'){
        if(p.made){
          if(myIsHome) sH += 1; else sA += 1;
        }
      }
    }
    return {sH,sA};
  }catch(e){ return {sH:0,sA:0}; }
}

async function refreshCloudIndex(){
  if(!isAuthed() || !FB_DB) { CLOUD_GAMES_CACHE = null; return []; }
  const snap = await cloudIndexRef().once('value');
  const obj = snap.val() || {};
  const arr = [];
  for(const id of Object.keys(obj)){
    const meta = obj[id] || {};
    arr.push({
      id,
      name: meta.name || 'Senza nome',
      normName: meta.normName || normalizeGameName(meta.name || ''),
      createdAt: meta.createdAt || 0,
      updatedAt: meta.updatedAt || 0,
      nameH: meta.nameH || 'CASA',
      nameA: meta.nameA || 'TRASFERTA',
      status: meta.status || 'idle',
      sH: Number.isFinite(meta.sH) ? meta.sH : 0,
      sA: Number.isFinite(meta.sA) ? meta.sA : 0
    });
  }
  arr.sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
  CLOUD_GAMES_CACHE = arr;
  return arr;
}

async function cloudSaveGame(gameId, state){
  if(!isAuthed() || !FB_DB) return;
  const now = Date.now();
  // salva stato
  await cloudGameRef(gameId).set({ updatedAt: now, state: state });
  // upsert meta indice
  const sc = calcScoreFromState(state||{});
  const meta = {
    name: (currentGameName() || state?.title || state?.name || state?.gameName || (state?.nameH && state?.nameA ? (state.nameH+' - '+state.nameA) : 'Senza nome')),
    normName: normalizeGameName(currentGameName() || ''),
    updatedAt: now,
    nameH: state?.nameH || 'CASA',
    nameA: state?.nameA || 'TRASFERTA',
    status: state?.status || 'idle',
    sH: sc.sH,
    sA: sc.sA
  };
  // createdAt: se non esiste, mettilo
  const createdSnap = await cloudIndexRef().child(String(gameId)+'/createdAt').once('value');
  if(!createdSnap.exists()) meta['createdAt'] = now;
  await cloudIndexRef().child(String(gameId)).update(meta);
  // aggiorna cache locale
  try{ await refreshCloudIndex(); }catch(e){}
}

async function cloudLoadGame(gameId){
  if(!isAuthed() || !FB_DB) return null;
  const snap = await cloudGameRef(gameId).once('value');
  const v = snap.val();
  return (v && v.state) ? v.state : null;
}

async function cloudRenameGame(gameId, newName){
  if(!isAuthed() || !FB_DB) return;
  const now = Date.now();
  await cloudIndexRef().child(String(gameId)).update({
    name: newName,
    normName: normalizeGameName(newName),
    updatedAt: now
  });
  await refreshCloudIndex();
}

async function cloudDeleteGame(gameId){
  if(!isAuthed() || !FB_DB) return;
  await cloudGameRef(gameId).remove();
  await cloudIndexRef().child(String(gameId)).remove();
  await refreshCloudIndex();
}

async function signIn(){
  if(!initFirebase()) return;
  const prov = new firebase.auth.GoogleAuthProvider();
  try{
    await FB_AUTH.signInWithPopup(prov);
  }catch(e){
    try{ await FB_AUTH.signInWithRedirect(prov); }
    catch(err){ alert('Login fallito: '+(err && err.message ? err.message : err)); }
  }
}

async function signOutUser(){
  try{ await FB_AUTH.signOut(); }catch(e){}
}

function initFirebase(){
  const firebaseConfig = window.__FIREBASE_CONFIG__ || {
    apiKey: "AIzaSyAtJVAixoUVY3GMhoza7-UBnHMuKjLZjmE",
    authDomain: "basket-reggello-scout.firebaseapp.com",
    databaseURL: "https://basket-reggello-scout-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "basket-reggello-scout",
    storageBucket: "basket-reggello-scout.firebasestorage.app",
    messagingSenderId: "395815946220",
    appId: "1:395815946220:web:68c00b4c7f2da1754722c9",
    measurementId: "G-8DFL77TB65"
  };

  try{
    if(!firebase.apps.length){
      firebase.initializeApp(firebaseConfig);
    }
    FB_DB = firebase.database();
    FB_AUTH = firebase.auth();
    return true;
  }catch(e){
    alert("Firebase non configurato o non disponibile.");
    return false;
  }
}
function setSyncLabel(txt){
  const el = document.getElementById('syncStatus');
  if(el) el.textContent = txt;
}


function connectToCloud(gameId){
  if(!initFirebase()) return;
  CLOUD_GAME_ID = String(gameId||"").trim();
  if(!CLOUD_GAME_ID) return;
  FB_REF = FB_DB.ref("games/"+CLOUD_GAME_ID);
  setSyncLabel("LIVE: "+CLOUD_GAME_ID + (IS_VIEWER?" (VIEW)":""));

  // Viewer: ascolta e applica
  FB_REF.on("value", snap=>{
    const data=snap.val();
    if(!data || !data.state) return;
    try{
      localStorage.setItem(storageKey(), JSON.stringify(data.state));
      loadAutosave();
      replay();
      updateUI();

        const ms=document.getElementById('modalStats');
        if(ms && !ms.classList.contains('hidden')){
          renderStats();
        }
    }catch(e){}
  });
}

function cloudPush(stateObj){
  if(IS_VIEWER) return;
  if(!FB_REF) return;
  try{ FB_REF.set({updatedAt:Date.now(), state: stateObj}); }catch(e){}
}

async function copyLiveLink(){
  if(IS_VIEWER){
    const clean = location.origin+location.pathname;
    try{ await navigator.clipboard.writeText(clean); alert("Link base copiato ‚úÖ"); }catch(e){ prompt("Copia:", clean); }
    return;
  }
  if(!CLOUD_GAME_ID){
    const id = prompt("ID partita per LIVE (es. U15_vs_ABC_2026-01-14):");
    if(!id) return;
    connectToCloud(id);
  }
  const base = location.origin + location.pathname;
  const url = `${base}?view=1&game=${encodeURIComponent(CLOUD_GAME_ID)}`;
  try{ await navigator.clipboard.writeText(url); alert("Link copiato ‚úÖ\n\n"+url); }
  catch(e){ prompt("Copia il link:", url); }
}

function manualSave(){ autosave(); alert("Salvato ‚úÖ"); }
function hasAutosave(){ try{ return !!localStorage.getItem(storageKey()); }catch(e){ return false; } }
function restoreAutosave(){ closeModal("modalStartup"); loadAutosave(); replay(); updateUI(); }
function startNewGame(){
  try{ localStorage.removeItem(storageKey()); }catch(e){}
  const clean = location.origin + location.pathname;
  if(location.search){ try{ history.replaceState({}, "", clean); }catch(e){} }
  closeModal("modalStartup");
  openModal("modalSetup");
}

function addSym(s,ch){ s=String(s||""); return s.includes(ch)?s:(s+ch); }


function openModal(id){
  if(id==='modalFalliCheck') refreshFoulsCheck();
  if(id==='modalEvents') renderEvents();
  if(id==='modalSetup') fillSetupUI();
  document.getElementById(id).classList.remove('hidden');
}
function closeModal(id){
  document.getElementById(id).classList.add('hidden');
  // Se un'azione ha aperto un modal (tiro/liberi/fallo subito), al termine deselection
  if(__DESEL_AFTER_MODAL){
    __DESEL_AFTER_MODAL = false;
    clearSelectedPlayer();
  }
}

function parseMSS(raw){
  const d=String(raw||'').replace(/\D/g,'').slice(0,3);
  if(d.length!==3) return {ok:false,digits:d,rem:null};
  const m=parseInt(d[0],10), ss=parseInt(d.slice(1),10);
  if(Number.isNaN(m)||Number.isNaN(ss)||ss>59) return {ok:false,digits:d,rem:null};
  return {ok:true,digits:d,rem:m*60+ss};
}

/* ===================== SETUP / ROSTERS ===================== */
function initDefaults(){
  S.myRoster=[
{num:'00',name:'FOSSATI MATTEO'},{num:'1',name:'CAINI GABRIELE'},{num:'3',name:'FALCHI ANDREA'},
{num:'11',name:'BOGANI GUGLIELMO'},{num:'12',name:'BACHERINI LEONE'},{num:'13',name:'GIUSTI COSIMO'},
{num:'14',name:'CELLAI CHRISTIAN'},{num:'20',name:'NOCENTINI PIETRO'},{num:'21',name:'SERRAVALLI VIERI'},
{num:'23',name:'MINI PIETRO'},{num:'31',name:'POMA IAGO'},{num:'40',name:'DELCHI RICCARDO'}
      ];
  S.oppRoster=[];
  bootstrapRosterData();
}

function bootstrapRosterData(){
  S.p={};
  S.expelled=new Set();
  S.myRoster.forEach(pl=>{
    S.p[pl.num]={
      pts:0,fouls:0,
      twoM:0,twoA:0, threeM:0,threeA:0, ftM:0,ftA:0,
      foulMade:0,foulSuf:0,to:0,stl:0,ro:0,rd:0,
      specials:[], // history
      tCount:0, uCount:0 // for automatic expulsion rule
    };
  });
  S.opp={};
  S.oppRoster.forEach(n=>{
    S.opp[n]={ fouls:0, specials:[], tCount:0, uCount:0, expelled:false };
  });
}

function parseMyTeam(t){
  const lines=String(t||'').split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const nums=[],map={};
  lines.forEach(line=>{
    const parts=line.split(',').map(x=>x.trim()).filter(Boolean);
    const num=(parts[0]||'').replace(/\D/g,''); if(!num) return;
    const n=String(parseInt(num,10)); nums.push(n);
    map[n]=(parts.slice(1).join(' ')||'').toUpperCase();
  });
  const seen=new Set(), uniq=[]; nums.forEach(n=>{ if(!seen.has(n)){seen.add(n);uniq.push(n)} });
  return uniq.map(n=>({num:n,name:map[n]||''}));
}
function parseOppTeam(t){
  const lines=String(t||'').split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const nums=[];
  lines.forEach(line=>{ const num=line.replace(/\D/g,''); if(!num) return; nums.push(String(parseInt(num,10))); });
  const seen=new Set(), uniq=[]; nums.forEach(n=>{ if(!seen.has(n)){seen.add(n);uniq.push(n)} });
  return uniq;
}




function normalizePlayerNum(rawDigits){
  var d = String(rawDigits||'').replace(/\D/g,'');
  if(!d) return '';
  if(d === '00') return '00';
  if(d === '0') return '0';
  // per altri numeri rimuovi zeri iniziali
  var n = parseInt(d,10);
  if(isNaN(n)) return '';
  return String(n);
}

function addMyRow(num, name){
  var box = $('myTeamRows');
  if(!box) return;
  var row = document.createElement('div');
  row.style.display='grid';
  row.style.gridTemplateColumns='90px 1fr 44px';
  row.style.gap='8px';
  row.style.alignItems='center';
  row.style.marginBottom='8px';

  var inNum = document.createElement('input');
  inNum.type='text';
  inNum.inputMode='numeric';
  inNum.placeholder='NUM';
  inNum.className='myNum';
  inNum.value = num||'';

  var inName = document.createElement('input');
  inName.type='text';
  inName.placeholder='NOME';
  inName.className='myName';
  inName.value = name||'';

  var del = document.createElement('button');
  del.type='button';
  del.className='btnW';
  del.textContent='‚úñ';
  del.style.background='#333';
  del.style.color='#fff';
  del.style.padding='10px 0';
  del.onclick=function(){ row.remove(); };

  row.appendChild(inNum);
  row.appendChild(inName);
  row.appendChild(del);
  box.appendChild(row);
}

function buildMyTeamRowsFromRoster(roster){
  var box = $('myTeamRows');
  if(!box) return;
  box.innerHTML='';
  var list = Array.isArray(roster) ? roster : [];
  if(!list.length){
    for(var i=0;i<12;i++) addMyRow('','');
    return;
  }
  for(var j=0;j<list.length;j++){
    var pl=list[j]||{};
    addMyRow(pl.num||'', pl.name||'');
  }
}

function getMyTeamFromRows(){
  var box = $('myTeamRows');
  if(!box) return [];
  var nums = Array.prototype.slice.call(box.querySelectorAll('input.myNum'));
  var names = Array.prototype.slice.call(box.querySelectorAll('input.myName'));
  var out=[];
  var m = Math.min(nums.length, names.length);
  for(var i=0;i<m;i++){
    var dn = normalizePlayerNum(nums[i].value);
    if(!dn) continue;
    var nm = String(names[i].value||'').trim().toUpperCase();
    out.push({num:dn, name:nm});
  }
  // unique by number (keep first)
  var seen={};
  var uniq=[];
  for(var k=0;k<out.length;k++){
    var key=String(out[k].num);
    if(seen[key]) continue;
    seen[key]=1;
    uniq.push(out[k]);
  }
  return uniq;
}

function fillSetupUI(){
  try{ $('quarterLenSel').value = String(S.quarterLenMin||10); }catch(e){}
  try{ $('otLenSel').value = String(S.otLenMin||5); }catch(e){}
  try{ $('noiSel').value = (S.noi==='Away'?'Away':'Home'); }catch(e){}

  if($('teamHomeName')) $('teamHomeName').value = String(S.nameH||'CASA');
  if($('teamAwayName')) $('teamAwayName').value = String(S.nameA||'TRASFERTA');

  buildMyTeamRowsFromRoster(S.myRoster||[]);
  if($('oppTeamInput')) $('oppTeamInput').value = (S.oppRoster||[]).map(String).join('\n');

  var cloudInp = $('cloudIdInput');
  if(cloudInp){
    var desired = String(S.cloudId||'').trim();
    if(!desired){ desired = String(currentGameName()||'').trim(); }
    if(desired){ cloudInp.value = desired; }
  }
}

function connectCloudFromSetup(){
  const inp = document.getElementById('cloudIdInput');
  const id = (inp ? inp.value : '').trim();
  if(!id){ alert('Inserisci un ID partita'); return; }
  S.cloudId = id;
  try{ autosave(); }catch(e){}
  connectToCloud(id);
  try{ localStorage.setItem('BSP_CLOUD_GAME_ID', id); }catch(e){}
  alert('Cloud connesso ‚úÖ\nOra puoi usare üì° LIVE LINK');
}

function applySetup(){
  S.quarterLenMin=parseInt($('quarterLenSel').value,10)||10;
  S.otLenMin=parseInt($('otLenSel').value,10)||5;
  S.noi=$('noiSel').value==='Away'?'Away':'Home';

  // Nomi squadre (2 campi)
  var h = ($('teamHomeName') ? $('teamHomeName').value : '').trim();
  var a = ($('teamAwayName') ? $('teamAwayName').value : '').trim();
  S.nameH = h || 'CASA';
  S.nameA = a || 'TRASFERTA';

  // Roster mia squadra: da righe (fallback al legacy textarea se presente)
  var my = getMyTeamFromRows();
  if(!my.length && $('myTeamInput')) my = parseMyTeam($('myTeamInput').value);

  var opp = parseOppTeam($('oppTeamInput').value);

  if(my.length) S.myRoster=my;
  if(opp.length) S.oppRoster=opp;

  // keep events, then replay with new rosters
  bootstrapRosterData();
  renderRoster();
  replay();
  autosave();
  closeModal('modalSetup');
}

function resetAll(){
  if(!confirm('Reset totale? Cancella eventi e punteggi.')) return;
  localStorage.removeItem(storageKey());
  location.reload();
}

/* ===================== UI RENDER ===================== */
function setBtnState(){
  const b=$('btnStato');
  if(S.status==='ended'){ b.textContent='FINITA'; b.style.background='#333'; return; }
  if(S.status==='idle'){ b.textContent=`INIZIA ${label()}`; b.style.background=css('--g'); }
  else { b.textContent=`FINE ${label()}`; b.style.background=css('--r'); }
}

function renderDots(id,used){
  const c=$(id); c.innerHTML='';
  const lim=toLim();
  const u=Math.max(0,Math.min(used,lim));
  for(let i=0;i<lim;i++){
    const d=document.createElement('div');
    d.className='dot'+(i<u?' filled':'');
    c.appendChild(d);
  }
}

function renderRoster(){
  const g=$('rosterGrid'); g.innerHTML='';
  // ordine: 5 in campo -> CAMBIO -> panchina
  const inSet=new Set((S.inC||[]).map(String));
  const starters=(S.inC||[]).map(String)
    .map(n=>S.myRoster.find(p=>String(p.num)===String(n)))
    .filter(Boolean);

  const bench=S.myRoster.filter(p=>!inSet.has(String(p.num)));

  const ordered=[...starters];

  // inserisci il tasto CAMBIO come 6¬∞ (seconda riga, terza colonna) se ho almeno 5 in campo
  if(starters.length>=5){
    ordered.push({__type:'cambio'});
  }

  ordered.push(...bench);

  ordered.forEach(pl=>{
    if(pl && pl.__type==='cambio'){
      const b=document.createElement('button');
      b.className='player-card cambio';
      b.id='btnCambioGrid';
      b.innerHTML=`
        <div class="pname">CAMBIO</div>
        <div class="pnum">üîÑ</div>
        <div class="bpts"> </div>
        <div class="bmid"> </div>
        <div class="bf"> </div>
      `;
      b.onclick=()=>openSub();
      g.appendChild(b);
      return;
    }

    const n=String(pl.num);
    const st=S.p[n]||{pts:0,fouls:0,specials:[]};
    const sym=(st.specials||[]).join('');
    const b=document.createElement('button');
    b.className='player-card'; b.id='p'+n;
    b.innerHTML=`
      <div class="pname">${esc(pl.name||'')}</div>
      <div class="pnum">${esc(n)}</div>
      <div class="bpts" id="pts${n}">${st.pts||0}</div>
      <div class="bmid" id="sym${n}">${esc(sym)}</div>
      <div class="bf" id="foul${n}">${st.fouls||0}</div>
    `;
    b.onclick=()=>selectPlayer(n);
    g.appendChild(b);
  });
  updateUI();
}

function updateUI(){
  $('nameH').textContent=S.nameH;
  $('nameA').textContent=S.nameA;

  $('scoreHome').textContent=S.sH;
  $('scoreAway').textContent=S.sA;

  $('sfHome').textContent=S.fH;
  $('sfAway').textContent=S.fA;

    // bench technical foul badges (FIBA: non contano come falli di squadra)
  const th=$('techHome');
  if(th){
    th.textContent = 'T'.repeat(Math.max(0, Number(S.tH)||0));
    th.classList.toggle('hidden', !(Number(S.tH)>0));
  }
  const ta=$('techAway');
  if(ta){
    ta.textContent = 'T'.repeat(Math.max(0, Number(S.tA)||0));
    ta.classList.toggle('hidden', !(Number(S.tA)>0));
  }

  $('labelPeriodo').textContent=label();

  // BONUS FIBA: dal 4¬∞ fallo
  $('bHome').style.display = S.fH >= 4 ? 'block' : 'none';
  $('bAway').style.display = S.fA >= 4 ? 'block' : 'none';

  // update roster cards
  S.myRoster.forEach(pl=>{
    const n=pl.num;
    const st=S.p[n];
    const btn=$('p'+n); if(!btn) return;

    $('pts'+n).textContent=st.pts;
    $('foul'+n).textContent=st.fouls;
    $('sym'+n).textContent=(st.specials||[]).join('');

    btn.classList.toggle('in', S.inC.includes(n));
    btn.classList.toggle('sel', S.selP===n);

    const fouledOut = st.fouls>=5;
    const expelled = S.expelled.has(n);
    btn.classList.toggle('dis', fouledOut || expelled);
  });

  if(S.selP && !S.inC.includes(S.selP)) S.selP=null;

  $('azioni').style.display = (S.status==='playing' && S.inC.length===5) ? 'block' : 'none';

  renderDots('dotsHome', S.toH);
  renderDots('dotsAway', S.toA);

  setBtnState();
}

function selectPlayer(n){
  n=String(n);
  if(IS_VIEWER) return; // viewer = sola lettura
  if(S.status!=='playing') return;
  if(!S.inC.includes(n)) return;
  if(S.p[n]?.fouls>=5) return;
  if(S.expelled.has(n)) return;

  // selezione giocatore
  S.selP = (S.selP===n) ? null : n;
  updateUI();

  // se ho appena selezionato un giocatore, apro la schermata azioni
  if(S.selP){
    openActionScreen(S.selP);
  }
}



/* ===================== ACTION SCREEN ===================== */
function getPlayerLabel(num){
  const n=String(num);
  const pl=(S.myRoster||[]).find(p=>String(p.num)===n);
  if(!pl) return n;
  const name=(pl.name||'').trim();
  return name ? `${n} ‚Ä¢ ${name}` : n;
}

function openActionScreen(num){
  if(IS_VIEWER) return;

  // ‚úÖ Tablet: NON aprire overlay fullscreen, lasciamo solo #azioni
  if(document.body.classList.contains('tablet')){
    // aggiorno comunque l‚Äôetichetta (opzionale)
    const lab = document.getElementById('actionPlayerLabel');
    if(lab) lab.textContent = getPlayerLabel(num);
    return;
  }

  const el=document.getElementById('actionScreen');
  if(!el) return;
  document.getElementById('actionPlayerLabel').textContent = getPlayerLabel(num);
  el.classList.remove('hidden');
  document.body.classList.add('noScroll');
}


let __DESEL_AFTER_MODAL = false;

function clearSelectedPlayer(){
  S.selP=null;
  updateUI();
}

function closeActionScreen(){
  const el=document.getElementById('actionScreen');
  if(!el) return;
  el.classList.add('hidden');
  document.body.classList.remove('noScroll');
}

function actionQuick(type){
  if(!S.selP) return;
  addEventQuick(type);
  closeActionScreen();
  clearSelectedPlayer();
}
function actionFoulMade(){
  if(!S.selP) return;
  addEventFoulMade();
  closeActionScreen();
  clearSelectedPlayer();
}
function actionFoulSuffered(){
  if(!S.selP) return;
  __DESEL_AFTER_MODAL = true;
  openFoulSuffered();
  closeActionScreen();
}
function actionFT(){
  if(!S.selP) return;
  __DESEL_AFTER_MODAL = true;
  openFT();
  closeActionScreen();
}
function actionShot(){
  if(!S.selP) return;
  __DESEL_AFTER_MODAL = true;
  openModal('modalTiro');
  closeActionScreen();
}
/* ===================== PERIOD FLOW ===================== */
function togglePeriodo(){
  if(S.status==='ended') return;
  if(S.status==='idle'){
    S.choose5Sel = new Set();
    buildChoose5();
    openModal('modalChoose5');
    return;
  }
  $('endPeriodTitle').textContent = `FINE PERIODO ${label()}`;
  openModal('modalEndPeriod');
}

function buildChoose5(){
  const grid=$('choose5Grid'); grid.innerHTML='';
  S.myRoster.forEach(pl=>{
    const n=pl.num;
    const st=S.p[n];
    const b=document.createElement('button');
    b.className='player-card'; b.dataset.num=n;
    b.innerHTML=`
      <div class="pname">${esc(pl.name||'')}</div>
      <div class="pnum">${esc(n)}</div>
      <div class="bf">${st.fouls||0}</div>
    `;
    const disabled=(st.fouls>=5)||S.expelled.has(n);
    if(disabled) b.classList.add('dis');
    else b.onclick=()=>{
      if(S.choose5Sel.has(n)){S.choose5Sel.delete(n);b.classList.remove('sel')}
      else{ if(S.choose5Sel.size>=5) return; S.choose5Sel.add(n);b.classList.add('sel') }
      updateConfirm5();
    };
    grid.appendChild(b);
  });
  updateConfirm5();
}
function updateConfirm5(){
  const c=$('btnConfirm5');
  const k=S.choose5Sel.size;
  c.textContent=`CONFERMA (${k}/5)`;
  c.disabled=(k!==5);
  c.style.background=(k===5)?css('--g'):'grey';
}
function cancelChoose5(){
  closeModal('modalChoose5');
  S.choose5Sel=new Set();
  S.status='idle'; S.inC=[]; S.selP=null;
  updateUI();
}
function confirm5(){
  if(S.choose5Sel.size!==5) return;
  closeModal('modalChoose5');
  addEvent({type:'start_period', payload:{ nQ:S.nQ, lineup:[...S.choose5Sel], periodLenSec:lenSec() }});
}
function nextPeriod(){ closeModal('modalEndPeriod'); addEvent({type:'end_period', payload:{ nQ:S.nQ, action:'next' }}); }
function endGame(){ closeModal('modalEndPeriod'); addEvent({type:'end_period', payload:{ nQ:S.nQ, action:'end_game' }}); }

/* ===================== SHOT UI ===================== */
function setupCourt(){
  const court=$('shotCourt');
  court.addEventListener('click',e=>{
    const r=court.getBoundingClientRect();
    // Coordinate normalizzate (310x240) indipendenti da zoom/scala del device
    const rx = (e.clientX - r.left);
    const ry = (e.clientY - r.top);
    const nx = Math.round(rx * 310 / r.width);
    const ny = Math.round(ry * 240 / r.height);
    S.shotX = nx;
    S.shotY = ny;

    const cx = 310/2, hy = 30;
    const d = Math.hypot(nx - cx, ny - hy);
    S.shotVal = (d>130 || (ny<hy && (nx<20 || nx>310-20))) ? 3 : 2;
    $('shotInfo').textContent=`Tiro da ${S.shotVal} punti`;

    court.querySelectorAll('.mark').forEach(x=>x.remove());
    const m=document.createElement('div');
    m.className='mark';
    m.style.left=rx+'px';
    m.style.top=ry+'px';
    m.style.background=(S.shotVal===3)?'#ffeb3b':'#ff4444';
    court.appendChild(m);
  });
}
function closeShotModal(){
  closeModal('modalTiro');
  S.shotX=null; S.shotY=null; S.shotVal=2;
  clearSelectedPlayer();
}

/* ===================== EVENT SOURCING ===================== */
function addEvent(e){
  const ev={ id:uid(), ts:Date.now(), type:e.type, payload:e.payload||{} };
  S.events.push(ev);
  replay();
  autosave();

  // if my player expelled in this event and is in court => openSub
  if(ev.type==='special_foul'){
    const out = (ev.payload.targets||[]).filter(t=>t.team==='my' && t.kind==='D' && t.num).map(t=>String(t.num));
    const first = out.find(n=>S.inC.includes(n));
    if(first) openSub(first);
  }
}

function undoLast(){
  if(!S.events.length) return;
  S.events.pop();
  replay();
  autosave();
}

function replay(){
  // Se cambiano status o quintetto in campo, devo ricostruire la griglia giocatori
  const __prevStatus = S.status;
  const __prevInCKey = (S.inC||[]).map(String).join(',');
  // derived scratch
  const base={
    status:'idle', nQ:1,
    sH:0,sA:0, fH:0,fA:0, toH:0,toA:0,
    tH:0,tA:0,
    inC:[], selP:null,
    p:{}, opp:{}, expelled:new Set(),
    shots:[], stints:[],
    lineups:{}, lineupStints:[], curLKey:null
  };

  // init from current rosters
  S.myRoster.forEach(pl=>{
    base.p[pl.num]={
      pm:0,
      pts:0,fouls:0,
      twoM:0,twoA:0, threeM:0,threeA:0, ftM:0,ftA:0,
      foulMade:0,foulSuf:0,to:0,stl:0,ro:0,rd:0,
      specials:[], tCount:0, uCount:0
    };
  });
  S.oppRoster.forEach(n=>{
    base.opp[n]={ fouls:0, specials:[], tCount:0, uCount:0, expelled:false };
  });

  const myIsHome=(S.noi==='Home');

  const incTeamFoulMy=()=>{ if(myIsHome) base.fH++; else base.fA++; };
  const incTeamFoulOpp=()=>{ if(myIsHome) base.fA++; else base.fH++; };
  const addScoreMy=v=>{ if(myIsHome) base.sH+=v; else base.sA+=v; };
  const addScoreOpp=v=>{ if(myIsHome) base.sA+=v; else base.sH+=v; };

  // PLUS/MINUS: aggiorna tutti i giocatori attualmente in campo
  const addPMMy=(v)=>{
    const val=Number(v)||0;
    for(const pl of base.inC){ if(base.p[pl]) base.p[pl].pm += val; }
  };
  const addPMOpp=(v)=>{
    const val=Number(v)||0;
    for(const pl of base.inC){ if(base.p[pl]) base.p[pl].pm -= val; }
  };
  // QUINTETTI: key stabile (numeri ordinati) e accumulo stats per quintetto
  const lineupKey=(arr)=> (Array.isArray(arr)?arr:[]).map(String).slice(0,5).sort((a,b)=>Number(a)-Number(b)).join('-');
  const getL=(key, lineupArr)=>{
    if(!key) return null;
    if(!base.lineups[key]){
      base.lineups[key]={
        key, lineup:(lineupArr||[]).map(String).slice(0,5),
        pf:0, pa:0,
        twoM:0,twoA:0,threeM:0,threeA:0,ftM:0,ftA:0,
        to:0, stl:0, foulMade:0, foulSuf:0, ro:0, rd:0,
        sec:0
      };
    }
    return base.lineups[key];
  };
  const closeOpenLineupStint=(q,outRem)=>{
    for(let i=base.lineupStints.length-1;i>=0;i--){
      const s=base.lineupStints[i];
      if(s.q===q && s.outRem===null){ s.outRem=outRem; break; }
    }
  };

  const timeoutLimitFor=nQ=> (nQ<=2)?2:(nQ<=4?3:1);
  const periodLenSecFor=nQ=> ((nQ<=4?S.quarterLenMin:S.otLenMin)*60);

  function closeOpenStint(player,q,outRem){
    for(let i=base.stints.length-1;i>=0;i--){
      const s=base.stints[i];
      if(s.player===player && s.q===q && s.outRem===null){ s.outRem=outRem; break; }
    }
  }

  function applyAutoExpulsionIfNeeded(player){
    const st=base.p[player];
    if(!st) return;
    const exp = (st.tCount>=2) || (st.uCount>=2) || (st.tCount>=1 && st.uCount>=1);
    if(exp) base.expelled.add(player);
  }

  function applyAutoExpulsionIfNeededOpp(num){
    const st=base.opp[num];
    if(!st) return;
    const exp = (st.tCount>=2) || (st.uCount>=2) || (st.tCount>=1 && st.uCount>=1);
    if(exp) st.expelled=true;
  }

  for(const ev of S.events){
    const p=ev.payload||{};
    switch(ev.type){
      case 'start_period':{
        const nQ=Number(p.nQ)||base.nQ;
        base.nQ=nQ;
        base.status='playing';
        // reset team fouls at new period
        base.fH=0; base.fA=0;
        base.tH=0; base.tA=0;

        const lineup=(Array.isArray(p.lineup)?p.lineup:[]).map(String).slice(0,5);
        base.inC=lineup;
        base.curLKey = lineupKey(base.inC);
        const rem=Number(p.periodLenSec)||periodLenSecFor(base.nQ);
        // lineup stint (quintetto)
        base.lineupStints.push({key:base.curLKey, lineup:base.inC.slice(), q:base.nQ, inRem:rem, outRem:null});
        for(const pl of base.inC){
          base.stints.push({player:pl,q:base.nQ,inRem:rem,outRem:null});
        }
        break;
      }

      case 'manual_set':{
        // Impostazione manuale (baseline) per iniziare a partita in corso
        const nQ = Number(p.nQ) || base.nQ;
        base.nQ = nQ;
        const st = (p.status==='playing' || p.status==='idle' || p.status==='ended') ? p.status : base.status;
        base.status = st;

        // punteggio / falli / timeout / tecnici panchina
        base.sH = Math.max(0, Number(p.sH) || 0);
        base.sA = Math.max(0, Number(p.sA) || 0);
        base.fH = Math.max(0, Number(p.fH) || 0);
        base.fA = Math.max(0, Number(p.fA) || 0);
        base.toH = Math.max(0, Number(p.toH) || 0);
        base.toA = Math.max(0, Number(p.toA) || 0);
        base.tH = Math.max(0, Number(p.tH) || 0);
        base.tA = Math.max(0, Number(p.tA) || 0);



        // falli personali (baseline)
        if(p.pfMy && typeof p.pfMy==='object'){
          for(const k in p.pfMy){
            const num = String(k);
            if(base.p[num]) base.p[num].fouls = Math.max(0, Number(p.pfMy[k])||0);
          }
        }
        if(p.pfOpp && typeof p.pfOpp==='object'){
          for(const k in p.pfOpp){
            const num = String(k);
            if(base.opp[num]) base.opp[num].fouls = Math.max(0, Number(p.pfOpp[k])||0);
          }
        }

        // lineup (opzionale) + stints (opzionale)
        const lineup = (Array.isArray(p.lineup) ? p.lineup : []).map(String).slice(0,5);
        if(lineup.length===5){
          base.inC = lineup;
          base.curLKey = lineupKey(base.inC);
          // se gioco in corso, creo stints "aperti" con tempo rimanente
          if(base.status==='playing'){
            const rem = Number(p.remSec);
            const remOk = Number.isFinite(rem) ? Math.max(0, rem) : periodLenSecFor(base.nQ);
            base.lineupStints.push({key:base.curLKey, lineup:base.inC.slice(), q:base.nQ, inRem:remOk, outRem:null});
            for(const pl of base.inC){
              base.stints.push({player:pl,q:base.nQ,inRem:remOk,outRem:null});
            }
          }
        }
        // stints: in JS non posso usare 'for ... :', patch below
        break;
      }
      case 'end_period':{
        const q=Number(p.nQ)||base.nQ;
        closeOpenLineupStint(q,0);
        for(const pl of base.inC) closeOpenStint(pl,q,0);

        if(p.action==='end_game'){
          base.status='ended';
          base.inC=[];
        }else{
          if(base.nQ===2){ base.toH=0; base.toA=0; }
          if(base.nQ>=4){ base.toH=0; base.toA=0; }
          base.nQ+=1;
          base.status='idle';
          base.inC=[];
        }
        break;
      }
      case 'opp_point':{
        const v = Number(p.value)||0;
        addScoreOpp(v);
        addPMOpp(v);
        const lk=base.curLKey || lineupKey(base.inC);
        const L=getL(lk, base.inC);
        if(L) L.pa += v;
        break;
      }
      case 'timeout':{
        const lim=timeoutLimitFor(base.nQ);
        if(p.team==='Home') base.toH=Math.min(base.toH+1,lim);
        else base.toA=Math.min(base.toA+1,lim);
        break;
      }
      case 'quick':{
        const pl=String(p.player||''); if(!base.p[pl]) break;
        if(p.kind==='reb_def') base.p[pl].rd++;
        if(p.kind==='reb_off') base.p[pl].ro++;
        if(p.kind==='turnover') base.p[pl].to++;
        if(p.kind==='steal') base.p[pl].stl++;
        const lk=base.curLKey || lineupKey(base.inC);
        const L=getL(lk, base.inC);
        if(L){
          if(p.kind==='reb_def') L.rd++;
          if(p.kind==='reb_off') L.ro++;
          if(p.kind==='turnover') L.to++;
          if(p.kind==='steal') L.stl++;
        }
        break;
      }
      case 'foul_made':{
        const pl=String(p.player||''); if(!base.p[pl]) break;
        base.p[pl].fouls++; base.p[pl].foulMade++;
        incTeamFoulMy();
        const lk=base.curLKey || lineupKey(base.inC);
        const L=getL(lk, base.inC);
        if(L) L.foulMade++;
        break;
      }
      case 'foul_suf':{
        const my=String(p.myPlayer||'');
        const opp=String(p.oppPlayer||'');
        if(base.p[my]) base.p[my].foulSuf++;
        if(base.opp[opp]) base.opp[opp].fouls++;
        incTeamFoulOpp();
        const lk=base.curLKey || lineupKey(base.inC);
        const L=getL(lk, base.inC);
        if(L) L.foulSuf++;
        break;
      }
      case 'shot':{
        const pl=String(p.player||''); if(!base.p[pl]) break;
        const val=Number(p.val)||2;
        const made=!!p.made;
        if(val===2){ base.p[pl].twoA++; if(made) base.p[pl].twoM++; }
        else { base.p[pl].threeA++; if(made) base.p[pl].threeM++; }
        base.shots.push({player:pl,val,made,x:Number(p.x),y:Number(p.y)});
        const lk=base.curLKey || lineupKey(base.inC);
        const L=getL(lk, base.inC);
        if(L){
          if(val===2){ L.twoA++; if(made) L.twoM++; }
          else { L.threeA++; if(made) L.threeM++; }
          if(made) L.pf += val;
        }
        if(made){ base.p[pl].pts+=val; addScoreMy(val); addPMMy(val); }
        break;
      }
      case 'ft':{
        const pl=String(p.player||''); if(!base.p[pl]) break;
        const made=!!p.made;
        base.p[pl].ftA++;
        const lk=base.curLKey || lineupKey(base.inC);
        const L=getL(lk, base.inC);
        if(L){ L.ftA++; if(made) L.ftM++; if(made) L.pf += 1; }
        if(made){ base.p[pl].ftM++; base.p[pl].pts++; addScoreMy(1); addPMMy(1); }
        break;
      }
      case 'sub':{
        const q=Number(p.nQ)||base.nQ;
        const rem=Number(p.remSec);
        const outs=(Array.isArray(p.outs)?p.outs:[]).map(String);
        const ins=(Array.isArray(p.ins)?p.ins:[]).map(String);
        if(!Number.isFinite(rem)) break;

        // chiudo stint quintetto corrente al tempo del cambio
        closeOpenLineupStint(q,rem);

        for(const pl of outs){ closeOpenStint(pl,q,rem); base.inC=base.inC.filter(x=>x!==pl); }
        for(const pl of ins){
          if(!base.inC.includes(pl)) base.inC.push(pl);
          base.stints.push({player:pl,q,inRem:rem,outRem:null});
        }

        // apro nuovo stint quintetto
        base.curLKey = lineupKey(base.inC);
        base.lineupStints.push({key:base.curLKey, lineup:base.inC.slice(), q, inRem:rem, outRem:null});
        break;
      }
      case 'special_foul':{
        const kind=String(p.kind||'T'); // T U D
        const targets=Array.isArray(p.targets)?p.targets:[];
        for(const t of targets){
          // bench technical count icon only (no player expulsion rule)
          if(t.team==='bench_home'){
            if(kind==='T' || kind==='D') base.benchHomeSym = addSym(base.benchHomeSym, kind);
            if(kind==='T') base.tH++; // tecnico panchina CASA (non √® fallo di squadra)
          }
          if(t.team==='bench_away'){
            if(kind==='T' || kind==='D') base.benchAwaySym = addSym(base.benchAwaySym, kind);
            if(kind==='T') base.tA++; // tecnico panchina TRASFERTA (non √® fallo di squadra)
          }

          if(t.team==='my' && t.num && base.p[String(t.num)]){
            const n=String(t.num);
            base.p[n].fouls++;
            base.p[n].foulMade++;
            incTeamFoulMy();

            if(kind==='T'){ base.p[n].tCount++; base.p[n].specials.push('T'); }
            if(kind==='U'){ base.p[n].uCount++; base.p[n].specials.push('U'); }
            if(kind==='D'){ base.p[n].specials.push('D'); base.expelled.add(n); }

            applyAutoExpulsionIfNeeded(n);
          }

          if(t.team==='opp' && t.num && base.opp[String(t.num)]){
            const n=String(t.num);
            base.opp[n].fouls++;
            incTeamFoulOpp();

            if(kind==='T'){ base.opp[n].tCount++; base.opp[n].specials.push('T'); }
            if(kind==='U'){ base.opp[n].uCount++; base.opp[n].specials.push('U'); }
            if(kind==='D'){ base.opp[n].specials.push('D'); base.opp[n].expelled=true; }

            applyAutoExpulsionIfNeededOpp(n);
          }
        }
        break;
      }
    }
  }

  // QUINTETTI: secondi giocati per quintetto dagli stint (inRem - outRem)
  for(const s of base.lineupStints){
    const outRem = (s.outRem===null || s.outRem===undefined) ? 0 : Number(s.outRem)||0;
    const inRem  = Number(s.inRem)||0;
    const dur = Math.max(0, inRem - outRem);
    const L = getL(String(s.key||''), s.lineup||[]);
    if(L) L.sec += dur;
  }
  // write back
  S.status=base.status; S.nQ=base.nQ;
  S.sH=base.sH; S.sA=base.sA;
  S.fH=base.fH; S.fA=base.fA;
  S.toH=base.toH; S.toA=base.toA;
  S.tH=base.tH; S.tA=base.tA;
  S._benchHomeSym=base.benchHomeSym;
  S._benchAwaySym=base.benchAwaySym;
  S.inC=base.inC;
  S.p=base.p;
  S.opp=base.opp;
  S.expelled=base.expelled;
  S.shots=base.shots;
  S.stints=base.stints;
  S.lineups=base.lineups;

  if(S.selP && (!S.inC.includes(S.selP) || (S.p[S.selP]?.fouls>=5) || S.expelled.has(S.selP))) S.selP=null;

  const __newInCKey = (S.inC||[]).map(String).join(',');
  const __needRosterRebuild = (__prevStatus!==S.status) || (__prevInCKey!==__newInCKey);
  if(__needRosterRebuild) renderRoster();
  else updateUI();

  // Keep screen awake during live play
  try{ syncWakeLock(__prevStatus, S.status); }catch(e){}

  if(S.status==='ended'){
    if(!IS_VIEWER) openModal('modalGameOver');
    else closeModal('modalGameOver');
  }
}

/* ===================== ACTIONS => EVENTS ===================== */
function addEventOppPoint(v){ flash('red'); addEvent({type:'opp_point', payload:{value:Number(v)||0}}); }
function addEventTimeout(team){ addEvent({type:'timeout', payload:{team}}); }

function addEventQuick(kind){
  if(!S.selP) return;
  let fl='blue'; if(kind==='turnover') fl='red'; if(kind==='steal') fl='green';
  flash(fl);
  addEvent({type:'quick', payload:{kind, player:S.selP}});
}

function addEventFoulMade(){
  if(!S.selP) return;
  flash('red');
  addEvent({type:'foul_made', payload:{player:S.selP}});
  if(S.p[S.selP]?.fouls>=5 && S.inC.includes(S.selP)) openSub(S.selP);
}

function openFoulSuffered(){
  S.selOpp=null;
  buildOppFoulGrid();
  $('btnRimessa').disabled=true;
  $('btnLiberi').disabled=true;
  openModal('modalFoulSuf');
}

function buildOppFoulGrid(){
  const g=$('oppFoulGrid'); g.innerHTML='';
  S.oppRoster.forEach(n=>{
    const st=S.opp[n]||{fouls:0,specials:[],expelled:false};
    const sym=(st.specials||[]).join('');
    const b=document.createElement('button');
    b.className='player-card'; b.dataset.num=n;
    b.innerHTML=`<div class="pname">&nbsp;</div><div class="pnum">${esc(n)}</div><div class="bmid">${esc(sym)}</div><div class="bf">${st.fouls||0}</div>`;
    const disabled=(st.fouls>=5)||!!st.expelled;
    if(disabled) b.classList.add('dis');
    else b.onclick=()=>{
      S.selOpp=(S.selOpp===n)?null:n;
      [...g.children].forEach(x=>x.classList.remove('sel'));
      if(S.selOpp) b.classList.add('sel');
      $('btnRimessa').disabled=!S.selOpp;
      $('btnLiberi').disabled=!S.selOpp;
    };
    g.appendChild(b);
  });
}

function addEventFoulSuf(freeThrows){
  if(!S.selP || !S.selOpp) return;
  flash('green');

  addEvent({
    type:'foul_suf',
    payload:{ myPlayer:S.selP, oppPlayer:S.selOpp, freeThrows:!!freeThrows }
  });

  if(freeThrows){
    // 1) chiudo il modal fallo subito, MA senza deselezionare
    const prev = __DESEL_AFTER_MODAL;
    __DESEL_AFTER_MODAL = false;
    closeModal('modalFoulSuf');

    // 2) apro i liberi con la selezione ancora valida
    __DESEL_AFTER_MODAL = true;  // deseleziona quando chiuderai i liberi
    openFT();                    // (oppure openModal('modalFT') se preferisci)

    // (opzionale) se vuoi ripristinare esattamente il valore precedente:
    // __DESEL_AFTER_MODAL = prev;  // ma in questo caso io lo lascerei true per i liberi
    return;
  }

  // caso RIMESSA: chiudo normalmente (qui va bene deselezionare)
  closeModal('modalFoulSuf');
}


/* shot */
function addEventShot(made){
  if(!S.selP || S.shotX===null) return;
  addEvent({type:'shot', payload:{player:S.selP, val:S.shotVal, made:!!made, x:S.shotX, y:S.shotY}});
  flash(made?'green':'red');
  closeShotModal();
}

/* ft */
function closeFTModal(){
  closeModal('modalFT');
  clearSelectedPlayer();
}
function openFT(){ if(!S.selP) return; $('ftSeq').textContent=''; openModal('modalFT'); }
function addEventFT(made){
  if(!S.selP) return;
  addEvent({type:'ft', payload:{player:S.selP, made:!!made}});
  flash(made?'green':'red');
  $('ftSeq').textContent += made?'‚úÖ':'‚ùå';
}

/* sub */
function openSub(autoOut=null){
  if(S.status!=='playing') return;
  subAutoOut=autoOut?String(autoOut):null;
  $('subTime').value='';
  buildSubGrids();
  updSubBtn();
  openModal('modalSub');
}

function buildSubGrids(){
  const out=$('outGrid'), inn=$('inGrid'); out.innerHTML=''; inn.innerHTML='';
  S.myRoster.forEach(pl=>{
    const n=pl.num;
    const st=S.p[n];
    const b=document.createElement('button');
    b.className='player-card'; b.dataset.num=n;
    b.innerHTML=`<div class="pname">${esc(pl.name||'')}</div><div class="pnum">${esc(n)}</div><div class="bf">${st.fouls}</div>`;
    const disabledIn=(st.fouls>=5)||S.expelled.has(n);
    if(S.inC.includes(n)){
      if(subAutoOut && n===subAutoOut) b.classList.add('sel');
      b.onclick=()=>{ b.classList.toggle('sel'); updSubBtn(); };
      out.appendChild(b);
    }else{
      if(disabledIn) b.classList.add('dis');
      else b.onclick=()=>{ b.classList.toggle('sel'); updSubBtn(); };
      inn.appendChild(b);
    }
  });
}

function updSubBtn(){
  const outSel=[...document.querySelectorAll('#outGrid .sel')].map(b=>b.dataset.num);
  const inSel=[...document.querySelectorAll('#inGrid .sel')].map(b=>b.dataset.num);
  const p=parseMSS($('subTime').value);
  if($('subTime').value!==p.digits) $('subTime').value=p.digits;
  const ok=(outSel.length>0 && outSel.length===inSel.length && p.ok);
  const b=$('btnConfirmSub');
  b.disabled=!ok;
  b.style.background=ok?css('--g'):'grey';
}
$('subTime')?.addEventListener?.('input',updSubBtn);

function addEventSub(){
  const outSel=[...document.querySelectorAll('#outGrid .sel')].map(b=>b.dataset.num);
  const inSel=[...document.querySelectorAll('#inGrid .sel')].map(b=>b.dataset.num);
  const p=parseMSS($('subTime').value);
  if(!p.ok) return;
  addEvent({type:'sub', payload:{nQ:S.nQ, remSec:p.rem, outs:outSel, ins:inSel}});
  closeModal('modalSub');
}

/* special fouls */
function openSpecialFoul(){
  Spec={ type:'T', selHome:new Set(), selAway:new Set(), benchHome:false, benchAway:false };
  setSpecialType('T');
  renderSpecialGrids();
  updateSpecOk();
  openModal('modalSpecial');
}

function setSpecialType(t){
  Spec.type=t;
  $('tabT').classList.toggle('act',t==='T');
  $('tabU').classList.toggle('act',t==='U');
  $('tabD').classList.toggle('act',t==='D');

  // bench selectable only for T and D
  const benchAllowed = (t==='T' || t==='D');
  $('benchHomeBtn').style.opacity = benchAllowed? '1':'0.35';
  $('benchAwayBtn').style.opacity = benchAllowed? '1':'0.35';

  if(!benchAllowed){ Spec.benchHome=false; Spec.benchAway=false; }
  updateSpecOk();
}

function toggleBench(team){
  // only for T or D
  if(!(Spec.type==='T' || Spec.type==='D')) return;
  if(team==='Home') Spec.benchHome=!Spec.benchHome;
  if(team==='Away') Spec.benchAway=!Spec.benchAway;
  updateSpecOk();
}

function renderSpecialGrids(){
  const hg=$('specHomeGrid'), ag=$('specAwayGrid');
  hg.innerHTML=''; ag.innerHTML='';
  const myIsHome=(S.noi==='Home');

  function addBtn(grid, who, num, name, disabled){
    const b=document.createElement('button');
    b.className='player-card';
    b.dataset.who=who;
    b.dataset.num=num;
    const sym = (who==='my') ? (S.p[num]?.specials||[]).join('') : (S.opp[num]?.specials||[]).join('');
    const fouls = (who==='my') ? (S.p[num]?.fouls||0) : (S.opp[num]?.fouls||0);
    b.innerHTML=`<div class="pname">${esc(name||'')}</div><div class="pnum">${esc(num)}</div><div class="bmid">${esc(sym)}</div><div class="bf">${fouls}</div>`;
    if(disabled) b.classList.add('dis');
    else b.onclick=()=>{
      const set = (grid===hg)?Spec.selHome:Spec.selAway;
      if(set.has(num)){ set.delete(num); b.classList.remove('sel'); }
      else { set.add(num); b.classList.add('sel'); }
      updateSpecOk();
    };
    grid.appendChild(b);
  }

  // HOME grid and AWAY grid must show HOME team and AWAY team
  if(myIsHome){
    // HOME = my
    S.myRoster.forEach(pl=>{
      const n=pl.num;
      const dis=(S.p[n].fouls>=5)||S.expelled.has(n);
      addBtn(hg,'my',n,pl.name,dis);
    });
    // AWAY = opp
    S.oppRoster.forEach(n=>{
      const st=S.opp[n];
      const dis=(st.fouls>=5)||st.expelled;
      addBtn(ag,'opp',n,'',dis);
    });
  }else{
    // HOME = opp
    S.oppRoster.forEach(n=>{
      const st=S.opp[n];
      const dis=(st.fouls>=5)||st.expelled;
      addBtn(hg,'opp',n,'',dis);
    });
    // AWAY = my
    S.myRoster.forEach(pl=>{
      const n=pl.num;
      const dis=(S.p[n].fouls>=5)||S.expelled.has(n);
      addBtn(ag,'my',n,pl.name,dis);
    });
  }
}

function updateSpecOk(){
  const any = (Spec.selHome.size+Spec.selAway.size)>0 || Spec.benchHome || Spec.benchAway;
  const b=$('btnSpecOk');
  b.disabled=!any;
  b.style.background=any?css('--g'):'grey';

  // bench button visual
  const bh=$('benchHomeBtn'), ba=$('benchAwayBtn');
  const allowBench = (Spec.type==='T' || Spec.type==='D');
  if(bh){
    bh.classList.toggle('active-in', !!Spec.benchHome);
    bh.disabled=!allowBench;
    bh.style.opacity=allowBench? '1':'0.35';
  }
  if(ba){
    ba.classList.toggle('active-in', !!Spec.benchAway);
    ba.disabled=!allowBench;
    ba.style.opacity=allowBench? '1':'0.35';
  }
}

function addEventSpecial(){
  if($('btnSpecOk').disabled) return;
  const myIsHome=(S.noi==='Home');
  const targets=[];

  if(Spec.benchHome) targets.push({team:'bench_home'});
  if(Spec.benchAway) targets.push({team:'bench_away'});

  // home grid is HOME team
  for(const n of Spec.selHome){
    if(myIsHome) targets.push({team:'my', num:n, kind:Spec.type});
    else targets.push({team:'opp', num:n, kind:Spec.type});
  }
  for(const n of Spec.selAway){
    if(myIsHome) targets.push({team:'opp', num:n, kind:Spec.type});
    else targets.push({team:'my', num:n, kind:Spec.type});
  }

  addEvent({type:'special_foul', payload:{kind:Spec.type, targets}});
  closeModal('modalSpecial');
}

/* ===================== CHECK FALLI ===================== */
function refreshFoulsCheck(){
  $('cfHomeName').textContent=S.nameH;
  $('cfAwayName').textContent=S.nameA;
  $('cfHome').textContent=S.fH;
  $('cfAway').textContent=S.fA;
  $('cfTeams').textContent=`${S.nameH} ${S.fH} ‚Äî ${S.nameA} ${S.fA}`;

  const mkRow = (fouls, num, name, sym, expelled)=>{
    const fTxt = expelled ? 'ESP' : String(fouls||0);
    const namePart = name ? ` ${esc(name)}` : '';
    const symTxt = sym ? `<span style="color:var(--y);font-weight:1000;margin-left:10px">${esc(sym)}</span>` : '';
    return `
      <div class="ev-item" style="display:flex;align-items:center;gap:12px">
        <div style="min-width:38px;text-align:center;color:#ff4444;font-weight:1000;font-size:18px">${esc(fTxt)}</div>
        <div style="flex:1;font-weight:1000">${num?('#'+esc(num)):'<span class="muted2">PANCHINA</span>'}${namePart}${symTxt}</div>
      </div>
    `;
  };

  // Mia squadra e avversari: sempre in sezioni separate
  const my=$('cfMyList'); my.innerHTML='';
  const rows=S.myRoster.map(pl=>{
    const st=S.p[pl.num]; 
    return {num:pl.num,name:pl.name||'',f:st.fouls||0,sym:(st.specials||[]).join(''),exp:S.expelled.has(pl.num)};
  }).filter(x=>x.f>0||x.sym||x.exp).sort((a,b)=>(b.exp-a.exp)||(b.f-a.f));

  // Bench specials (solo simbolo)
  const benchMySym = (S.noi==='Home') ? (S._benchHomeSym||'') : (S._benchAwaySym||'');
  if(benchMySym) my.innerHTML += mkRow('', '', '', benchMySym, false);

  if(!rows.length && !benchMySym){
    my.innerHTML=`<div class="ev-item"><div class="muted">Nessun fallo registrato</div></div>`;
  }else{
    rows.forEach(x=>{ my.innerHTML += mkRow(x.f,x.num,x.name,x.sym,x.exp); });
  }

  const op=$('cfOppList'); op.innerHTML='';
  const orows=S.oppRoster.map(n=>{
    const st=S.opp[n]; return {num:n,f:st.fouls||0,sym:(st.specials||[]).join(''),exp:!!st.expelled};
  }).filter(x=>x.f>0||x.sym||x.exp).sort((a,b)=>(b.exp-a.exp)||(b.f-a.f));

  const benchOppSym = (S.noi==='Home') ? (S._benchAwaySym||'') : (S._benchHomeSym||'');
  if(benchOppSym) op.innerHTML += mkRow('', '', '', benchOppSym, false);

  if(!orows.length && !benchOppSym){
    op.innerHTML=`<div class="ev-item"><div class="muted">Nessun fallo registrato</div></div>`;
  }else{
    orows.forEach(x=>{ op.innerHTML += mkRow(x.f,x.num,'',x.sym,x.exp); });
  }
}

/* ===================== STATS LIVE ===================== */
function minsByPlayer(){
  const m={}; S.myRoster.forEach(pl=>m[pl.num]=0);
  const stints=S.stints||[];
  for(const s of stints){
    if(m[s.player]==null) m[s.player]=0;
    const out=(s.outRem===null)?0:s.outRem;
    m[s.player]+=Math.max(0,(s.inRem||0)-out);
  }
  return m;
}

function fmtMMSS(sec){
  sec = Math.max(0, Math.floor(sec||0));
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return `${m}:${String(s).padStart(2,'0')}`;
}

// Score HOME/AWAY per quarto (1..nQ incl OT)
function scoreByQuarter(){
  const H = [], A = [];
  let q = 1;
  const myIsHome = (S.noi === 'Home');

  const addH = (v)=>{ H[q] = (H[q]||0) + v; };
  const addA = (v)=>{ A[q] = (A[q]||0) + v; };

  for(const ev of (S.events||[])){
    const p = ev.payload || {};
    if(ev.type === 'start_period'){
      q = Number(p.nQ) || q;
      continue;
    }
    // punti avversari manuali
    if(ev.type === 'opp_point'){
      const v = Number(p.value)||0;
      if(myIsHome) addA(v); else addH(v);
      continue;
    }
    // tiri/FT mia squadra
    if(ev.type === 'shot' && p.made){
      const v = Number(p.val)||2;
      if(myIsHome) addH(v); else addA(v);
      continue;
    }
    if(ev.type === 'ft' && p.made){
      if(myIsHome) addH(1); else addA(1);
      continue;
    }
  }
  return {H,A};
}

// punti per quarto del singolo giocatore (1..nQ incl OT)
function playerPointsByQuarter(playerNum){
  const pts = [];
  let q = 1;
  const pid = String(playerNum);

  for(const ev of (S.events||[])){
    const p = ev.payload || {};
    if(ev.type === 'start_period'){ q = Number(p.nQ) || q; continue; }

    if(ev.type === 'shot' && p.made && String(p.player) === pid){
      const v = Number(p.val)||2;
      pts[q] = (pts[q]||0) + v;
    }
    if(ev.type === 'ft' && p.made && String(p.player) === pid){
      pts[q] = (pts[q]||0) + 1;
    }
  }
  return pts;
}

// tempo giocato per quarto (solo Q1..Q4), totale = somma quarti conclusi (esclude quarto in corso)
function playerTimeByQuarterCompleted(playerNum){
  const pid = String(playerNum);
  const t = [0,0,0,0,0]; // 1..4
  const stints = S.stints || [];

  const currentQ = Number(S.nQ)||1;
  const ended = (S.status === 'ended');

  for(const s of stints){
    if(String(s.player) !== pid) continue;
    const q = Number(s.q)||0;
    if(q<1 || q>4) continue;

    // includi SOLO quarti conclusi (oppure tutti se partita terminata)
    if(!ended && q >= currentQ) continue;

    const out = (s.outRem===null)?0:Number(s.outRem)||0;
    const inn = Number(s.inRem)||0;
    t[q] += Math.max(0, inn - out);
  }

  const total = t[1]+t[2]+t[3]+t[4];
  return {t, total};
}


// tempo giocato negli OT conclusi (OT1..), totale OT
function playerTimeByOTCompleted(playerNum){
  const pid = String(playerNum);
  const maxQ = Math.max(4, Number(S.nQ)||1);
  const otCount = Math.max(0, maxQ - 4);
  const t = Array(otCount+1).fill(0); // 1..otCount
  const stints = S.stints || [];

  const currentQ = Number(S.nQ)||1;
  const ended = (S.status === 'ended');

  for(const s of stints){
    if(String(s.player) !== pid) continue;
    const q = Number(s.q)||0;
    if(q <= 4) continue;

    const idx = q - 4;
    if(idx < 1 || idx > otCount) continue;

    // includi SOLO OT conclusi (oppure tutti se partita terminata)
    if(!ended && q >= currentQ) continue;

    const out = (s.outRem===null)?0:Number(s.outRem)||0;
    const inn = Number(s.inRem)||0;
    t[idx] += Math.max(0, inn - out);
  }

  const total = t.reduce((a,b)=>a+b,0);
  return {t, total, otCount};
}

function renderQTable(elId, labels, values, valueFormatter){
  const el = $(elId);
  if(!el) return;
  el.innerHTML = '';
  for(let i=0;i<labels.length;i++){
    const lab = labels[i];
    const val = values[i];
    const v = valueFormatter ? valueFormatter(val) : (val||0);
    el.innerHTML += `<div class="qCell"><div class="qt">${lab}</div><div class="qv">${v}</div></div>`;
  }
}

function pointsFor(sel){
  if(sel==='ALL'){ let tot=0; S.myRoster.forEach(pl=>tot+=(S.p[pl.num]?.pts||0)); return tot; }
  return S.p[String(sel)]?.pts||0;
}
function minsFor(sel){
  const m=minsByPlayer();
  if(sel==='ALL') return null; // hide in squadra
  return m[String(sel)]||0;
}

/* ===== STATS LIVE: filtro per quarto (calcolo da eventi) ===== */
let statsQSel = 'ALL'; // 'ALL' | 1 | 2 | 3 | 4 | 'OT1' | 'OT2' ...

function _qKeyToNum(qKey){
  if(qKey==='ALL') return null;
  if(typeof qKey==='number') return qKey;
  if(/^OT\d+$/.test(qKey)) return 4 + Number(qKey.slice(2));
  const n = Number(qKey);
  return Number.isFinite(n) ? n : null;
}

function _eventQuartered(events){
  let q = 1;
  const out = [];
  for(const ev of (events||[])){
    const p = ev.payload || {};
    if(ev.type==='start_period'){
      q = Number(p.nQ) || q;
      continue;
    }
    out.push({q, ev});
  }
  return out;
}

function aggStatsByEvents(sel, qSel){
  const only = (sel && sel!=='ALL') ? String(sel) : null;
  const qNum = _qKeyToNum(qSel);
  const st = {
    twoM:0,twoA:0,threeM:0,threeA:0,ftM:0,ftA:0,
    foulMade:0,foulSuf:0,to:0,stl:0,ro:0,rd:0,
    shots:[]
  };

  for(const item of _eventQuartered(S.events)){
    const q = item.q;
    const ev = item.ev;
    const p = ev.payload || {};

    if(qNum && q!==qNum) continue;

    if(ev.type==='shot'){
      if(only && String(p.player)!==only) continue;
      const val = Number(p.val)||2;
      const made = !!p.made;
      if(val===2){ st.twoA++; if(made) st.twoM++; }
      if(val===3){ st.threeA++; if(made) st.threeM++; }
      st.shots.push({x:p.x,y:p.y,val, made});
      continue;
    }

    if(ev.type==='ft'){
      if(only && String(p.player)!==only) continue;
      st.ftA++; if(!!p.made) st.ftM++;
      continue;
    }

    if(ev.type==='foul_made'){
      if(only && String(p.player)!==only) continue;
      st.foulMade++;
      continue;
    }

    if(ev.type==='foul_suf'){
      if(only && String(p.myPlayer)!==only) continue;
      st.foulSuf++;
      continue;
    }

    if(ev.type==='quick'){
      if(only && String(p.player)!==only) continue;
      if(p.kind==='turnover') st.to++;
      if(p.kind==='steal') st.stl++;
      if(p.kind==='reb_off') st.ro++;
      if(p.kind==='reb_def') st.rd++;
      continue;
    }
  }

  return st;
}

function buildQuarterBar(){
  const bar = $('qFilterBar');
  if(!bar) return;

  const maxQ = Math.max(4, Number(S.nQ)||1);
  const otCount = Math.max(0, maxQ - 4);

  const btn = (key,label)=>{
    const b=document.createElement('button');
    b.className='qbtn'+(statsQSel===key?' act':'');
    b.textContent=label;
    b.onclick=()=>{ statsQSel=key; renderStats(); };
    return b;
  };

  bar.innerHTML='';
  bar.appendChild(btn('ALL','TUTTA'));
  bar.appendChild(btn(1,'1Q'));
  bar.appendChild(btn(2,'2Q'));
  bar.appendChild(btn(3,'3Q'));
  bar.appendChild(btn(4,'4Q'));

  if(otCount>0){
    for(let i=1;i<=otCount;i++){
      bar.appendChild(btn('OT'+i,'OT'+i));
    }
  }
}
function aggStats(sel){
  const only=(sel && sel!=='ALL')?String(sel):null;
  const players=only?[only]:S.myRoster.map(pl=>pl.num);
  const a={twoM:0,twoA:0,threeM:0,threeA:0,ftM:0,ftA:0,foulMade:0,foulSuf:0,to:0,stl:0,ro:0,rd:0,shots:[]};
  for(const pnum of players){
    const st=S.p[pnum]; if(!st) continue;
    a.twoM+=st.twoM; a.twoA+=st.twoA;
    a.threeM+=st.threeM; a.threeA+=st.threeA;
    a.ftM+=st.ftM; a.ftA+=st.ftA;
    a.foulMade+=st.foulMade; a.foulSuf+=st.foulSuf;
    a.to+=st.to; a.stl+=st.stl; a.ro+=st.ro; a.rd+=st.rd;
  }
  a.shots=(S.shots||[]).filter(s=>only? s.player===only : true);
  return a;
}
function clearC(cv){ cv.getContext('2d').clearRect(0,0,cv.width,cv.height); }
function drawHeat(shots){
  const cv=$('heatCanvas'),ctx=cv.getContext('2d'); clearC(cv);
  const cell=22,cols=Math.ceil(cv.width/cell),rows=Math.ceil(cv.height/cell);
  const grid=[...Array(rows)].map(()=>Array(cols).fill(0));
  shots.forEach(s=>{
    const x=+s.x,y=+s.y; if(!isFinite(x)||!isFinite(y)) return;
    const c=Math.min(cols-1,Math.max(0,Math.floor(x/cell)));
    const r=Math.min(rows-1,Math.max(0,Math.floor(y/cell)));
    grid[r][c]++;
  });
  let mx=0; grid.forEach(r=>r.forEach(v=>mx=Math.max(mx,v)));
  if(mx===0) return;
  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
    const v=grid[r][c]; if(!v) continue;
    const t=v/mx; const a=.12+.55*t;
    ctx.fillStyle=`rgba(255,152,0,${a})`;
    ctx.fillRect(c*cell,r*cell,cell,cell);
  }
}
function drawChart(shots){
  const cv=$('shotCanvas'),ctx=cv.getContext('2d'); clearC(cv);
  shots.forEach(s=>{
    const x=+s.x,y=+s.y; if(!isFinite(x)||!isFinite(y)) return;
    if(s.made){
      ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2);
      ctx.fillStyle="rgba(40,167,69,.9)"; ctx.fill();
      ctx.lineWidth=2; ctx.strokeStyle="rgba(255,255,255,.9)"; ctx.stroke();
    }else{
      ctx.lineWidth=3; ctx.strokeStyle="rgba(220,53,69,.95)";
      ctx.beginPath();
      ctx.moveTo(x-6,y-6); ctx.lineTo(x+6,y+6);
      ctx.moveTo(x+6,y-6); ctx.lineTo(x-6,y+6);
      ctx.stroke();
    }
  });
}
function buildStatsSelector(){
  const teamC = $('statsTeam');
  const plyC  = $('statsPlayers');
  if(!teamC || !plyC) return;

  teamC.innerHTML = '';
  plyC.innerHTML  = '';

  const fmtBtn = (sec)=>{
    sec = Math.max(0, Math.floor(sec||0));
    const m = Math.floor(sec/60);
    const s = sec % 60;
    return `${m}:${String(s).padStart(2,'0')}`;
  };

  const mk = (parent, key, html, isPlayer=false)=>{
    const b = document.createElement('button');
    b.className = 'selbtn' + (statsSel===key ? ' act' : '') + (isPlayer ? ' selPlayer' : ' selTeam');
    b.innerHTML = html;
    b.onclick = ()=>{ statsSel = key; renderStats(); };
    parent.appendChild(b);
  };

  // TABELLINI + QUINTETTI sopra, SQUADRA sotto (full width)
  const rowTop = document.createElement('div');
  rowTop.className = 'teamRow';

  const tb = document.createElement('button');
  tb.className = 'selbtn';
  tb.textContent = 'TABELLINI';
  tb.onclick = ()=>openTabellini();
  rowTop.appendChild(tb);

  const qb = document.createElement('button');
  qb.className = 'selbtn';
  qb.textContent = 'QUINTETTI';
  qb.onclick = ()=>openQuintetti();
  rowTop.appendChild(qb);

  const rowBottom = document.createElement('div');
  rowBottom.className = 'teamRow';

  // SQUADRA (piu grande e full width)
  const squadraBtn = document.createElement('button');
  squadraBtn.className = 'selbtn btnSquadra' + (statsSel==='ALL' ? ' act' : '');
  squadraBtn.textContent = 'SQUADRA';
  squadraBtn.onclick = ()=>{ statsSel='ALL'; renderStats(); };
  rowBottom.appendChild(squadraBtn);

  teamC.appendChild(rowTop);
  teamC.appendChild(rowBottom);

  const mMap = minsByPlayer();
  const showTime = (S.status === 'ended');

  S.myRoster.forEach(pl=>{
    const num = String(pl.num);
    const st = S.p[num] || {};
    const pts = (st.pts || 0);
    const mins = (mMap[num] || 0);
    const fouls = (st.foulMade || 0);
    const spec = (st.specials || []).join('');

    mk(plyC, pl.num, `
      ${showTime ? `<div class="spTime">${fmtBtn(mins)}</div>` : ''}
      <div class="spName">${esc((pl.name||'').toUpperCase())}</div>
      <div class="spNum">${esc(String(pl.num))}</div>
      <div class="spBottom">
        <span class="spFoulBox">${fouls}</span>
        <span class="spSpec">${spec ? esc(spec) : ''}</span>
        <span class="spPtsBox">${pts} pt</span>
      </div>
    `, true);
  });
}


function updateStatsBoard(){
  if(!$('sbScoreH')) return;

  $('sbNameH').textContent = S.nameH;
  $('sbNameA').textContent = S.nameA;

  $('sbScoreH').textContent = S.sH;
  $('sbScoreA').textContent = S.sA;

  $('sbFoulsH').textContent = S.fH;
  $('sbFoulsA').textContent = S.fA;

  const th = $('sbTechH');
  const ta = $('sbTechA');
  if(th){
    th.textContent = 'T'.repeat(Math.max(0, Number(S.tH)||0));
    th.classList.toggle('hidden', !(Number(S.tH)>0));
  }
  if(ta){
    ta.textContent = 'T'.repeat(Math.max(0, Number(S.tA)||0));
    ta.classList.toggle('hidden', !(Number(S.tA)>0));
  }

  const pTxt = $('sbPeriodTxt');
  const fTag = $('sbFinal');
  if(S.status === 'ended'){
    pTxt.textContent = '';
    fTag.classList.remove('hidden');
  }else{
    fTag.classList.add('hidden');
    pTxt.textContent = (S.nQ>4) ? 'OT' : `${S.nQ}¬∞ quarto`;
  }

  renderDots('sbToH', S.toH);
  renderDots('sbToA', S.toA);
}

function renderStats(){
  // Ripristino logica mappe tiri del file "indexOKOK.html":
  // su Android/WebView e file://content:// questa strada e' la piu' affidabile.
  // S.shots viene popolato dal replay() in base agli eventi.
  buildStatsSelector();
  updateStatsBoard();
  const st=aggStats(statsSel);
// ===== PARZIALI SQUADRA (tra tabellone e bottone squadra) =====
const sq = scoreByQuarter();
const maxQ = Math.max(4, Number(S.nQ)||1);
const otCount = Math.max(0, maxQ - 4);

// tabella 1Q..4Q con formato "H-A"
const qLabels = ['1Q','2Q','3Q','4Q'];
const qVals = [1,2,3,4].map(k => `${sq.H[k]||0}-${sq.A[k]||0}`);
renderQTable('teamQPartials', qLabels, qVals, x=>x);

// OT solo se esistono
const otWrap = $('teamOTPartialsWrap');
if(otWrap){
  if(otCount>0){
    otWrap.classList.remove('hidden');
    const labs = Array.from({length:otCount}, (_,i)=>`OT${i+1}`);
    const vals = Array.from({length:otCount}, (_,i)=>{
      const k = 5+i;
      return `${sq.H[k]||0}-${sq.A[k]||0}`;
    });
    renderQTable('teamOTPartials', labs, vals, x=>x);
  }else{
    otWrap.classList.add('hidden');
  }
}

// ===== SEZIONI GIOCATORE: tempo+punti per quarto =====
const isTeam = (statsSel === 'ALL');
const timeWrap = $('playerTimeWrap');
const ptsWrap  = $('playerPtsWrap');
const pmWrap   = $('kpmWrap');
if(timeWrap && ptsWrap){
  if(isTeam){
    timeWrap.classList.add('hidden');
    ptsWrap.classList.add('hidden'); // in squadra non mostrare questi grid
  }else{
    timeWrap.classList.remove('hidden');
    ptsWrap.classList.remove('hidden');

    const pid = String(statsSel);
    const pp = playerPointsByQuarter(pid);

    // punti Q1..Q4 + totale
    const pQ1=pp[1]||0, pQ2=pp[2]||0, pQ3=pp[3]||0, pQ4=pp[4]||0;
    $('pQ1').textContent=pQ1; $('pQ2').textContent=pQ2; $('pQ3').textContent=pQ3; $('pQ4').textContent=pQ4;
    $('pTot').textContent=(pQ1+pQ2+pQ3+pQ4);

    // tempo Q1..Q4 (solo quarti conclusi)
    const tt = playerTimeByQuarterCompleted(pid);
    $('tQ1').textContent=fmtMMSS(tt.t[1]); $('tQ2').textContent=fmtMMSS(tt.t[2]);
    $('tQ3').textContent=fmtMMSS(tt.t[3]); $('tQ4').textContent=fmtMMSS(tt.t[4]);

    // totale tempo personale = quarti regolamentari + OT (coerente con il contatore in "partita infinita")
    let totalTime = Number(tt.total)||0;
    if(otCount>0){
      const otT = playerTimeByOTCompleted(pid);
      for(let i=1;i<=otCount;i++) totalTime += Number(otT.t[i])||0;
    }
    $('tTot').textContent=fmtMMSS(totalTime);

    // OT minuti giocatore solo se esistono
    const tOtWrap = $('playerOTTimeWrap');
    if(tOtWrap){
      if(otCount>0){
        const otT = playerTimeByOTCompleted(pid);
        tOtWrap.classList.remove('hidden');
        const labs = Array.from({length:otCount}, (_,i)=>`OT${i+1}`);
        const vals = Array.from({length:otCount}, (_,i)=> (otT.t[i+1]||0));
        renderQTable('playerOTMinutes', labs, vals, v=>fmtMMSS(v||0));
      }else{
        tOtWrap.classList.add('hidden');
      }
    }

    // OT punti giocatore solo se esistono
    const pOtWrap = $('playerOTWrap');
    if(pOtWrap){
      if(otCount>0){
        pOtWrap.classList.remove('hidden');
        const labs = Array.from({length:otCount}, (_,i)=>`OT${i+1}`);
        const vals = Array.from({length:otCount}, (_,i)=> pp[5+i]||0 );
        renderQTable('playerOTPoints', labs, vals, v=>v||0);
      }else{
        pOtWrap.classList.add('hidden');
      }
    }
  }
}

// PLUS/MINUS: mostra solo se e' selezionato un giocatore
if(pmWrap){
  if(isTeam){
    pmWrap.classList.add('hidden');
  }else{
    pmWrap.classList.remove('hidden');
    const p = S.p[String(statsSel)] || {};
    const pm = Number(p.pm)||0;
    $('kpm').textContent = (pm>0?'+':'') + String(pm);
  }
}

  $('k2').textContent=`${st.twoM}/${st.twoA}`; $('k2p').textContent=pct(st.twoM,st.twoA);
  $('k3').textContent=`${st.threeM}/${st.threeA}`; $('k3p').textContent=pct(st.threeM,st.threeA);
  $('kft').textContent=`${st.ftM}/${st.ftA}`; $('kftp').textContent=pct(st.ftM,st.ftA);

  // FALLI FATTI + falli speciali (T/U/D) in rosso per giocatore
  if(statsSel !== 'ALL'){
    const p = S.p[String(statsSel)] || {};
    const spec = (p.specials || []).join('');
    $("kfmade").innerHTML = String(st.foulMade) + (spec ? ' <span class="foulSpec">' + esc(spec) + '</span>' : '');
  }else{
    $("kfmade").textContent = st.foulMade;
  }

  $("kfsuf").textContent = st.foulSuf;
  $("kto").textContent = st.to;
  $("kstl").textContent = st.stl;
  $("kro").textContent = st.ro;
  $("krd").textContent = st.rd;

  drawHeat(st.shots);
  drawChart(st.shots);




}
function openStats(){ statsSel='ALL'; try{ document.body.classList.remove('viewerSub'); $('viewerBackBtn')?.classList.add('hidden'); }catch(e){} renderStats(); openModal('modalStats'); }

// ===== TABELLINI (leaderboards) =====
let __tabCat = 'PTS';

// CHIUDI (in alto) nel modal STAT LIVE:
// - se sono in TABELLINI torna alle stats
// - altrimenti chiude tutto il modal stats
function smartCloseStats(){
  const qw = $('quintettiWrap');
  if(qw && !qw.classList.contains('hidden')) return closeQuintetti();
  const tw = $('tabelliniWrap');
  if(tw && !tw.classList.contains('hidden')) return closeTabellini();
  try{ document.body.classList.remove('viewerSub'); $('viewerBackBtn')?.classList.add('hidden'); }catch(e){}
  closeModal('modalStats');
}

function openTabellini(){
  __tabCat = __tabCat || 'PTS';
  try{ if(IS_VIEWER){ document.body.classList.add('viewerSub'); $('viewerBackBtn')?.classList.remove('hidden'); } }catch(e){}
  const w = $('tabelliniWrap');
  const main = $('statsMainWrap');
  if(w) w.classList.remove('hidden');
  if(main) main.classList.add('hidden');
  renderTabellini(__tabCat);
}
function closeTabellini(){
  try{ if(IS_VIEWER){ document.body.classList.remove('viewerSub'); $('viewerBackBtn')?.classList.add('hidden'); } }catch(e){}
  const w = $('tabelliniWrap');
  const main = $('statsMainWrap');
  if(w) w.classList.add('hidden');
  if(main) main.classList.remove('hidden');
}

// ===== QUINTETTI (lineup leaderboards) =====
let qSel='PM';
function openQuintetti(){
  try{ if(IS_VIEWER){ document.body.classList.add('viewerSub'); $('viewerBackBtn')?.classList.remove('hidden'); } }catch(e){}
  $('statsMainWrap').classList.add('hidden');
  $('tabelliniWrap').classList.add('hidden');
  $('quintettiWrap').classList.remove('hidden');
  buildQuintettiFilters();
  renderQuintetti();
}
function closeQuintetti(){
  try{ if(IS_VIEWER){ document.body.classList.remove('viewerSub'); $('viewerBackBtn')?.classList.add('hidden'); } }catch(e){}
  $('quintettiWrap').classList.add('hidden');
  $('statsMainWrap').classList.remove('hidden');
}
function buildQuintettiFilters(){
  const c=$('qFilters');
  if(!c) return;
  c.innerHTML='';
  const items=[
    ['PF','PUNTI'],
    ['MIN','TEMPO GIOCATO'],
    ['PM','PLUS/MINUS']
  ];
  for(const [k,label] of items){
    const b=document.createElement('button');
    b.className='fchip'+(qSel===k?' act':'');
    b.textContent=label;
    b.onclick=()=>{ qSel=k; buildQuintettiFilters(); renderQuintetti(); };
    c.appendChild(b);
  }
}
function _fmtTime(sec){
  sec=Math.max(0,Math.floor(sec||0));
  const m=Math.floor(sec/60);
  const s=sec%60;
  return `${m}:${String(s).padStart(2,'0')}`;
}
function _pct(m,a){
  if(!a) return '0,00%';
  return ( (m*100)/a ).toFixed(2).replace('.',',')+'%';
}
function renderQuintetti(){
  const list=$('quintettiList');
  if(!list) return;
  const Ls = Object.values(S.lineups||{});
  if(!Ls.length){
    list.innerHTML = `<div class="pill">Nessun quintetto disponibile (serve almeno un quarto iniziato e/o un cambio)</div>`;
    return;
  }

  // lookup nomi giocatori
  const nameByNum = {};
  (S.myRoster||[]).forEach(pl=>{ nameByNum[String(pl.num)] = String(pl.name||'').trim(); });
  const labelPl = (num)=>{
    const n = String(num);
    const nm = nameByNum[n];
    return (nm? nm.toUpperCase() : ('#'+n)) + ` <span class="luNum">#${n}</span>`;
  };

  const sortVal=(L)=>{
    const pm=(L.pf||0)-(L.pa||0);
    if(qSel==='PF') return L.pf||0;
    if(qSel==='MIN') return L.sec||0;
    return pm;
  };
  Ls.sort((a,b)=> (sortVal(b)-sortVal(a)) || (((b.pf||0)-(b.pa||0))-((a.pf||0)-(a.pa||0))) );

  list.innerHTML='';
  for(const L of Ls){
    const pm=(L.pf||0)-(L.pa||0);
    const keyLine=(L.lineup||[]).map(String).slice(0,5).sort((x,y)=>Number(x)-Number(y));
    const rt=(L.ro||0)+(L.rd||0);
    const card=document.createElement('div');
    card.className='luCard';

    const playersHtml = keyLine.map(n=>`<div class="luP">${labelPl(n)}</div>`).join('');

    const pmCls = pm>=0 ? 'vPmPos' : 'vPmNeg';
    card.innerHTML = `
      <div class="luTop">
        <div class="luPlayers">${playersHtml}</div>
        <div class="luStats">
          <div class="luStat"><span class="k">PUNTI FATTI</span><span class="v vY">${L.pf||0}</span></div>
          <div class="luStat"><span class="k">MINUTI GIOCATI</span><span class="v vY">${_fmtTime(L.sec||0)}</span></div>
          <div class="luStat"><span class="k">PLUS/MINUS</span><span class="v ${pmCls}">${pm>=0?'+':''}${pm}</span></div>
        </div>
      </div>
      <div class="luSplit"></div>
      <div class="luMetaRow">
        <div class="luShot"><div class="n">2P <b>${L.twoM||0}/${L.twoA||0}</b></div><div class="p">(${_pct(L.twoM||0,L.twoA||0)})</div></div>
        <div class="luShot"><div class="n">3P <b>${L.threeM||0}/${L.threeA||0}</b></div><div class="p">(${_pct(L.threeM||0,L.threeA||0)})</div></div>
        <div class="luShot"><div class="n">TL <b>${L.ftM||0}/${L.ftA||0}</b></div><div class="p">(${_pct(L.ftM||0,L.ftA||0)})</div></div>
      </div>
      <div class="luMini" style="margin-top:6px">
        PERSE <b>${L.to||0}</b> ‚Ä¢ RECUP <b>${L.stl||0}</b> ‚Ä¢ FF <b>${L.foulMade||0}</b> ‚Ä¢ FS <b>${L.foulSuf||0}</b> ‚Ä¢ RO <b>${L.ro||0}</b> ‚Ä¢ RD <b>${L.rd||0}</b> ‚Ä¢ RT <b>${rt}</b>
      </div>
    `;
    list.appendChild(card);
  }
}

function renderTabellini(cat){
  __tabCat = cat || 'PTS';
  const filters = $('tabFilters');
  const list = $('tabelliniList');
  if(!filters || !list) return;

  // ===== Filtri su 3 righe (come richiesto) =====
  const rowsCfg = [
    [
      {k:'PTS', t:'PUNTI'},
      {k:'MIN', t:'TEMPO GIOCATO'},
      {k:'PM',  t:'PLUS/MINUS'},
    ],
    [
      {k:'2P',  t:'TIRO DA 2'},
      {k:'3P',  t:'TIRO DA 3'},
      {k:'FT',  t:'TIRI LIBERI'},
    ],
    [
      {k:'FF',  t:'FALLI FATTI'},
      {k:'FS',  t:'FALLI SUBITI'},
      {k:'TO',  t:'PALLE PERSE'},
      {k:'STL', t:'PALLE RECUPERATE'},
      {k:'REB', t:'RIMBALZI'},
    ]
  ];

  filters.innerHTML='';
  rowsCfg.forEach(r=>{
    const row = document.createElement('div');
    row.className='frow';
    r.forEach(c=>{
      const b=document.createElement('button');
      b.className='fbtn'+(c.k===__tabCat?' act':'');
      b.textContent=c.t;
      b.onclick=()=>renderTabellini(c.k);
      row.appendChild(b);
    });
    filters.appendChild(row);
  });

  const mMap = minsByPlayer();
  const rows = (S.myRoster||[]).map(pl=>{
    const num = String(pl.num);
    const st = S.p[num] || {};
    const sec = Number(mMap[num]||0);

    const makeShot = (m,a)=>({m:Number(m||0), a:Number(a||0)});
    const s2 = makeShot(st.twoM, st.twoA);
    const s3 = makeShot(st.threeM, st.threeA);
    const sft= makeShot(st.ftM, st.ftA);

    const val = (()=>{
      switch(__tabCat){
        case 'PTS': return {n:Number(st.pts||0), main:String(st.pts||0)};
        case 'MIN': return {n:sec, main:fmtMMSS(sec)};
        case 'PM':  {
          const pm = Number(st.pm||0);
          return {n:pm, main:(pm>0?'+':'')+String(pm)};
        }
        case '2P':  return {n:s2.m, main:`${s2.m}/${s2.a}`, sub:pct(s2.m,s2.a), pctNum: (s2.a? (s2.m/s2.a): -1), att:s2.a};
        case '3P':  return {n:s3.m, main:`${s3.m}/${s3.a}`, sub:pct(s3.m,s3.a), pctNum: (s3.a? (s3.m/s3.a): -1), att:s3.a};
        case 'FT':  return {n:sft.m,main:`${sft.m}/${sft.a}`,sub:pct(sft.m,sft.a),pctNum:(sft.a?(sft.m/sft.a):-1),att:sft.a};
        case 'FF':  return {n:Number(st.foulMade||0), main:String(st.foulMade||0)};
        case 'FS':  return {n:Number(st.foulSuf||0), main:String(st.foulSuf||0)};
        case 'TO':  return {n:Number(st.to||0), main:String(st.to||0)};
        case 'STL': return {n:Number(st.stl||0), main:String(st.stl||0)};
        case 'REB': {
          const ro = Number(st.ro||0);
          const rd = Number(st.rd||0);
          const rt = ro + rd;
          return {n:rt, ro, rd, rt};
        }
        default:    return {n:0, main:'0'};
      }
    })();

    return {
      num,
      name: pl.name || ('#'+num),
      ...val
    };
  });

  // sort
  rows.sort((a,b)=>{
    // shot categories: sort by made desc, then pct desc, then attempts desc
    if(['2P','3P','FT'].includes(__tabCat)){
      if((b.n||0)!=(a.n||0)) return (b.n||0)-(a.n||0);
      if((b.pctNum??-1)!=(a.pctNum??-1)) return (b.pctNum??-1)-(a.pctNum??-1);
      return (b.att||0)-(a.att||0);
    }
    // rimbalzi: ordina per TOT (RT), poi RD, poi RO
    if(__tabCat==='REB'){
      if((b.rt||0)!==(a.rt||0)) return (b.rt||0)-(a.rt||0);
      if((b.rd||0)!==(a.rd||0)) return (b.rd||0)-(a.rd||0);
      return (b.ro||0)-(a.ro||0);
    }
    // default: high to low
    return (b.n||0)-(a.n||0);
  });

  // list
  list.innerHTML='';
  if(__tabCat==='REB'){
    const h=document.createElement('div');
    h.className='trow';
    h.style.opacity='.9';
    h.innerHTML = `
      <div class="rk">#</div>
      <div class="nm">GIOCATORE</div>
      <div class="val reb"><span class="muted2">RD</span><span class="muted2">RO</span><b class="muted2">RT</b></div>
    `;
    list.appendChild(h);
  }
  rows.forEach((r,i)=>{
    const d=document.createElement('div');
    d.className='trow';
    const nameHtml = `${esc(String(r.name||'').toUpperCase())}<span class="num">#${esc(r.num)}</span>`;

    // percentuale sotto i numeri di tiro (non sotto il nome)
    if(['2P','3P','FT'].includes(__tabCat)){
      d.innerHTML = `
        <div class="rk">${i+1}</div>
        <div class="nm">${nameHtml}</div>
        <div class="val"><div class="main">${esc(String(r.main||''))}</div>${r.sub?`<div class="sub">${esc(r.sub)}</div>`:''}</div>
      `;
    } else if(__tabCat==='REB'){
      d.innerHTML = `
        <div class="rk">${i+1}</div>
        <div class="nm">${nameHtml}</div>
        <div class="val reb"><span>${esc(String(r.rd||0))}</span><span>${esc(String(r.ro||0))}</span><b>${esc(String(r.rt||0))}</b></div>
      `;
    } else {
      d.innerHTML = `
        <div class="rk">${i+1}</div>
        <div class="nm">${nameHtml}</div>
        <div class="val">${esc(String(r.main||''))}</div>
      `;
    }
    list.appendChild(d);
  });
}


/* ===================== MANUAL EDIT (baseline) ===================== */
let __manualLineup = null; // array di 5 numeri (string)

function _mssToSec(txt){
  const s = String(txt||'').trim();
  if(!s) return null;
  const digits = s.replace(/\D/g,'');
  if(!digits) return null;
  // formato MSS (es. 835 = 8:35). accetta anche 0..999
  const n = parseInt(digits,10);
  if(!Number.isFinite(n)) return null;
  const m = Math.floor(n/100);
  const ss = n % 100;
  if(ss>=60) return null;
  return (m*60)+ss;
}

function _readInt(id, defVal){
  const el = document.getElementById(id);
  const v = el ? parseInt(String(el.value||'').trim(),10) : NaN;
  return Number.isFinite(v) ? v : (defVal||0);
}

function _pfId(prefix, num){
  return prefix + String(num).replace(/[^0-9]/g,'');
}

function renderManualPersonalFouls(){
  const myGrid = document.getElementById('mPfMyGrid');
  const oppGrid = document.getElementById('mPfOppGrid');
  if(!myGrid || !oppGrid) return;

  // CASA
  myGrid.innerHTML='';
  (S.myRoster||[]).forEach(pl=>{
    const n = String(pl.num);
    const name = pl.name || '';
    const id = _pfId('mPfMy_', n);
    const fouls = ((S.p && S.p[n] && S.p[n].fouls)!=null ? S.p[n].fouls : 0);
    const card = document.createElement('div');
    card.className='pfCard';
    card.innerHTML = `
      <div class="pname">${esc(name)}</div>
      <div class="pnum">${esc(n)}</div>
      <input id="${id}" type="tel" inputmode="numeric" maxlength="1" placeholder="0" value="${esc(String(fouls||0))}" />
    `;
    myGrid.appendChild(card);
  });

  // TRASFERTA (solo numeri)
  oppGrid.innerHTML='';
  (S.oppRoster||[]).forEach(n0=>{
    const n = String(n0);
    const id = _pfId('mPfOpp_', n);
    const fouls = ((S.opp && S.opp[n] && S.opp[n].fouls)!=null ? S.opp[n].fouls : 0);
    const card = document.createElement('div');
    card.className='pfCard';
    card.innerHTML = `
      <div class="pname">&nbsp;</div>
      <div class="pnum">${esc(n)}</div>
      <input id="${id}" type="tel" inputmode="numeric" maxlength="1" placeholder="0" value="${esc(String(fouls||0))}" />
    `;
    oppGrid.appendChild(card);
  });
}

function _collectPf(prefix, nums){
  const out = {};
  (nums||[]).forEach(n0=>{
    const n = String(n0);
    const id = _pfId(prefix, n);
    const el = document.getElementById(id);
    if(!el) return;
    const v = parseInt(String(el.value||'0').trim(),10);
    const f = Number.isFinite(v) ? Math.max(0, v) : 0;
    out[n] = f;
  });
  return out;
}

function openManualEdit(){
  try{
    if(IS_VIEWER){
      alert("Sei in modalita sola lettura (view=1). Apri la pagina senza ?view=1 per poter modificare.");
      return;
    }
  // prefill
  const ended = (S.status==='ended');
  document.getElementById('mScoreH').value = S.sH||0;
  document.getElementById('mScoreA').value = S.sA||0;
  document.getElementById('mFoulH').value = S.fH||0;
  document.getElementById('mFoulA').value = S.fA||0;
  document.getElementById('mToH').value = S.toH||0;
  document.getElementById('mToA').value = S.toA||0;
  document.getElementById('mPeriod').value = S.nQ||1;
  document.getElementById('mStatus').value = ended ? 'ended' : (S.status==='playing' ? 'playing' : 'idle');
  document.getElementById('mRem').value = '';

  __manualLineup = null;
  document.getElementById('mLineupLabel').textContent = 'Non impostato';

  // default: se non ho eventi, metti come primo
  const cb = document.getElementById('mAsFirst');
  if(cb) cb.checked = !(S.events && S.events.length);

  renderManualPersonalFouls();
  openModal('modalManual');

  }catch(e){
    alert('Errore in MODIFICA MANUALE: ' + (e && e.message ? e.message : e));
  }
}

function openManualChoose5(){
  pickManualLineup();
}

function pickManualLineup(){
  const s = prompt('Inserisci i 5 numeri del quintetto separati da virgola (es: 4,7,10,12,15):');
  if(s===null) return;
  const nums = String(s).split(/[^0-9]+/).map(x=>x.trim()).filter(Boolean).map(x=>String(parseInt(x,10)));
  const uniq=[]; const seen=new Set();
  for(const n of nums){ if(!seen.has(n)){ seen.add(n); uniq.push(n); } }
  if(uniq.length!==5){ alert('Devi inserire esattamente 5 numeri.'); return; }
  // verifica che siano nel mio roster
  const rosterSet = new Set((S.myRoster||[]).map(p=>String(p.num)));
  for(const n of uniq){
    if(!rosterSet.has(n)){
      alert('Numero '+n+' non presente nel roster.');
      return;
    }
  }
  __manualLineup = uniq;
  document.getElementById('mLineupLabel').textContent = uniq.join(', ');
}

function applyManualEdit(){
  try{
    if(IS_VIEWER){
      alert("Modalita sola lettura (view=1): non posso salvare modifiche.");
      return;
    }
  const payload = {
    sH: Math.max(0, _readInt('mScoreH',0)),
    sA: Math.max(0, _readInt('mScoreA',0)),
    fH: Math.max(0, _readInt('mFoulH',0)),
    fA: Math.max(0, _readInt('mFoulA',0)),
    toH: Math.max(0, _readInt('mToH',0)),
    toA: Math.max(0, _readInt('mToA',0)),
    nQ: Math.max(1, _readInt('mPeriod',1)),
    status: (document.getElementById('mStatus').value||'idle')
  };

  const remSec = _mssToSec(document.getElementById('mRem').value);
  if(remSec!==null) payload.remSec = remSec;
  if(__manualLineup && __manualLineup.length===5) payload.lineup = __manualLineup.slice(0,5);

  // falli personali (baseline)
  payload.pfMy = _collectPf('mPfMy_', (S.myRoster||[]).map(p=>p.num));
  payload.pfOpp = _collectPf('mPfOpp_', (S.oppRoster||[]));

  const ev = { id: uid(), ts: Date.now(), type:'manual_set', payload };

  const _asFirst = document.getElementById('mAsFirst');
  const first = !!(_asFirst && _asFirst.checked);
  if(first) S.events.unshift(ev);
  else S.events.push(ev);

  replay();
  renderRoster();
  updateUI();
  setBtnState();
  autosave();

  closeModal('modalManual');
  }catch(e){
    alert('Errore in MODIFICA MANUALE: ' + (e && e.message ? e.message : e));
  }
}


/* ===================== EVENTS LIST + FILTERS + EDIT ===================== */
const EV_FILTERS=[
  {key:'ALL', label:'TUTTI'},
  {key:'shot', label:'TIRI'},
  {key:'ft', label:'LIBERI'},
  {key:'foul', label:'FALLI'},
  {key:'special_foul', label:'SPECIALI'},
  {key:'sub', label:'CAMBI'},
  {key:'misc', label:'ALTRO'}
];
let evFilter='ALL';

function openEvents(){
  renderEvents();
  openModal('modalEvents');
}

function formatEvent(ev){
  const t=ev.type, p=ev.payload||{};
  if(t==='start_period') return {title:`Inizio ${p.nQ>4?'OT':('Q'+p.nQ)}`, sub:`Quintetto: ${(p.lineup||[]).join(', ')}`};
  if(t==='end_period') return {title:`Fine ${p.nQ>4?'OT':('Q'+p.nQ)}`, sub:`Azione: ${p.action}`};
  if(t==='opp_point') return {title:`Punti avversari +${p.value}`, sub:`-`};
  if(t==='timeout') return {title:`Timeout ${p.team==='Home'?S.nameH:S.nameA}`, sub:`-`};
  if(t==='quick') return {title:`${p.kind} (#${p.player})`, sub:`-`};
  if(t==='foul_made') return {title:`Fallo fatto #${p.player}`, sub:`Conta fallo personale + squadra`};
  if(t==='foul_suf') return {title:`Fallo subito (#${p.myPlayer})`, sub:`Da avv #${p.oppPlayer} ‚Ä¢ ${p.freeThrows?'LIBERI':'RIMESSA'}`};
  if(t==='shot') return {title:`Tiro ${p.val} #${p.player} (${p.made?'‚úÖ':'‚ùå'})`, sub:`x:${p.x}, y:${p.y}`};
  if(t==='ft') return {title:`Libero #${p.player} (${p.made?'‚úÖ':'‚ùå'})`, sub:`-`};
  if(t==='sub') return {title:`Cambio ${p.nQ>4?'OT':('Q'+p.nQ)} a ${fmt(p.remSec)}`, sub:`OUT: ${(p.outs||[]).join(', ')} ‚Ä¢ IN: ${(p.ins||[]).join(', ')}`};
  if(t==='special_foul'){
    const kind=p.kind==='T'?'TECNICO':(p.kind==='U'?'ANTISPORTIVO':'ESPULSIONE');
    const list=(p.targets||[]).map(x=>{
      if(x.team==='my') return `MY #${x.num}`;
      if(x.team==='opp') return `OPP #${x.num}`;
      if(x.team==='bench_home') return `PANCHINA CASA`;
      if(x.team==='bench_away') return `PANCHINA OSPITE`;
      return '?';
    }).join(' ‚Ä¢ ');
    return {title:`Fallo speciale: ${kind}`, sub:list||'-'};
  }
  return {title:t, sub:JSON.stringify(p)};
}

function eventMatchesFilter(ev){
  if(evFilter==='ALL') return true;
  if(evFilter==='shot') return ev.type==='shot';
  if(evFilter==='ft') return ev.type==='ft';
  if(evFilter==='sub') return ev.type==='sub';
  if(evFilter==='special_foul') return ev.type==='special_foul';
  if(evFilter==='foul') return (ev.type==='foul_made'||ev.type==='foul_suf');
  if(evFilter==='misc') return !['shot','ft','sub','special_foul','foul_made','foul_suf'].includes(ev.type);
  return true;
}

function renderFilters(){
  const c=$('evFilters'); c.innerHTML='';
  EV_FILTERS.forEach(f=>{
    const b=document.createElement('button');
    b.className='fchip'+(evFilter===f.key?' act':'');
    b.textContent=f.label;
    b.onclick=()=>{ evFilter=f.key; renderEvents(); };
    c.appendChild(b);
  });
}

function renderEvents(){
  renderFilters();
  const q=String($('evSearch')?.value||'').trim().toLowerCase();
  const list=$('eventsList'); list.innerHTML='';
  if(!S.events.length){
    list.innerHTML=`<div class="ev-item"><div class="muted">Nessun evento registrato</div></div>`;
    return;
  }
  const arr=[...S.events].reverse().filter(eventMatchesFilter).filter(ev=>{
    if(!q) return true;
    const f=formatEvent(ev);
    return (f.title+' '+f.sub+' '+JSON.stringify(ev.payload)).toLowerCase().includes(q);
  });

  if(!arr.length){
    list.innerHTML=`<div class="ev-item"><div class="muted">Nessun evento per questo filtro/ricerca</div></div>`;
    return;
  }

  for(const ev of arr){
    const f=formatEvent(ev);
    const div=document.createElement('div'); div.className='ev-item';
    div.innerHTML=`
      <div class="ev-top">
        <div>
          <div class="ev-title">${esc(f.title)}</div>
          <div class="ev-sub">${esc(f.sub)}</div>
        </div>
        <div class="ev-actions">
          <button class="b1" onclick="openEdit('${ev.id}')">MOD</button>
          <button class="b2" onclick="deleteEvent('${ev.id}')">DEL</button>
        </div>
      </div>
      <div class="muted2" style="margin-top:8px;font-size:10px;font-weight:900;">ID: ${ev.id}</div>
    `;
    list.appendChild(div);
  }
}

$('evSearch')?.addEventListener?.('input',()=>renderEvents());

function deleteEvent(id){
  const idx=S.events.findIndex(e=>e.id===id);
  if(idx<0) return;
  S.events.splice(idx,1);
  replay();
  autosave();
  renderEvents();
}

/* -------- edit events --------
   - Modifica CAMBIO: UI a bottoni (come cambio normale)
*/
function openEdit(id){
  const ev=S.events.find(e=>e.id===id);
  if(!ev) return;
  editId=id;
  $('editHint').textContent=formatEvent(ev).title;
  const form=$('editForm'); form.innerHTML='';

  const mkSelect=(label,id,options,value)=>{
    const o=options.map(x=>`<option value="${esc(x.value)}"${String(x.value)===String(value)?' selected':''}>${esc(x.label)}</option>`).join('');
    return `<div style="margin-top:10px"><div class="pill">${esc(label)}</div><select id="${esc(id)}">${o}</select></div>`;
  };
  const mkInput=(label,id,val,ph)=>`<div style="margin-top:10px"><div class="pill">${esc(label)}</div><input id="${esc(id)}" value="${esc(val)}" placeholder="${esc(ph||'')}"/></div>`;

  if(ev.type==='sub'){
    // build sub editor like modalSub
    form.innerHTML=`
      <div class="pill">Tempo rimanente (MSS)</div>
      <input id="ed_subTime" type="tel" inputmode="numeric" maxlength="3" value="${esc(toMSS(ev.payload.remSec))}" />
      <div class="pill" style="margin-top:10px">CHI ESCE</div>
      <div class="grid-players" id="ed_outGrid"></div>
      <div class="pill" style="margin-top:10px">CHI ENTRA</div>
      <div class="grid-players" id="ed_inGrid"></div>
      <div class="muted2" style="margin-top:8px;font-size:11px;font-weight:900">Seleziona stesso numero OUT/IN</div>
    `;
    setTimeout(()=>buildEditSub(ev),0);
  } else if(ev.type==='foul_made'){
    form.innerHTML=mkSelect('Giocatore','ed_player',S.myRoster.map(pl=>({value:pl.num,label:`#${pl.num} ${pl.name||''}`})),ev.payload.player);
  } else if(ev.type==='shot'){
    form.innerHTML=
      mkSelect('Giocatore','ed_player',S.myRoster.map(pl=>({value:pl.num,label:`#${pl.num} ${pl.name||''}`})),ev.payload.player)+
      mkSelect('Valore','ed_val',[{value:2,label:'2'},{value:3,label:'3'}],ev.payload.val)+
      mkSelect('Esito','ed_made',[{value:'true',label:'SEGNATO'},{value:'false',label:'SBAGLIATO'}],String(!!ev.payload.made))+
      mkInput('X','ed_x',ev.payload.x,'0-310')+
      mkInput('Y','ed_y',ev.payload.y,'0-240');
  } else if(ev.type==='ft'){
    form.innerHTML=
      mkSelect('Giocatore','ed_player',S.myRoster.map(pl=>({value:pl.num,label:`#${pl.num} ${pl.name||''}`})),ev.payload.player)+
      mkSelect('Esito','ed_made',[{value:'true',label:'SEGNATO'},{value:'false',label:'SBAGLIATO'}],String(!!ev.payload.made));
  } else if(ev.type==='quick'){
    form.innerHTML=
      mkSelect('Tipo','ed_kind',[
        {value:'reb_def',label:'Rimbalzo Difensivo'},
        {value:'reb_off',label:'Rimbalzo Offensivo'},
        {value:'turnover',label:'Palla Persa'},
        {value:'steal',label:'Palla Recuperata'}
      ],ev.payload.kind)+
      mkSelect('Giocatore','ed_player',S.myRoster.map(pl=>({value:pl.num,label:`#${pl.num} ${pl.name||''}`})),ev.payload.player);
  } else if(ev.type==='opp_point'){
    form.innerHTML=mkSelect('Valore','ed_val',[{value:1,label:'+1'},{value:2,label:'+2'},{value:3,label:'+3'}],ev.payload.value);
  } else if(ev.type==='timeout'){
    form.innerHTML=mkSelect('Squadra','ed_team',[{value:'Home',label:S.nameH},{value:'Away',label:S.nameA}],ev.payload.team);
  } else if(ev.type==='foul_suf'){
    form.innerHTML=
      mkSelect('Mio giocatore','ed_my',S.myRoster.map(pl=>({value:pl.num,label:`#${pl.num} ${pl.name||''}`})),ev.payload.myPlayer)+
      mkSelect('Avversario','ed_opp',S.oppRoster.map(n=>({value:n,label:`#${n}`})),ev.payload.oppPlayer)+
      mkSelect('Esito','ed_ft',[{value:'true',label:'LIBERI'},{value:'false',label:'RIMESSA'}],String(!!ev.payload.freeThrows));
  } else if(ev.type==='special_foul'){
    form.innerHTML=`
      ${mkSelect('Tipo', 'ed_kind', [{value:'T',label:'TECNICO'},{value:'U',label:'ANTISPORTIVO'},{value:'D',label:'ESPULSIONE'}], ev.payload.kind||'T')}
      <div class="pill" style="margin-top:10px">Targets</div>
      <div class="pill">MIA SQUADRA</div>
      <div class="grid-players" id="ed_myGrid"></div>
      <button id="ed_benchHome" class="btnW" style="background:#222;color:#fff;border:1px solid #2e2e2e" onclick="toggleEditBench('home')">üèüÔ∏è PANCHINA CASA</button>
      <div class="hr"></div>
      <div class="pill">AVVERSARI</div>
      <div class="grid-players" id="ed_oppGrid"></div>
      <button id="ed_benchAway" class="btnW" style="background:#222;color:#fff;border:1px solid #2e2e2e" onclick="toggleEditBench('away')">üèüÔ∏è PANCHINA OSPITE</button>
    `;
    setTimeout(()=>buildEditSpecialTargets(ev),0);
  } else {
    form.innerHTML=`<div class="muted">Editor non disponibile per questo evento. Puoi eliminarlo e rifarlo.</div>`;
  }

  openModal('modalEdit');
}

function toMSS(remSec){
  const s=Math.max(0,Math.floor(remSec||0));
  const m=Math.floor(s/60);
  const ss=s%60;
  return String(m).slice(-1)+String(ss).padStart(2,'0');
}

function buildEditSub(ev){
  const out=$('ed_outGrid'), inn=$('ed_inGrid');
  out.innerHTML=''; inn.innerHTML='';
  const selectedOut=new Set((ev.payload.outs||[]).map(String));
  const selectedIn=new Set((ev.payload.ins||[]).map(String));

  $('ed_subTime').addEventListener('input',()=>{
    const p=parseMSS($('ed_subTime').value);
    if($('ed_subTime').value!==p.digits) $('ed_subTime').value=p.digits;
  });

  S.myRoster.forEach(pl=>{
    const n=pl.num;
    const st=S.p[n];
    // OUT
    const bo=document.createElement('button');
    bo.className='player-card';
    bo.dataset.num=n;
    bo.innerHTML=`<div class="pname">${esc(pl.name||'')}</div><div class="pnum">${esc(n)}</div><div class="bf">${st.fouls}</div>`;
    if(!S.inC.includes(n)) bo.classList.add('dis');
    else{
      if(selectedOut.has(n)) bo.classList.add('sel');
      bo.onclick=()=>{ bo.classList.toggle('sel'); };
    }
    out.appendChild(bo);

    // IN
    const bi=document.createElement('button');
    bi.className='player-card';
    bi.dataset.num=n;
    bi.innerHTML=`<div class="pname">${esc(pl.name||'')}</div><div class="pnum">${esc(n)}</div><div class="bf">${st.fouls}</div>`;
    const disIn = S.inC.includes(n) || st.fouls>=5 || S.expelled.has(n);
    if(disIn) bi.classList.add('dis');
    else{
      if(selectedIn.has(n)) bi.classList.add('sel');
      bi.onclick=()=>{ bi.classList.toggle('sel'); };
    }
    inn.appendChild(bi);
  });
}

function buildEditSpecialTargets(ev){
  editBenchHome=false; editBenchAway=false;
  editSelMy=new Set(); editSelOpp=new Set();

  const cur=ev.payload.targets||[];
  for(const t of cur){
    if(t.team==='my' && t.num) editSelMy.add(String(t.num));
    if(t.team==='opp' && t.num) editSelOpp.add(String(t.num));
    if(t.team==='bench_home') editBenchHome=true;
    if(t.team==='bench_away') editBenchAway=true;
  }

  const gm=$('ed_myGrid'), go=$('ed_oppGrid');
  gm.innerHTML=''; go.innerHTML='';

  S.myRoster.forEach(pl=>{
    const n=pl.num;
    const b=document.createElement('button');
    b.className='player-card';
    b.innerHTML=`<div class="pname">${esc(pl.name||'')}</div><div class="pnum">${esc(n)}</div>`;
    const dis=(S.p[n]?.fouls>=5)||S.expelled.has(n);
    if(dis) b.classList.add('dis');
    else{
      if(editSelMy.has(n)) b.classList.add('sel');
      b.onclick=()=>{
        if(editSelMy.has(n)){ editSelMy.delete(n); b.classList.remove('sel'); }
        else{ editSelMy.add(n); b.classList.add('sel'); }
      };
    }
    gm.appendChild(b);
  });

  S.oppRoster.forEach(n=>{
    const b=document.createElement('button');
    b.className='player-card';
    b.innerHTML=`<div class="pname">&nbsp;</div><div class="pnum">${esc(n)}</div>`;
    const dis=(S.opp[n]?.fouls>=5)||!!S.opp[n]?.expelled;
    if(dis) b.classList.add('dis');
    else{
      if(editSelOpp.has(n)) b.classList.add('sel');
      b.onclick=()=>{
        if(editSelOpp.has(n)){ editSelOpp.delete(n); b.classList.remove('sel'); }
        else{ editSelOpp.add(n); b.classList.add('sel'); }
      };
    }
    go.appendChild(b);
  });

  // bench enable only for T and D
  const kind = $('ed_kind').value;
  const benchAllowed = (kind==='T'||kind==='D');
  $('ed_benchHome').style.opacity=benchAllowed?'1':'0.35';
  $('ed_benchAway').style.opacity=benchAllowed?'1':'0.35';
  if(!benchAllowed){ editBenchHome=false; editBenchAway=false; }
}

function toggleEditBench(which){
  const kind = $('ed_kind')?.value || 'T';
  if(!(kind==='T'||kind==='D')) return;
  if(which==='home') editBenchHome=!editBenchHome;
  if(which==='away') editBenchAway=!editBenchAway;
}

function saveEdit(){
  if(!editId) return;
  const idx=S.events.findIndex(e=>e.id===editId);
  if(idx<0) return;
  const ev=S.events[idx];

  try{
    if(ev.type==='sub'){
      const p=parseMSS($('ed_subTime').value);
      if(!p.ok) return alert('Tempo MSS non valido');
      const outs=[...document.querySelectorAll('#ed_outGrid .sel')].map(b=>b.dataset.num);
      const ins=[...document.querySelectorAll('#ed_inGrid .sel')].map(b=>b.dataset.num);
      if(!outs.length || outs.length!==ins.length) return alert('Seleziona stesso numero OUT/IN');
      ev.payload.remSec=p.rem;
      ev.payload.outs=outs;
      ev.payload.ins=ins;
    } else if(ev.type==='foul_made'){
      ev.payload.player=$('ed_player').value;
    } else if(ev.type==='shot'){
      ev.payload.player=$('ed_player').value;
      ev.payload.val=Number($('ed_val').value);
      ev.payload.made=$('ed_made').value==='true';
      ev.payload.x=Number($('ed_x').value);
      ev.payload.y=Number($('ed_y').value);
    } else if(ev.type==='ft'){
      ev.payload.player=$('ed_player').value;
      ev.payload.made=$('ed_made').value==='true';
    } else if(ev.type==='quick'){
      ev.payload.kind=$('ed_kind').value;
      ev.payload.player=$('ed_player').value;
    } else if(ev.type==='opp_point'){
      ev.payload.value=Number($('ed_val').value);
    } else if(ev.type==='timeout'){
      ev.payload.team=$('ed_team').value;
    } else if(ev.type==='foul_suf'){
      ev.payload.myPlayer=$('ed_my').value;
      ev.payload.oppPlayer=$('ed_opp').value;
      ev.payload.freeThrows=$('ed_ft').value==='true';
    } else if(ev.type==='special_foul'){
      const kind=$('ed_kind').value;
      const benchAllowed=(kind==='T'||kind==='D');
      const targets=[];
      if(benchAllowed && editBenchHome) targets.push({team:'bench_home'});
      if(benchAllowed && editBenchAway) targets.push({team:'bench_away'});
      for(const n of editSelMy) targets.push({team:'my', num:n, kind});
      for(const n of editSelOpp) targets.push({team:'opp', num:n, kind});
      ev.payload.kind=kind;
      ev.payload.targets=targets;
    }
  }catch(e){
    alert('Errore: '+e);
    return;
  }

  replay();
  autosave();
  renderEvents();
  closeModal('modalEdit');
  editId=null;
}

/* ===================== EXPORT EXCEL ===================== */
function exportExcel(){
  const mins=minsByPlayer();
  const summary=S.myRoster.map(pl=>{
    const n=pl.num, st=S.p[n];
    return {
      Numero:n, Nome:pl.name||'',
      Punti:st.pts, Falli:st.fouls,
      '2M':st.twoM,'2A':st.twoA,
      '3M':st.threeM,'3A':st.threeA,
      FTM:st.ftM, FTA:st.ftA,
      'Falli Fatti':st.foulMade,
      'Falli Subiti':st.foulSuf,
      Perse:st.to, Recuperate:st.stl,
      'Rimb Off':st.ro, 'Rimb Dif':st.rd,
      Espulso: S.expelled.has(n) ? 'SI' : 'NO',
      Speciali: (st.specials||[]).join(''),
      Minuti: fmt(mins[n]||0)
    };
  });
  const shots=(S.shots||[]).map(s=>({Giocatore:s.player,Valore:s.val,Esito:s.made?'SEGNATO':'SBAGLIATO',X:s.x,Y:s.y}));
  const opp=S.oppRoster.map(n=>({Numero:n,Falli:S.opp[n]?.fouls||0,Speciali:(S.opp[n]?.specials||[]).join(''),Espulso:S.opp[n]?.expelled?'SI':'NO'}));
  const evs=S.events.map(e=>({ID:e.id,Tipo:e.type,Payload:JSON.stringify(e.payload),TS:e.ts}));

  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summary), 'MiaSquadra');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(shots), 'Tiri');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(opp), 'Avversari');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(evs), 'Eventi');
    // ================= Nome file dinamico =================
  const pad2 = n => String(n).padStart(2,'0');
  const d = new Date();
  const dateStr = `${pad2(d.getDate())}${pad2(d.getMonth()+1)}${d.getFullYear()}`;

  // pulizia nome squadre per filename
  const slug = s => String(s || '')
    .trim()
    .toLowerCase()
    .replace(/\s+/g, '-')        // spazi -> -
    .replace(/[^a-z0-9-_]/g, ''); // rimuove caratteri non validi

  const home = slug(S.nameH || 'casa');
  const away = slug(S.nameA || 'trasferta');

  // aggiunge anche il "Nome Partita" (quello salvato in home) per evitare nomi doppi
  const game = slug(currentGameName() || 'partita');
  const fileName = `${home}-${away}-${dateStr}-${game}.xlsx`;

  XLSX.writeFile(wb, fileName);
}

/* ===================== PDF EXPORT ===================== */

function renderMiniHeat(shots){
  const cv=document.createElement('canvas');
  cv.width=310; cv.height=240;
  const ctx=cv.getContext('2d');
  ctx.fillStyle='#d2a679'; ctx.fillRect(0,0,cv.width,cv.height);
  // simple heat overlay
  const cell=22,cols=Math.ceil(cv.width/cell),rows=Math.ceil(cv.height/cell);
  const grid=[...Array(rows)].map(()=>Array(cols).fill(0));
  shots.forEach(s=>{
    const x=+s.x,y=+s.y; if(!isFinite(x)||!isFinite(y)) return;
    const c=Math.min(cols-1,Math.max(0,Math.floor(x/cell)));
    const r=Math.min(rows-1,Math.max(0,Math.floor(y/cell)));
    grid[r][c]++;
  });
  let mx=0; grid.forEach(r=>r.forEach(v=>mx=Math.max(mx,v)));
  if(mx>0){
    for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
      const v=grid[r][c]; if(!v) continue;
      const t=v/mx; const a=.12+.55*t;
      ctx.fillStyle=`rgba(255,152,0,${a})`;
      ctx.fillRect(c*cell,r*cell,cell,cell);
    }
  }
  // draw court lines (rough)
  drawCourtLines(ctx, cv.width, cv.height);
  return cv;
}
function renderMiniChart(shots){
  const cv=document.createElement('canvas');
  cv.width=310; cv.height=240;
  const ctx=cv.getContext('2d');
  ctx.fillStyle='#d2a679'; ctx.fillRect(0,0,cv.width,cv.height);
  drawCourtLines(ctx, cv.width, cv.height);

  shots.forEach(s=>{
    const x=+s.x,y=+s.y; if(!isFinite(x)||!isFinite(y)) return;
    if(s.made){
      ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2);
      ctx.fillStyle="rgba(40,167,69,.9)"; ctx.fill();
      ctx.lineWidth=2; ctx.strokeStyle="rgba(255,255,255,.9)"; ctx.stroke();
    } else {
      ctx.lineWidth=3; ctx.strokeStyle="rgba(220,53,69,.95)";
      ctx.beginPath();
      ctx.moveTo(x-6,y-6); ctx.lineTo(x+6,y+6);
      ctx.moveTo(x+6,y-6); ctx.lineTo(x-6,y+6);
      ctx.stroke();
    }
  });
  return cv;
}
function drawCourtLines(ctx,w,h){
  ctx.strokeStyle='#fff'; ctx.lineWidth=2;
  // arc
  ctx.beginPath();
  ctx.arc(w/2,30,130,0,Math.PI,true);
  ctx.stroke();
  // paint
  ctx.strokeRect(w/2-50,0,100,120);
}

/* ===================== SAVE/LOAD (autosave + export/import) ===================== */
function autosave(){
  try{
    const data=serializeState();
    localStorage.setItem(storageKey(), JSON.stringify(data));
    touchCurrentGameUpdatedAt();
    renderHomeGames(); // aggiorna lista se il popup √® aperto

    // LIVE link (partita singola)
    cloudPush(data);

    // ARCHIVIO (multi-device) con login
    if(isAuthed() && CURRENT_GAME_ID){
      cloudSaveGame(CURRENT_GAME_ID, data);
    }
  }catch(e){}
}

function serializeState(){
  return {
    version:7,
    status:S.status,nQ:S.nQ,
    cloudId:S.cloudId,
    quarterLenMin:S.quarterLenMin,otLenMin:S.otLenMin,
    noi:S.noi,nameH:S.nameH,nameA:S.nameA,
    myRoster:S.myRoster, oppRoster:S.oppRoster,
    events:S.events
  };
}
function loadAutosave(){
  try{
    const raw=localStorage.getItem(storageKey());
    if(!raw) return false;
    const d=JSON.parse(raw);
    if(!d || !Array.isArray(d.events)) return false;

    S.status='idle'; S.nQ=1;
    S.quarterLenMin=d.quarterLenMin||10;
    S.otLenMin=d.otLenMin||5;
    S.noi=d.noi||'Home';
    S.nameH=d.nameH||'CASA'; S.nameA=d.nameA||'TRASFERTA';
    S.cloudId=d.cloudId||'';
    S.myRoster=d.myRoster||S.myRoster;
    S.oppRoster=d.oppRoster||S.oppRoster;
    S.events=d.events||[];

    bootstrapRosterData();
    renderRoster();
    replay();
    return true;
  }catch(e){ return false; }
}

function exportGameJSON(){
  const blob=new Blob([JSON.stringify(serializeState(),null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`partita_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

$('importFile')?.addEventListener?.('change', async (e)=>{
  const f=e.target.files?.[0];
  if(!f) return;
  const txt=await f.text();
  try{
    const d=JSON.parse(txt);
    if(!d || !Array.isArray(d.events)) return alert('File non valido');
    localStorage.setItem(storageKey(), JSON.stringify(d));
    alert('Import ok. Ricarico...');
    location.reload();
  }catch(err){
    alert('Errore import: '+err);
  }
});

/* ===================== END GAME NAV ===================== */
function resetToSetup(){
  // keep roster, clear events and counters
  S.events=[];
  S.status='idle';
  S.nQ=1;
  S.inC=[];
  S.selP=null;
  bootstrapRosterData();
  renderRoster();
  replay();
  autosave();
  openModal('modalSetup');
}
function resetToSetupInitial(){
  localStorage.removeItem(storageKey());
  location.reload();
}


function goToGamesMenu(){
  // salva lo stato (per sicurezza)
  try{ autosave(); }catch(e){}
  closeModal('modalGameOver');
  renderHomeGames();
  openModal('modalStartup');
}

/* ===================== BOOT ===================== */
document.addEventListener('DOMContentLoaded',()=>{
  initDefaults();

  // setup inputs
  $('quarterLenSel').value=String(S.quarterLenMin);
  $('otLenSel').value=String(S.otLenMin);
  $('noiSel').value=S.noi;
  if($('teamHomeName')) $('teamHomeName').value=String(S.nameH||'CASA');
  if($('teamAwayName')) $('teamAwayName').value=String(S.nameA||'TRASFERTA');
  buildMyTeamRowsFromRoster(S.myRoster||[]);
  if($('oppTeamInput')) $('oppTeamInput').value=(S.oppRoster||[]).join('\n');
  var cloudInp = $('cloudIdInput');
  if(cloudInp){
    var desired = String(S.cloudId||'').trim();
    if(!desired){ desired = String(currentGameName()||'').trim(); }
    if(desired){ cloudInp.value = desired; }
  }

  setupCourt();
  renderRoster();
  setBtnState();
  updateUI();

  // Se l'utente cambia app/schermo e poi torna, il browser pu√≤ rilasciare il Wake Lock.
  // Lo riattiviamo automaticamente quando la pagina torna visibile e la partita √® in corso.
  document.addEventListener('visibilitychange', ()=>{
    try{
      if(document.visibilityState==='visible'){
        if(isGameRunning() && wakeLockWanted) enableWakeLock();
      }else{
        // alcuni browser rilasciano automaticamente; puliamo il riferimento
        wakeLock = null;
      }
    }catch(e){}
  });

  // Scout mode: ri-connessione cloud se gi√† impostata (per-partita)
  if(!IS_VIEWER){
    try{
      if(S.cloudId && !CLOUD_GAME_ID){ CLOUD_GAME_ID = String(S.cloudId); }
      if(CLOUD_GAME_ID){
        connectToCloud(CLOUD_GAME_ID);
      }
    }catch(e){}
  }

  // Viewer mode: connessione da URL (read-only)
  if(IS_VIEWER){
    // nasconde setup iniziale e blocca azioni di gioco
    try{ closeModal('modalSetup'); closeModal('modalStartup'); }catch(e){}
    if(CLOUD_GAME_ID){
      connectToCloud(CLOUD_GAME_ID);
      // disabilita azioni che modificano la partita
      document.querySelectorAll('#azioni button').forEach(b=>{
        const t=(b.textContent||'').toUpperCase();
        const allow = t.includes('STAT') || t.includes('CHECK') || t.includes('EVENTI');
        if(!allow){ b.disabled=true; b.style.opacity='0.35'; }

      });

      // ===== TABLET/PC LAYOUT SWITCH =====
function applyDeviceLayout(){
  // PC/tablet: diamo per buono ‚Äúlandscape‚Äù se lo schermo √® largo
  const wide = window.matchMedia("(min-width: 900px)").matches;
  const landscape = window.matchMedia("(orientation: landscape)").matches || wide;

  // attiva tablet layout su schermi grandi (PC/tablet)
  document.body.classList.toggle("tablet", wide && landscape && !IS_VIEWER);
}

window.addEventListener("resize", applyDeviceLayout);
window.addEventListener("orientationchange", applyDeviceLayout);
applyDeviceLayout();


      // disabilita selezione giocatori e schermata azioni
      document.querySelectorAll('#rosterGrid .player-card').forEach(b=>{
        b.disabled = true;
        b.style.opacity = '0.55';
      });
      const as=document.getElementById('actionScreen');
      if(as) as.classList.add('hidden');

    }else{
      setSyncLabel('VIEW: nessun gameId');
      openModal('modalSetup'); // fallback: permette setup offline se vuoi
    }
    // viewer pulito: mostra solo STAT LIVE
    document.body.classList.add('viewer');
    openStats();
    return;
  }

  // Scout: login + archivio cloud
  if(!initFirebase()){
    // se Firebase non disponibile, fallback locale
    loadCurrentGameFromStorage();
    if(CURRENT_GAME_ID){
      loadAutosave();
      replay();
      updateUI();
    }
    renderHomeGames();
    openModal('modalStartup');
    return;
  }

  // UI: aggiunge bottoni login/logout in home
  (function injectAuthButtons(){
    const top = document.querySelector('#modalStartup .topbar');
    if(!top) return;
    if(document.getElementById('authBtn')) return;
    const b=document.createElement('button');
    b.id='authBtn';
    b.className='closeTop';
    b.textContent='ACCEDI';
    b.onclick=()=> signIn();
    top.insertBefore(b, top.firstChild);

    const out=document.createElement('button');
    out.id='logoutBtn';
    out.className='closeTop';
    out.style.background='#3a1f1f';
    out.textContent='ESCI';
    out.onclick=()=> signOutUser();
    top.insertBefore(out, top.firstChild);
  })();

  FB_AUTH.onAuthStateChanged(async (user)=>{
    AUTH_USER = user || null;
    AUTH_UID = user ? user.uid : null;

    const a=document.getElementById('authBtn');
    const o=document.getElementById('logoutBtn');
    if(a) a.style.display = user ? 'none' : '';
    if(o) o.style.display = user ? '' : 'none';

    if(!user){
      CLOUD_GAMES_CACHE = null;
      // mostra home con messaggio
      renderHomeGames();
      openModal('modalStartup');
      const host = document.getElementById('gamesList');
      if(host){
        host.innerHTML = '<div class="muted2" style="font-size:12px;line-height:1.3">Per usare l‚Äôarchivio online su piu‚Äô dispositivi, fai <b>ACCEDI</b> (Google).<br/>Dopo l‚Äôaccesso vedrai tutte le partite salvate nel cloud.</div>';
      }
      return;
    }

    await refreshCloudIndex();

    // Se avevi una partita aperta in questo tab, prova a ricaricarla dal cloud
    loadCurrentGameFromStorage();
    if(CURRENT_GAME_ID){
      try{
        const st = await cloudLoadGame(CURRENT_GAME_ID);
        if(st) localStorage.setItem(storageKey(), JSON.stringify(st));
      }catch(e){}
      loadAutosave();
      replay();
      updateUI();
    }

    renderHomeGames();
    openModal('modalStartup');
  });

});

  
</script>
</body>
</html>
